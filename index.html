<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precificador Show de Delicias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 50;
        }
        .tab-button.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dashboard-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }
        .bar-chart-bar {
            transition: width 0.5s ease-out;
            border-radius: 0 4px 4px 0;
            min-width: 2px;
        }
        .promo-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .promo-type-card.selected {
            border-color: #f97316;
            background: #fff7ed;
        }
        .promo-type-card:hover {
            border-color: #f97316;
        }
        .ifood-plan-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .alert-danger {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-container" class="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
        <div class="max-w-md w-full text-center bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-indigo-600">Precificador Show de Delícias</h1>
            <p class="text-lg text-gray-600 mt-2 mb-8">Faça login para aceder à sua ferramenta.</p>
            <button onclick="loginComGoogle()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center shadow-md">
                <i class="fab fa-google mr-3"></i>
                Entrar com o Google
            </button>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        <header class="mb-4">
            <div id="user-info" class="hidden flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-4">
                <div class="flex items-center">
                    <img id="user-photo" src="" alt="Foto do Utilizador" class="w-10 h-10 rounded-full mr-3">
                    <span id="user-name" class="font-semibold text-gray-700"></span>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">
                    Sair
                </button>
            </div>
    
            <div class="text-center">
                <h1 class="text-4xl font-bold text-indigo-600">Precificador Show de Delícias</h1>
                <p class="text-lg text-gray-600 mt-2">Sua ferramenta completa para uma gestão de preços inteligente e lucrativa.</p>
            </div>
        </header>

        <div id="db-status" class="flex items-center justify-center mb-6 text-sm text-gray-600">
            <span id="db-status-dot" class="h-3 w-3 rounded-full bg-yellow-400 mr-2 animate-pulse"></span>
            <span id="db-status-text">A ligar à base de dados...</span>
        </div>

        <div class="flex flex-wrap justify-center border-b border-gray-200 mb-8">
            <button onclick="changeTab('simulador')" class="tab-button active py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-calculator mr-2"></i> Simulador de Preços
            </button>
            <button onclick="changeTab('produtos')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-utensils mr-2"></i> Produtos e Receitas
            </button>
            <button onclick="changeTab('insumos')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-carrot mr-2"></i> Insumos
            </button>
            <button onclick="changeTab('dashboard')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-chart-bar mr-2"></i> Dashboard
            </button>
            <button onclick="changeTab('analise')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-chart-line mr-2"></i> Análise Estratégica
            </button>
            <button onclick="changeTab('configuracoes')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-cogs mr-2"></i> Configurações
            </button>
        </div>

        <main>
            <div id="simulador-tab" class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Selecione o Produto e a Margem de Lucro</h2>
                    
                    <div class="mb-4">
                        <label for="filtro-simulador" class="block text-sm font-medium text-gray-700 mb-1">Buscar Produto</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filtro-simulador" onkeyup="filtrarSimuladorSelect()" placeholder="Digite para filtrar produtos..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="produto-select" class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
                            <select id="produto-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="margem-lucro-input" class="block text-sm font-medium text-gray-700 mb-1">Margem de Lucro Desejada (%)</label>
                            <input type="number" id="margem-lucro-input" value="35" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button onclick="calcularPrecos()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg">
                            <i class="fas fa-magic mr-2"></i> Calcular Preços
                        </button>
                    </div>
                </div>

                <div id="resultado-precificacao" class="hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Resultado da Precificação</h2>
                    <div id="resumo-produto" class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200"></div>
                    <div id="tabela-precos" class="overflow-x-auto"></div>
                    <div id="analise-ia-container" class="mt-6 hidden">
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">✨ Análise de Preço com IA</h3>
                        <div id="analise-ia-content" class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-600"></div>
                    </div>
                    <div id="simulador-promocao" class="mt-8 pt-6 border-t border-gray-200">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">3. Simulador de Promoções iFood</h2>

                        <!-- Tipo de Promoção -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Promoção</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="promo-type-card selected" onclick="selecionarTipoPromo('cupom_restaurante')" id="promo-cupom_restaurante">
                                    <h4 class="font-bold text-sm text-gray-800"><i class="fas fa-tag text-orange-500 mr-1"></i> Cupom do Restaurante</h4>
                                    <p class="text-xs text-gray-500 mt-1">Desconto 100% bancado por você. Comissão iFood sobre o preço original.</p>
                                </div>
                                <div class="promo-type-card" onclick="selecionarTipoPromo('cupom_compartilhado')" id="promo-cupom_compartilhado">
                                    <h4 class="font-bold text-sm text-gray-800"><i class="fas fa-handshake text-blue-500 mr-1"></i> Cupom Compartilhado</h4>
                                    <p class="text-xs text-gray-500 mt-1">Desconto dividido entre restaurante e iFood. iFood subsidia parte.</p>
                                </div>
                                <div class="promo-type-card" onclick="selecionarTipoPromo('cupom_ifood')" id="promo-cupom_ifood">
                                    <h4 class="font-bold text-sm text-gray-800"><i class="fas fa-gift text-green-500 mr-1"></i> Cupom 100% iFood</h4>
                                    <p class="text-xs text-gray-500 mt-1">Desconto 100% subsidiado pelo iFood. Você recebe o valor cheio.</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="desconto-cliente" class="block text-sm font-medium text-gray-700 mb-1">
                                    Desconto para o Cliente (R$)
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Valor total do desconto que o cliente vê no app</span></span>
                                </label>
                                <input type="number" id="desconto-cliente" value="5.00" min="0" step="0.50" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="subsidio-ifood" class="block text-sm font-medium text-gray-700 mb-1">
                                    Subsídio do iFood (R$)
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Quanto o iFood paga do desconto. No cupom do restaurante = R$0</span></span>
                                </label>
                                <input type="number" id="subsidio-ifood" value="0.00" min="0" step="0.50" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="promo-comissao-base" class="block text-sm font-medium text-gray-700 mb-1">
                                    Comissão cobrada sobre
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">iFood cobra comissão sobre o preço original do cardápio, não sobre o preço com desconto</span></span>
                                </label>
                                <select id="promo-comissao-base" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="original" selected>Preço Original (padrão iFood)</option>
                                    <option value="promocional">Preço Promocional</option>
                                </select>
                            </div>
                            <button onclick="simularPromocao()" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors h-10">
                                <i class="fas fa-play mr-1"></i> Simular
                            </button>
                        </div>

                        <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg text-xs text-orange-800">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            <strong>Atenção:</strong> Na maioria das promoções iFood, a comissão é cobrada sobre o <strong>preço original do cardápio</strong>.
                            Isso significa que se seu prato custa R$30 e o desconto é R$5, o iFood cobra 23% sobre R$30 (= R$6,90), não sobre R$25 (= R$5,75).
                            O custo da promoção para você = desconto que você banca + comissão sobre preço cheio.
                        </div>

                        <div id="resultado-promocao" class="mt-6 hidden"></div>
                    </div>
                    <div id="simulador-frete" class="mt-8 pt-6 border-t border-gray-200">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">4. Simulador de Frete Embutido</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label for="custo-real-entrega" class="block text-sm font-medium text-gray-700 mb-1">Custo Real da Entrega (R$)</label>
                                <input type="number" id="custo-real-entrega" value="10.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="valor-pago-cliente" class="block text-sm font-medium text-gray-700 mb-1">Valor Pago pelo Cliente (R$)</label>
                                <input type="number" id="valor-pago-cliente" value="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button onclick="simularFreteEmbutido()" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors h-10">Calcular Preço com Frete</button>
                        </div>
                        <div id="resultado-frete" class="mt-6 hidden"></div>
                    </div>
                </div>
            </div>

            <div id="produtos-tab" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Gestão de Produtos e Receitas</h2>
                        <button id="btn-novo-produto" onclick="abrirModalProduto()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" disabled>
                            <i class="fas fa-plus mr-2"></i> Novo Produto
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filtro-produtos" onkeyup="filtrarProdutos()" placeholder="Buscar por nome do produto..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div id="lista-produtos" class="overflow-x-auto"></div>
                </div>
            </div>

            <div id="insumos-tab" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Gestão de Insumos</h2>
                        <button id="btn-novo-insumo" onclick="abrirModalInsumo()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" disabled>
                            <i class="fas fa-plus mr-2"></i> Novo Insumo
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filtro-insumos" onkeyup="filtrarInsumos()" placeholder="Buscar por nome do insumo..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div id="lista-insumos" class="overflow-x-auto"></div>
                </div>
            </div>
            
            <!-- DASHBOARD TAB -->
            <div id="dashboard-tab" class="hidden space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="dashboard-card border-l-4 border-indigo-500">
                        <div class="stat-value text-indigo-600" id="dash-total-produtos">0</div>
                        <div class="stat-label">Produtos Cadastrados</div>
                    </div>
                    <div class="dashboard-card border-l-4 border-green-500">
                        <div class="stat-value text-green-600" id="dash-custo-medio">R$ 0,00</div>
                        <div class="stat-label">Custo Médio dos Produtos</div>
                    </div>
                    <div class="dashboard-card border-l-4 border-orange-500">
                        <div class="stat-value text-orange-600" id="dash-total-insumos">0</div>
                        <div class="stat-label">Insumos Cadastrados</div>
                    </div>
                    <div class="dashboard-card border-l-4 border-red-500">
                        <div class="stat-value text-red-600" id="dash-custo-op">0%</div>
                        <div class="stat-label">Custo Operacional</div>
                    </div>
                </div>

                <!-- iFood Plans Info -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-info-circle text-orange-500 mr-2"></i>Planos iFood - Referência de Taxas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 border-2 border-gray-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">Plano Básico</h3>
                                <span class="ifood-plan-badge bg-green-100 text-green-800">12%</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">Restaurante realiza a própria entrega</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-green-500 mr-1"></i> Comissão: 12%</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> Taxa pagamento online: 3,2%</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> Total: ~15,2%</li>
                                <li><i class="fas fa-money-bill text-gray-400 mr-1"></i> Mensalidade: R$130 (se >R$1.800/mês)</li>
                                <li><i class="fas fa-truck text-gray-400 mr-1"></i> Entrega por conta própria</li>
                            </ul>
                        </div>
                        <div class="p-4 border-2 border-orange-200 bg-orange-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">Plano Entrega</h3>
                                <span class="ifood-plan-badge bg-orange-100 text-orange-800">23%</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">iFood realiza a entrega</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-orange-500 mr-1"></i> Comissão: 23%</li>
                                <li><i class="fas fa-check text-orange-500 mr-1"></i> Taxa pagamento online: 3,2%</li>
                                <li><i class="fas fa-check text-orange-500 mr-1"></i> Total: ~26,2%</li>
                                <li><i class="fas fa-money-bill text-orange-400 mr-1"></i> Mensalidade: R$150</li>
                                <li><i class="fas fa-truck text-orange-500 mr-1"></i> Entrega pelo iFood</li>
                            </ul>
                        </div>
                        <div class="p-4 border-2 border-red-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">Plano Premium</h3>
                                <span class="ifood-plan-badge bg-red-100 text-red-800">27%</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">Maior visibilidade + entrega iFood</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-red-500 mr-1"></i> Comissão: 27%</li>
                                <li><i class="fas fa-check text-red-500 mr-1"></i> Taxa pagamento online: 3,2%</li>
                                <li><i class="fas fa-check text-red-500 mr-1"></i> Total: ~30,2%</li>
                                <li><i class="fas fa-money-bill text-red-400 mr-1"></i> Mensalidade: R$150+</li>
                                <li><i class="fas fa-star text-yellow-500 mr-1"></i> Destaque na plataforma</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <strong>Importante:</strong> O iFood cobra comissão sobre o <strong>preço original do cardápio</strong>, não sobre o preço com desconto. Isso significa que em promoções, a comissão permanece sobre o valor cheio.
                    </div>
                </div>

                <!-- Price Comparison Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-balance-scale mr-2 text-indigo-500"></i>Comparativo de Preços por Canal</h2>
                    <p class="text-sm text-gray-500 mb-4">Selecione uma margem de lucro para ver os preços sugeridos em cada canal.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Margem de Lucro (%)</label>
                            <input type="number" id="dash-margem" value="35" min="1" max="90" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar Produto</label>
                            <select id="dash-produto-select" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="todos">Todos os Produtos</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="gerarDashboard()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                    <div id="dash-chart-container" class="hidden">
                        <canvas id="dash-price-chart" height="300"></canvas>
                    </div>
                </div>

                <!-- Products Profitability Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-table mr-2 text-green-500"></i>Relatório de Rentabilidade</h2>
                    <div id="dash-tabela-rentabilidade" class="overflow-x-auto">
                        <p class="text-center text-gray-500 py-4">Clique em "Gerar Relatório" para visualizar.</p>
                    </div>
                </div>

                <!-- Cost Structure -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-chart-pie mr-2 text-purple-500"></i>Estrutura de Custos</h2>
                        <div style="max-height:300px; display:flex; justify-content:center;">
                            <canvas id="dash-cost-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Insights Rápidos</h2>
                        <div id="dash-insights" class="space-y-3">
                            <p class="text-center text-gray-500 py-4">Gere o relatório para ver insights.</p>
                        </div>
                    </div>
                </div>

                <!-- iFood Promotion Break-Even Calculator -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-calculator mr-2 text-orange-500"></i>Calculadora de Ponto de Equilíbrio - Promoções iFood</h2>
                    <p class="text-sm text-gray-500 mb-4">Descubra quantas vendas extras você precisa para compensar o desconto de uma promoção.</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
                            <select id="dash-be-produto" class="w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plano iFood</label>
                            <select id="dash-be-plano" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="0.12">Básico (12%)</option>
                                <option value="0.23" selected>Entrega (23%)</option>
                                <option value="0.27">Premium (27%)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Desconto (%)</label>
                            <input type="number" id="dash-be-desconto" value="20" min="1" max="80" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div class="flex items-end">
                            <button onclick="calcularBreakEven()" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                                <i class="fas fa-calculator mr-2"></i> Calcular
                            </button>
                        </div>
                    </div>
                    <div id="dash-be-resultado" class="hidden"></div>
                </div>
            </div>

            <div id="analise-tab" class="hidden space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Registo de Vendas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div>
                            <label for="periodo-vendas" class="block text-sm font-medium text-gray-700 mb-1">Período de Vendas</label>
                            <input type="text" id="periodo-vendas" placeholder="Selecione o período" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="canal-analise" class="block text-sm font-medium text-gray-700 mb-1">Canal de Venda Principal</label>
                            <select id="canal-analise" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                        </div>
                        <button onclick="analisarVendas()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors h-10">
                            <i class="fas fa-chart-pie mr-2"></i> Analisar Vendas
                        </button>
                    </div>
                    <div id="lista-registro-vendas" class="mt-6 max-h-96 overflow-y-auto"></div>
                </div>
                <div id="resultado-analise-cardapio" class="hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Engenharia de Cardápio</h2>
                    <div id="container-analise" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    </div>
                </div>
            </div>

            <div id="configuracoes-tab" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">
                        Custos Operacionais
                        <span class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Insira aqui seus custos fixos e variáveis mensais e seu faturamento médio para calcular o percentual de custo operacional.</span>
                        </span>
                    </h2>
                    <div class="mb-4">
                        <label for="faturamento-mensal" class="block text-sm font-medium text-gray-700 mb-1">Faturamento Médio Mensal (R$)</label>
                        <input type="number" id="faturamento-mensal" placeholder="Ex: 40000" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div id="lista-custos-operacionais"></div>
                    <div class="mt-4 flex justify-between items-center">
                        <button onclick="adicionarCustoOperacional()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i> Adicionar Custo
                        </button>
                        <div class="text-right">
                            <p class="font-semibold">Total: <span id="total-custo-operacional" class="text-red-600">R$ 0,00</span></p>
                            <p class="font-semibold">Custo Operacional: <span id="percentual-custo-operacional" class="text-indigo-600">0.00%</span></p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">
                        Canais de Venda
                        <span class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Cadastre os canais de venda (ex: Balcão, iFood) e suas respectivas taxas.</span>
                        </span>
                    </h2>
                    <div id="lista-canais-venda"></div>
                    <button onclick="adicionarCanalVenda()" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i> Adicionar Canal
                    </button>
                </div>
                <div class="lg:col-span-2 text-center mt-4">
                    <button id="btn-salvar-config" onclick="salvarConfiguracoes()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg" disabled>
                        <i class="fas fa-save mr-2"></i> Salvar Todas as Configurações
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-backdrop" class="modal-backdrop hidden">
        <div id="modal-content" class="modal-content"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMP9yXGBnoBm6RVHas69fU3G51-a2l-vg",
            authDomain: "meu-precificador-show.firebaseapp.com",
            projectId: "meu-precificador-show",
            storageBucket: "meu-precificador-show.appspot.com",
            messagingSenderId: "767394530716",
            appId: "1:767394530716:web:412fe2b46d0081b6a07459"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'precificador-show-de-delicias';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.appState = {
            db,
            userId: null,
            isReady: false,
            apiKey: firebaseConfig.apiKey, 
            getCollectionRef,
            getConfigDocRef,
            insumosCache: () => insumosCache,
            produtosCache: () => produtosCache,
            configCache: () => configCache,
            doc, setDoc, getDoc, getDocs, collection, onSnapshot, addDoc, updateDoc, deleteDoc
        };

        let insumosCache = [];
        let produtosCache = [];
        let configCache = {};
        
        function getCollectionRef(collectionName) {
            if (!window.appState.userId) return null;
            return collection(db, `artifacts/${appId}/users/${window.appState.userId}/${collectionName}`);
        }
    
        function getConfigDocRef() {
            if (!window.appState.userId) return null;
            return doc(db, `artifacts/${appId}/users/${window.appState.userId}/configuracoes/main`);
        }
        
        function initializeAppState() {
            if (!window.appState.isReady || !window.appState.userId) return;
            
            const insumosRef = getCollectionRef('insumos');
            if (insumosRef) onSnapshot(insumosRef, snapshot => {
                insumosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarInsumos();
            });

            const produtosRef = getCollectionRef('produtos');
            if (produtosRef) onSnapshot(produtosRef, snapshot => {
                produtosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarProdutos();
                filtrarSimuladorSelect();
                if(typeof renderRegistroVendas === 'function') renderRegistroVendas();
            });

            const configRef = getConfigDocRef();
            if(configRef) onSnapshot(configRef, (doc) => {
                if (doc.exists()) {
                    configCache = doc.data();
                } else {
                    configCache = {
                        faturamentoMedioMensal: 40000,
                        custosOperacionais: [],
                        canaisVenda: []
                    };
                }
                renderConfiguracoes();
                updateCanalAnaliseSelect();
            });
        }
        
        const loginComGoogle = function() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Erro no login com Google:", error));
        }

        const logout = function() {
            signOut(auth).catch(error => console.error("Erro no logout:", error));
        }

        window.loginComGoogle = loginComGoogle;
        window.logout = logout;
        
        onAuthStateChanged(auth, user => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app');
            const userInfoContainer = document.getElementById('user-info');

            if (user) {
                if (window.appState.isReady && window.appState.userId === user.uid) return;
                window.appState.userId = user.uid;
                window.appState.isReady = true;

                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userInfoContainer.classList.remove('hidden');

                document.getElementById('user-name').textContent = user.displayName || 'Utilizador';
                document.getElementById('user-photo').src = user.photoURL || 'https://via.placeholder.com/150';

                const statusDot = document.getElementById('db-status-dot');
                const statusText = document.getElementById('db-status-text');
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Ligado e pronto a usar';

                document.getElementById('btn-novo-insumo').disabled = false;
                document.getElementById('btn-novo-produto').disabled = false;
                document.getElementById('btn-salvar-config').disabled = false;
                
                initializeAppState();
            } else {
                window.appState.isReady = false;
                window.appState.userId = null;
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                userInfoContainer.classList.add('hidden');
            }
        });
    </script>

    <script>
        // FUNÇÕES DE FILTRO
        function filtrarInsumos() {
            const filtro = document.getElementById('filtro-insumos').value.toLowerCase();
            const todosInsumos = window.appState.insumosCache();
            const insumosFiltrados = todosInsumos.filter(insumo => insumo.nome.toLowerCase().includes(filtro));
            renderInsumos(insumosFiltrados);
        }

        function filtrarProdutos() {
            const filtro = document.getElementById('filtro-produtos').value.toLowerCase();
            const todosProdutos = window.appState.produtosCache();
            const produtosFiltrados = todosProdutos.filter(produto => produto.nome.toLowerCase().includes(filtro));
            renderProdutos(produtosFiltrados);
        }

        function filtrarSimuladorSelect() {
            const filtro = document.getElementById('filtro-simulador').value.toLowerCase();
            updateProdutoSelect(filtro);
        }

        // --- LÓGICA DA API GEMINI ---
        async function callGeminiAPI(prompt) {
            const apiKey = window.appState.apiKey; 
            if (!apiKey || apiKey.includes("SUA_API")) {
                throw new Error("A chave de API (apiKey) do Firebase não foi configurada corretamente no código.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    console.error("Erro na API Gemini:", response.status, errorBody);
                    const errorMessage = errorBody.error?.message || `A API retornou um erro ${response.status}.`;
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason === 'SAFETY') {
                        throw new Error("A resposta foi bloqueada por motivos de segurança. Tente reformular o pedido.");
                    }
                    throw new Error("A IA retornou uma resposta vazia ou em formato inesperado.");
                }
            } catch (error) {
                console.error("Falha ao chamar a API Gemini:", error);
                throw error;
            }
        }

        // --- LÓGICA DA INTERFACE (UI) ---

        function changeTab(tabName) {
            document.getElementById('simulador-tab').classList.add('hidden');
            document.getElementById('produtos-tab').classList.add('hidden');
            document.getElementById('insumos-tab').classList.add('hidden');
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('analise-tab').classList.add('hidden');
            document.getElementById('configuracoes-tab').classList.add('hidden');
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'dashboard') {
                atualizarDashboardSelects();
                atualizarDashboardCards();
            }
        }

        // Tipo de promoção selecionado
        let tipoPromoSelecionado = 'cupom_restaurante';
        window.selecionarTipoPromo = function(tipo) {
            tipoPromoSelecionado = tipo;
            document.querySelectorAll('.promo-type-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('promo-' + tipo).classList.add('selected');
            const subsidioInput = document.getElementById('subsidio-ifood');
            const descontoInput = document.getElementById('desconto-cliente');
            if (tipo === 'cupom_restaurante') {
                subsidioInput.value = '0.00';
                subsidioInput.disabled = true;
            } else if (tipo === 'cupom_ifood') {
                subsidioInput.value = descontoInput.value;
                subsidioInput.disabled = true;
            } else {
                subsidioInput.disabled = false;
                subsidioInput.value = (parseFloat(descontoInput.value) / 2).toFixed(2);
            }
        }
        
        function updateProdutoSelect(filtro = '') {
            const todosProdutos = window.appState.produtosCache();
            const produtosFiltrados = todosProdutos.filter(produto => 
                produto.nome.toLowerCase().includes(filtro.toLowerCase())
            );
            const select = document.getElementById('produto-select');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Selecione um produto --</option>';
            produtosFiltrados.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = produto.nome;
                select.appendChild(option);
            });
            if (produtosFiltrados.some(p => p.id === currentVal)) {
                select.value = currentVal;
            }
        }

        function updateCanalAnaliseSelect() {
            const canais = window.appState.configCache().canaisVenda || [];
            const select = document.getElementById('canal-analise');
            select.innerHTML = '<option value="">-- Selecione um canal --</option>';
            canais.forEach(canal => {
                const option = document.createElement('option');
                option.value = canal.nome;
                option.textContent = canal.nome;
                select.appendChild(option);
            });
        }

        // --- RENDERIZAÇÃO ---
        
        function renderInsumos(lista = window.appState.insumosCache()) {
            const container = document.getElementById('lista-insumos');
            if (!lista.length) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum insumo encontrado.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Real (Pós-Desperdício)</th>
                        <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            lista.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(insumo => {
                const rendimento = 1 - (parseFloat(insumo.percentualDesperdicio) || 0);
                const custoReal = rendimento > 0 ? parseFloat(insumo.precoCompra) / rendimento : 0;
                const unidadeCompra = insumo.unidadeCompra || 'un';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${insumo.nome}</div>
                        <div class="text-sm text-gray-500">Comprado a R$ ${parseFloat(insumo.precoCompra).toFixed(2)} / ${insumo.qtdCompra} ${unidadeCompra}</div>
                    </td>
                    <td class="py-4 px-6 whitespace-nowrap">
                        <div class="font-medium text-green-600">R$ ${custoReal.toFixed(2)} / ${insumo.qtdCompra} ${unidadeCompra}</div>
                        <div class="text-sm text-gray-500">${(parseFloat(insumo.percentualDesperdicio) * 100).toFixed(0)}% de desperdício</div>
                    </td>
                    <td class="py-4 px-6 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="abrirModalInsumo('${insumo.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                        <button onclick="deletarItem('insumos', '${insumo.id}', 'insumo')" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderProdutos(lista = window.appState.produtosCache()) {
            const container = document.getElementById('lista-produtos');
            if (!lista.length) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum produto encontrado.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo de Insumos</th>
                        <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            lista.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(produto => {
                const custo = calcularCustoProduto(produto.id);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap font-medium text-gray-900">${produto.nome}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-gray-700">R$ ${custo.toFixed(2)}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="abrirModalProduto('${produto.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                        <button onclick="deletarItem('produtos', '${produto.id}', 'produto')" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderConfiguracoes() {
            const config = window.appState.configCache();
            if (!config) return;
            document.getElementById('faturamento-mensal').value = config.faturamentoMedioMensal || '';
            const custosContainer = document.getElementById('lista-custos-operacionais');
            custosContainer.innerHTML = '';
            (config.custosOperacionais || []).forEach((custo, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 mb-2';
                div.innerHTML = `
                    <input type="text" value="${custo.nome}" onchange="updateCustoTemp(${index}, 'nome', this.value)" class="w-2/3 p-2 border border-gray-300 rounded-md" placeholder="Nome do Custo">
                    <input type="number" value="${custo.valor}" onchange="updateCustoTemp(${index}, 'valor', this.value)" class="w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Valor">
                    <button onclick="removerCustoOperacional(${index})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                `;
                custosContainer.appendChild(div);
            });
            const canaisContainer = document.getElementById('lista-canais-venda');
            canaisContainer.innerHTML = '';
            (config.canaisVenda || []).forEach((canal, index) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-4 items-center gap-2 mb-2';
                div.innerHTML = `
                    <input type="text" value="${canal.nome}" onchange="updateCanalTemp(${index}, 'nome', this.value)" class="col-span-2 p-2 border border-gray-300 rounded-md" placeholder="Nome do Canal">
                    <input type="number" value="${(canal.taxaComissao * 100).toFixed(2)}" onchange="updateCanalTemp(${index}, 'taxaComissao', this.value / 100)" class="p-2 border border-gray-300 rounded-md" placeholder="Comissão %">
                    <input type="number" value="${(canal.taxaTransacao * 100).toFixed(2)}" onchange="updateCanalTemp(${index}, 'taxaTransacao', this.value / 100)" class="p-2 border border-gray-300 rounded-md" placeholder="Transação %">
                    <button onclick="removerCanalVenda(${index})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                `;
                canaisContainer.appendChild(div);
            });
            calcularTotaisConfig();
        }

        function calcularCustoInsumo(insumoId, quantidade, unidade) {
            const insumos = window.appState.insumosCache();
            const insumo = insumos.find(i => i.id === insumoId);
            if (!insumo) return 0;
            const precoCompra = parseFloat(insumo.precoCompra);
            const qtdCompra = parseFloat(insumo.qtdCompra);
            const unidadeCompra = insumo.unidadeCompra;
            const desperdicio = parseFloat(insumo.percentualDesperdicio);
            if (qtdCompra === 0) return 0;
            const rendimento = 1 - desperdicio;
            const custoRealTotal = rendimento > 0 ? precoCompra / rendimento : precoCompra;
            let custoPorUnidadeBase = custoRealTotal / qtdCompra;
            let quantidadeConvertida = quantidade;
            if (unidadeCompra === 'kg' && unidade === 'g') {
                quantidadeConvertida = quantidade / 1000;
            } else if (unidadeCompra === 'L' && unidade === 'ml') {
                quantidadeConvertida = quantidade / 1000;
            } else if (unidadeCompra === 'g' && unidade === 'kg') {
                quantidadeConvertida = quantidade * 1000;
            } else if (unidadeCompra === 'ml' && unidade === 'L') {
                quantidadeConvertida = quantidade * 1000;
            }
            return custoPorUnidadeBase * quantidadeConvertida;
        }

        function calcularCustoProduto(produtoId) {
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            if (!produto || !produto.receita) return 0;
            return produto.receita.reduce((total, item) => {
                return total + calcularCustoInsumo(item.insumoId, parseFloat(item.quantidade), item.unidade);
            }, 0);
        }

        function calcularTotaisConfig() {
            const config = window.appState.configCache();
            const totalCustos = (config.custosOperacionais || []).reduce((sum, custo) => sum + (parseFloat(custo.valor) || 0), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;
            const percentual = faturamento > 0 ? (totalCustos / faturamento) : 0;
            document.getElementById('total-custo-operacional').textContent = `R$ ${totalCustos.toFixed(2)}`;
            document.getElementById('percentual-custo-operacional').textContent = `${(percentual * 100).toFixed(2)}%`;
        }
        let ultimoCalculo = {};
        window.calcularPrecos = function() {
            const produtoId = document.getElementById('produto-select').value;
            const margemLucroRaw = parseFloat(document.getElementById('margem-lucro-input').value);
            if (!produtoId) {
                alert("Por favor, selecione um produto.");
                return;
            }
            if (isNaN(margemLucroRaw) || margemLucroRaw <= 0 || margemLucroRaw >= 100) {
                alert("A margem de lucro deve ser entre 1% e 99%.");
                return;
            }
            const margemLucro = margemLucroRaw / 100;
            const config = window.appState.configCache();
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            const custoProduto = calcularCustoProduto(produtoId);
            const totalCustosOp = (config.custosOperacionais || []).reduce((sum, c) => sum + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal);
            if (!faturamento || faturamento <= 0) {
                alert("Configure o Faturamento Médio Mensal nas Configurações antes de calcular preços.");
                return;
            }
            const custoOpPercentual = totalCustosOp / faturamento;
            const denominadorBase = 1 - custoOpPercentual - margemLucro;
            if (denominadorBase <= 0) {
                alert(`Erro: A soma do Custo Operacional (${(custoOpPercentual * 100).toFixed(2)}%) e da Margem de Lucro (${(margemLucro * 100).toFixed(2)}%) não pode ser maior ou igual a 100%.`);
                return;
            }
            const precoVendaBase = custoProduto / denominadorBase;
            const lucroPorPrato = precoVendaBase * margemLucro;
            const resumoContainer = document.getElementById('resumo-produto');
            resumoContainer.innerHTML = `
                <h3 class="text-xl font-bold mb-2 text-indigo-800">${produto.nome}</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div><p class="text-sm text-gray-500">Custo dos Insumos</p><p class="font-bold text-lg text-gray-800">R$ ${custoProduto.toFixed(2)}</p></div>
                    <div><p class="text-sm text-gray-500">Custo Operacional</p><p class="font-bold text-lg text-gray-800">${(custoOpPercentual * 100).toFixed(2)}%</p></div>
                    <div><p class="text-sm text-gray-500">Margem de Lucro</p><p class="font-bold text-lg text-gray-800">${(margemLucro * 100).toFixed(2)}%</p></div>
                    <div><p class="text-sm text-gray-500">Preço Base (Líquido)</p><p class="font-bold text-lg text-green-600">R$ ${precoVendaBase.toFixed(2)}</p></div>
                </div>
            `;
            const tabelaContainer = document.getElementById('tabela-precos');
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Canal de Venda</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxas Totais</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço de Venda Final</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lucro (R$)</th>
                        <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Análise IA</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            ultimoCalculo = {
                produtoId: produto.id,
                produtoNome: produto.nome,
                canais: {}
            };
            (config.canaisVenda || []).forEach(canal => {
                const taxasTotais = parseFloat(canal.taxaComissao) + parseFloat(canal.taxaTransacao);
                const denominadorCanal = 1 - taxasTotais;
                const precoFinal = denominadorCanal > 0 ? precoVendaBase / denominadorCanal : Infinity;
                ultimoCalculo.canais[canal.nome] = {
                    precoFinal: precoFinal,
                    taxasPercentual: taxasTotais,
                    liquidoOriginal: precoFinal * (1 - taxasTotais)
                };
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap font-medium text-gray-900">${canal.nome}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-gray-500">${(taxasTotais * 100).toFixed(2)}%</td>
                    <td class="py-4 px-6 whitespace-nowrap font-bold text-xl text-indigo-600">R$ ${precoFinal.toFixed(2)}</td>
                    <td class="py-4 px-6 whitespace-nowrap font-bold text-green-600">R$ ${lucroPorPrato.toFixed(2)}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-center">
                        <button onclick="analisarPrecoComIA('${produto.id}', '${canal.nome}', ${precoFinal}, this)" class="bg-purple-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-purple-600 transition-colors">
                            ✨ Analisar Preço
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            tabelaContainer.innerHTML = '';
            tabelaContainer.appendChild(table);
            document.getElementById('resultado-precificacao').classList.remove('hidden');
            document.getElementById('analise-ia-container').classList.add('hidden');
            document.getElementById('resultado-promocao').classList.add('hidden');
            document.getElementById('resultado-frete').classList.add('hidden');
        }
        window.gerarDescricaoProduto = async function(button) {
            const form = document.getElementById('form-produto');
            const nomeProduto = form.nome.value;
            const errorContainer = document.getElementById('descricao-ia-error');
            errorContainer.textContent = '';
            if (!nomeProduto) {
                alert("Por favor, insira um nome para o produto primeiro.");
                return;
            }
            const insumos = window.appState.insumosCache();
            const nomesIngredientes = window.tempReceita
                .map(item => insumos.find(i => i.id === item.insumoId)?.nome)
                .filter(Boolean)
                .join(', ');
            if (!nomesIngredientes) {
                alert("Adicione ingredientes à receita para gerar uma descrição.");
                return;
            }
            const prompt = `Crie uma descrição de marketing curta, apetitosa e vendedora para um prato chamado "${nomeProduto}". Os ingredientes principais são: ${nomesIngredientes}. A descrição deve ser ideal para um cardápio de delivery como o iFood.`;
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span> Gerando...`;
            try {
                const descricao = await callGeminiAPI(prompt);
                form.descricao.value = descricao.replace(/"/g, '');
            } catch (error) {
                errorContainer.textContent = `Erro: ${error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = `✨ Gerar Descrição com IA`;
            }
        }
        window.analisarPrecoComIA = async function(produtoId, nomeCanal, precoFinal, button) {
            const produtos = window.appState.produtosCache();
            const insumos = window.appState.insumosCache();
            const produto = produtos.find(p => p.id === produtoId);
            const custoProduto = calcularCustoProduto(produtoId);
            const nomesIngredientes = (produto.receita || [])
                .map(item => insumos.find(i => i.id === item.insumoId)?.nome)
                .filter(Boolean)
                .join(', ');
            const prompt = `Sou dono de um restaurante em Manaus, Amazonas, Brasil. Estou precificando um produto chamado "${produto.nome}". O custo dos ingredientes é R$ ${custoProduto.toFixed(2)} e o preço final de venda no canal "${nomeCanal}" será R$ ${precoFinal.toFixed(2)}. Os ingredientes são: ${nomesIngredientes}. Faça uma breve análise: este preço é competitivo para o mercado de delivery em Manaus? Sugira um preço ideal ou faixa de preço e justifique sua resposta considerando os ingredientes (se são regionais ou comuns), o tipo de prato e o público local. Seja conciso e direto.`;
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span>`;
            const analiseContainer = document.getElementById('analise-ia-container');
            const analiseContent = document.getElementById('analise-ia-content');
            analiseContent.innerHTML = `<div class="flex items-center justify-center p-4"><span class="spinner"></span>Analisando...</div>`;
            analiseContainer.classList.remove('hidden');
            try {
                const analise = await callGeminiAPI(prompt);
                analiseContent.innerText = analise;
            } catch (error) {
                analiseContent.innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
                button.innerHTML = `✨ Analisar Preço`;
            }
        }
        window.verificarPrecoComIA = async function(button) {
            const form = button.closest('form');
            const nomeInsumo = form.nome.value;
            const resultadoContainer = form.querySelector('#preco-ia-resultado');
            if (!nomeInsumo) {
                alert("Por favor, insira o nome do insumo para verificar o preço.");
                return;
            }
            resultadoContainer.innerHTML = `<div class="flex items-center"><span class="spinner"></span> Pesquisando...</div>`;
            resultadoContainer.classList.remove('hidden');
            button.disabled = true;
            const prompt = `Qual é o preço médio e promoções atuais para "${nomeInsumo}" em supermercados de Manaus, Amazonas, Brasil? Forneça uma faixa de preço por kg, litro ou unidade, conforme aplicável. Se possível, cite nomes de 1 a 2 supermercados com exemplos de preços ou promoções. Seja conciso e direto.`;
            try {
                const resposta = await callGeminiAPI(prompt);
                resultadoContainer.innerText = resposta;
            } catch (error) {
                resultadoContainer.innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        window.sugerirIngredientesComIA = async function(button) {
            const form = button.closest('form');
            const nomeProduto = form.nome.value;
            const errorContainer = form.querySelector('#sugestao-ia-error');
            errorContainer.textContent = '';
            if (!nomeProduto) {
                alert("Por favor, insira o nome do produto para obter sugestões.");
                return;
            }
            const insumosDisponiveis = window.appState.insumosCache();
            if (insumosDisponiveis.length === 0) {
                alert("Cadastre alguns insumos primeiro para que a IA possa fazer sugestões.");
                return;
            }
            const listaDeNomesDeInsumos = insumosDisponiveis.map(i => i.nome).join(', ');
            const prompt = `Você é um assistente de chef. O nome de um prato é '${nomeProduto}'. A seguir está uma lista de todos os insumos disponíveis no meu restaurante: ${listaDeNomesDeInsumos}. Com base no nome do prato, selecione os ingredientes mais comuns para essa receita A PARTIR DA LISTA FORNECIDA. Retorne apenas os nomes dos ingredientes selecionados, separados por vírgula. Não adicione nenhuma outra palavra ou explicação. Exemplo de resposta: Carne, Cebola, Alho, Creme de Leite`;
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span> Sugerindo...`;
            try {
                const resposta = await callGeminiAPI(prompt);
                const nomesSugeridos = resposta.split(',').map(nome => nome.trim().toLowerCase());
                window.tempReceita = []; 
                nomesSugeridos.forEach(nomeSugerido => {
                    const insumoEncontrado = insumosDisponiveis.find(i => i.nome.toLowerCase() === nomeSugerido);
                    if (insumoEncontrado) {
                        window.tempReceita.push({
                            insumoId: insumoEncontrado.id,
                            quantidade: 0,
                            unidade: 'g'
                        });
                    }
                });
                renderReceitaItems();
            } catch (error) {
                errorContainer.textContent = `Erro: ${error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = `✨ Sugerir Ingredientes`;
            }
        }
        window.obterConsultoriaPromocaoIA = async function(button, dadosPromocao) {
            const { nomeProduto, precoOriginal, desconto, subsidio, precoPromocional, novoLiquido, impactoLucro } = dadosPromocao;
            const prompt = `Sou dono de um restaurante em Manaus e estou pensando em participar de uma promoção no iFood para o prato '${nomeProduto}'. O preço normal de venda é R$${precoOriginal.toFixed(2)}. A promoção oferece R$${desconto.toFixed(2)} de desconto ao cliente. O iFood vai subsidiar R$${subsidio.toFixed(2)}. Com isso, o preço promocional será R$${precoPromocional.toFixed(2)} e meu recebimento líquido por venda será R$${novoLiquido.toFixed(2)}, o que representa uma redução de R$${Math.abs(impactoLucro).toFixed(2)} no meu lucro por unidade. Com base nestes números, e considerando o mercado de delivery em Manaus, você acha que vale a pena participar desta campanha? Quais são os prós e contras? Que estratégia devo adotar (ex: focar em volume, tentar fidelizar clientes)? Seja um consultor de negócios e dê uma recomendação clara.`;
            const resultadoContainer = document.getElementById('resultado-promocao');
            resultadoContainer.innerHTML += `<div id="consultoria-ia-promocao" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200"><div class="flex items-center"><span class="spinner"></span>Analisando estratégia...</div></div>`;
            button.disabled = true;
            try {
                const consultoria = await callGeminiAPI(prompt);
                document.getElementById('consultoria-ia-promocao').innerHTML = `<h4 class="font-semibold text-gray-800 mb-2">Consultoria da IA:</h4><p class="text-sm">${consultoria}</p>`;
            } catch (error) {
                document.getElementById('consultoria-ia-promocao').innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro ao obter a consultoria:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        window.obterConsultoriaFreteIA = async function(button, dadosFrete) {
            const { nomeProduto, precoOriginal, novoPreco, custoFreteAbsorvido } = dadosFrete;
            const prompt = `Sou dono de um restaurante em Manaus e estou pensando em oferecer frete com desconto, embutindo o custo no preço do produto '${nomeProduto}'. O preço original de venda é R$${precoOriginal.toFixed(2)}. Para absorver um custo de frete de R$${custoFreteAbsorvido.toFixed(2)}, o novo preço do produto precisaria ser R$${novoPreco.toFixed(2)}. Com base nestes números, e considerando o mercado de delivery em Manaus, você acha que esta é uma boa estratégia? Quais são os prós e contras de aumentar o preço do produto para oferecer um frete mais barato? Que impacto psicológico isso tem no cliente? Seja um consultor de negócios e dê uma recomendação clara.`;
            const resultadoContainer = document.getElementById('resultado-frete');
            resultadoContainer.innerHTML += `<div id="consultoria-ia-frete" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200"><div class="flex items-center"><span class="spinner"></span>Analisando estratégia...</div></div>`;
            button.disabled = true;
            try {
                const consultoria = await callGeminiAPI(prompt);
                document.getElementById('consultoria-ia-frete').innerHTML = `<h4 class="font-semibold text-gray-800 mb-2">Consultoria da IA:</h4><p class="text-sm">${consultoria}</p>`;
            } catch (error) {
                document.getElementById('consultoria-ia-frete').innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro ao obter a consultoria:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        window.sugerirPerdaComIA = async function(button) {
            const form = button.closest('form');
            const nomeInsumo = form.nome.value;
            const resultadoContainer = form.querySelector('#perda-ia-resultado');
            const desperdicioInput = form.percentualDesperdicio;
            if (!nomeInsumo) {
                alert("Por favor, insira o nome do insumo para obter uma sugestão de perda.");
                return;
            }
            resultadoContainer.innerHTML = `<div class="flex items-center"><span class="spinner"></span> Pesquisando sugestão...</div>`;
            resultadoContainer.classList.remove('hidden');
            button.disabled = true;
            const prompt = `Como um consultor de food service, estime o percentual de desperdício médio para o insumo "${nomeInsumo}" durante o pré-preparo em uma cozinha profissional (ex: cascas, sementes, aparas, ossos). Forneça apenas o número do percentual, sem o símbolo '%' ou qualquer texto adicional. Por exemplo, se a estimativa for 15%, retorne apenas "15".`;
            try {
                const resposta = await callGeminiAPI(prompt);
                const percentualSugerido = parseFloat(resposta);
                if (!isNaN(percentualSugerido)) {
                    desperdicioInput.value = percentualSugerido.toFixed(0);
                    resultadoContainer.innerText = `Sugestão da IA: ${percentualSugerido.toFixed(0)}%. O valor foi inserido no campo acima.`;
                } else {
                    resultadoContainer.innerHTML = `<p class="text-orange-600 font-semibold">A IA retornou uma resposta inesperada:</p><p class="text-sm text-gray-700">${resposta}</p>`;
                }
            } catch (error) {
                resultadoContainer.innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        function fecharModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }
        window.tempReceita = [];
        function renderReceitaItems() {
            const container = document.getElementById('receita-container');
            if (!container) return;
            const insumos = window.appState.insumosCache();
            container.innerHTML = ''; 
            window.tempReceita.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'receita-item flex items-center gap-2 mb-2';
                const insumosOptions = insumos.sort((a,b) => a.nome.localeCompare(b.nome))
                                                .map(i => `<option value="${i.id}" ${i.id === item.insumoId ? 'selected' : ''}>${i.nome}</option>`)
                                                .join('');
                const unidades = ['g', 'kg', 'ml', 'L', 'un'];
                const unidadesOptions = unidades.map(u => `<option value="${u}" ${u === item.unidade ? 'selected' : ''}>${u}</option>`).join('');
                itemDiv.innerHTML = `
                    <select class="w-1/2 p-2 border border-gray-300 rounded-md" onchange="updateReceitaItem(${index}, 'insumoId', this.value)">
                        <option value="">Selecione um insumo</option>
                        ${insumosOptions}
                    </select>
                    <input type="number" step="0.001" value="${item.quantidade || ''}" onchange="updateReceitaItem(${index}, 'quantidade', this.value)" class="w-1/4 p-2 border border-gray-300 rounded-md" placeholder="Qtd.">
                    <select class="w-1/4 p-2 border border-gray-300 rounded-md" onchange="updateReceitaItem(${index}, 'unidade', this.value)">
                        ${unidadesOptions}
                    </select>
                    <button type="button" onclick="removerReceitaItem(${index})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(itemDiv);
            });
        }
        window.adicionarReceitaItem = function() {
            window.tempReceita.push({ insumoId: '', quantidade: 0, unidade: 'g' });
            renderReceitaItems(); 
        }
        window.removerReceitaItem = function(index) {
            window.tempReceita.splice(index, 1);
            renderReceitaItems(); 
        }
        window.updateReceitaItem = function(index, field, value) {
            window.tempReceita[index][field] = value;
        }
        window.abrirModalInsumo = function(id = null) {
            const insumos = window.appState.insumosCache();
            const insumo = id ? insumos.find(i => i.id === id) : {};
            const modalContent = document.getElementById('modal-content');
            const unidades = ['kg', 'g', 'L', 'ml', 'un'];
            const unidadesOptions = unidades.map(u => `<option value="${u}" ${u === (insumo.unidadeCompra || 'kg') ? 'selected' : ''}>${u}</option>`).join('');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${id ? 'Editar' : 'Novo'} Insumo</h2>
                <form id="form-insumo" onsubmit="salvarInsumo(event, '${id || ''}')" class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700">Nome do Insumo</label>
                            <button type="button" onclick="verificarPrecoComIA(this)" class="bg-teal-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-teal-600 transition-colors">
                                <i class="fas fa-search-dollar mr-1"></i> Verificar Preços com IA
                            </button>
                        </div>
                        <input type="text" name="nome" value="${insumo.nome || ''}" required class="block w-full p-2 border border-gray-300 rounded-md">
                        <div id="preco-ia-resultado" class="mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-md hidden"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Preço de Compra (R$)</label><input type="number" step="0.01" name="precoCompra" value="${insumo.precoCompra || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Qtd. Compra</label><input type="number" step="0.001" name="qtdCompra" value="${insumo.qtdCompra || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Unidade de Compra</label>
                            <select name="unidadeCompra" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                ${unidadesOptions}
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                           <label class="block text-sm font-medium text-gray-700">Percentual de Desperdício (%) <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Ex: Se de 1kg de carne, 300g são aparas, o desperdício é 30%. Insira 30.</span></span></label>
                           <button type="button" onclick="sugerirPerdaComIA(this)" class="bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-blue-600 transition-colors">✨ Sugerir Perda</button>
                        </div>
                        <input type="number" name="percentualDesperdicio" value="${(insumo.percentualDesperdicio || 0) * 100}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <div id="perda-ia-resultado" class="mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-md hidden"></div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4"><button type="button" onclick="fecharModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar</button></div>
                </form>
            `;
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }
        window.abrirModalProduto = function(id = null) {
            const produtos = window.appState.produtosCache();
            const produto = id ? produtos.find(p => p.id === id) : { receita: [], descricao: '' };
            window.tempReceita = JSON.parse(JSON.stringify(produto.receita || []));
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${id ? 'Editar' : 'Novo'} Produto</h2>
                <form id="form-produto" onsubmit="salvarProduto(event, '${id || ''}')" class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <button type="button" onclick="sugerirIngredientesComIA(this)" class="bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-blue-600 transition-colors">✨ Sugerir Ingredientes</button>
                        </div>
                        <input type="text" name="nome" value="${produto.nome || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <div id="sugestao-ia-error" class="text-xs text-red-600 mt-1"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Descrição para Cardápio</label>
                            <button type="button" onclick="gerarDescricaoProduto(this)" class="bg-purple-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-purple-600 transition-colors">✨ Gerar Descrição com IA</button>
                        </div>
                        <div id="descricao-ia-error" class="text-xs text-red-600 mt-1"></div>
                        <textarea name="descricao" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Suculento filé de pirarucu na brasa...">${produto.descricao || ''}</textarea>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Receita (Ficha Técnica)</h3>
                        <div id="receita-container"></div>
                        <button type="button" onclick="adicionarReceitaItem()" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Adicionar ingrediente</button>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" onclick="fecharModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar</button>
                    </div>
                </form>
            `;
            renderReceitaItems(); 
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }
        window.salvarInsumo = async function(event, id) {
            event.preventDefault();
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            const form = document.getElementById('form-insumo');
            const data = {
                nome: form.nome.value,
                precoCompra: parseFloat(form.precoCompra.value),
                qtdCompra: parseFloat(form.qtdCompra.value),
                unidadeCompra: form.unidadeCompra.value,
                percentualDesperdicio: parseFloat(form.percentualDesperdicio.value) / 100
            };
            try {
                const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
                const collectionRef = getCollectionRef('insumos');
                if (id) {
                    await updateDoc(doc(collectionRef, id), data);
                } else {
                    await addDoc(collectionRef, data);
                }
                fecharModal();
            } catch (e) {
                console.error("Erro ao salvar insumo: ", e);
                alert("Ocorreu um erro ao salvar o insumo. Verifique sua conexão e os dados inseridos.");
            }
        }
        window.salvarProduto = async function(event, id) {
            event.preventDefault();
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            const form = document.getElementById('form-produto');
            const data = {
                nome: form.nome.value,
                descricao: form.descricao.value,
                receita: window.tempReceita.map(item => ({
                    insumoId: item.insumoId,
                    quantidade: parseFloat(item.quantidade) || 0,
                    unidade: item.unidade
                })).filter(item => item.insumoId && item.quantidade > 0)
            };
            try {
                const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
                const collectionRef = getCollectionRef('produtos');
                if (id) {
                    await updateDoc(doc(collectionRef, id), data);
                } else {
                    await addDoc(collectionRef, data);
                }
                fecharModal();
            } catch (e) {
                console.error("Erro ao salvar produto: ", e);
                alert("Ocorreu um erro ao salvar o produto.");
            }
        }
        window.deletarItem = async function(collectionName, id, itemName) {
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            if (confirm(`Tem certeza que deseja excluir este ${itemName}?`)) {
                try {
                    const { getCollectionRef, deleteDoc, doc } = window.appState;
                    const collectionRef = getCollectionRef(collectionName);
                    await deleteDoc(doc(collectionRef, id));
                } catch (e) {
                    console.error(`Erro ao excluir ${itemName}: `, e);
                    alert(`Ocorreu um erro ao excluir o ${itemName}.`);
                }
            }
        }
        window.updateCustoTemp = function(index, field, value) {
            window.appState.configCache().custosOperacionais[index][field] = field === 'valor' ? parseFloat(value) : value;
            calcularTotaisConfig();
        }
        window.adicionarCustoOperacional = function() {
            if (!window.appState.configCache().custosOperacionais) window.appState.configCache().custosOperacionais = [];
            window.appState.configCache().custosOperacionais.push({ nome: '', valor: 0 });
            renderConfiguracoes();
        }
        window.removerCustoOperacional = function(index) {
            window.appState.configCache().custosOperacionais.splice(index, 1);
            renderConfiguracoes();
        }
        window.updateCanalTemp = function(index, field, value) {
            window.appState.configCache().canaisVenda[index][field] = field === 'nome' ? value : parseFloat(value);
        }
        window.adicionarCanalVenda = function() {
            if (!window.appState.configCache().canaisVenda) window.appState.configCache().canaisVenda = [];
            window.appState.configCache().canaisVenda.push({ nome: '', taxaComissao: 0, taxaTransacao: 0 });
            renderConfiguracoes();
        }
        window.removerCanalVenda = function(index) {
            window.appState.configCache().canaisVenda.splice(index, 1);
            renderConfiguracoes();
        }
        window.salvarConfiguracoes = async function() {
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            try {
                const { getConfigDocRef, setDoc } = window.appState;
                const docRef = getConfigDocRef();
                const config = window.appState.configCache();
                config.faturamentoMedioMensal = parseFloat(document.getElementById('faturamento-mensal').value) || 0;
                await setDoc(docRef, config);
                alert("Configurações salvas com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar configurações: ", e);
                alert("Ocorreu um erro ao salvar as configurações.");
            }
        }
        window.simularPromocao = function() {
            const desconto = parseFloat(document.getElementById('desconto-cliente').value) || 0;
            const subsidio = parseFloat(document.getElementById('subsidio-ifood').value) || 0;
            const comissaoBase = document.getElementById('promo-comissao-base').value;
            const resultadoContainer = document.getElementById('resultado-promocao');

            if (desconto < 0 || subsidio < 0) {
                alert("Os valores de desconto e subsídio não podem ser negativos.");
                return;
            }
            if (subsidio > desconto) {
                alert("O subsídio do iFood não pode ser maior que o desconto total.");
                return;
            }
            if (Object.keys(ultimoCalculo).length === 0) {
                alert("Primeiro, calcule o preço de um produto na seção acima.");
                return;
            }

            const custoBancadoRestaurante = desconto - subsidio;
            const custoProduto = calcularCustoProduto(ultimoCalculo.produtoId);

            let htmlResult = `<h4 class="font-semibold text-lg mb-3">Resultado da Simulação de Promoção para "${ultimoCalculo.produtoNome}"</h4>`;

            // Info box sobre tipo de promoção
            const tipoLabels = {
                'cupom_restaurante': 'Cupom do Restaurante (100% seu custo)',
                'cupom_compartilhado': 'Cupom Compartilhado (custo dividido)',
                'cupom_ifood': 'Cupom 100% iFood (custo zero para você)'
            };
            htmlResult += `<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                <strong>Tipo:</strong> ${tipoLabels[tipoPromoSelecionado]} |
                <strong>Desconto total:</strong> R$ ${desconto.toFixed(2)} |
                <strong>iFood paga:</strong> R$ ${subsidio.toFixed(2)} |
                <strong>Você paga:</strong> R$ ${custoBancadoRestaurante.toFixed(2)}
            </div>`;

            htmlResult += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            let temCanalIfood = false;

            for (const canalNome in ultimoCalculo.canais) {
                if (canalNome.toLowerCase().includes('ifood')) {
                    temCanalIfood = true;
                    const canal = ultimoCalculo.canais[canalNome];
                    const precoOriginal = canal.precoFinal;
                    const precoPromocional = precoOriginal - desconto;

                    if (precoPromocional <= 0) {
                        htmlResult += `<div class="alert-danger"><strong>${canalNome}:</strong> O desconto de R$ ${desconto.toFixed(2)} é maior que o preço do produto (R$ ${precoOriginal.toFixed(2)}). Promoção inviável.</div>`;
                        continue;
                    }

                    // CORREÇÃO CRÍTICA: iFood cobra comissão sobre o preço ORIGINAL do cardápio
                    const baseComissao = comissaoBase === 'original' ? precoOriginal : precoPromocional;
                    const taxasValor = baseComissao * canal.taxasPercentual;

                    // O que o cliente paga
                    const clientePaga = precoPromocional;
                    // O que o restaurante recebe = preço promocional - taxas + subsídio iFood
                    const recebidoRestaurante = clientePaga - taxasValor + subsidio;
                    // Líquido original (sem promoção)
                    const liquidoOriginal = canal.liquidoOriginal;
                    // Impacto no lucro
                    const impactoLucro = recebidoRestaurante - liquidoOriginal;

                    // Margem sobre o custo
                    const margemSobreCusto = recebidoRestaurante - custoProduto;
                    const margemPercentual = recebidoRestaurante > 0 ? (margemSobreCusto / recebidoRestaurante) * 100 : 0;

                    // Aumento de vendas necessário para compensar
                    const lucroOriginal = liquidoOriginal - custoProduto;
                    const lucroPromo = recebidoRestaurante - custoProduto;
                    const aumentoNecessario = lucroPromo > 0 ? ((lucroOriginal / lucroPromo) - 1) * 100 : Infinity;

                    const impactoClasse = impactoLucro < 0 ? 'text-red-600' : 'text-green-600';
                    const alertaClass = margemSobreCusto < 0 ? 'alert-danger' : margemPercentual < 10 ? 'alert-warning' : 'alert-success';
                    const alertaMsg = margemSobreCusto < 0
                        ? '<i class="fas fa-times-circle mr-1"></i> PREJUÍZO! Você está vendendo abaixo do custo!'
                        : margemPercentual < 10
                        ? '<i class="fas fa-exclamation-triangle mr-1"></i> Margem muito baixa. Avalie se o volume compensa.'
                        : '<i class="fas fa-check-circle mr-1"></i> Margem positiva. Promoção pode ser viável.';

                    const dadosPromocao = {
                        nomeProduto: ultimoCalculo.produtoNome,
                        precoOriginal: precoOriginal,
                        desconto: desconto,
                        subsidio: subsidio,
                        precoPromocional: precoPromocional,
                        novoLiquido: recebidoRestaurante,
                        impactoLucro: impactoLucro,
                        custoProduto: custoProduto,
                        margemPercentual: margemPercentual,
                        aumentoNecessario: aumentoNecessario
                    };

                    htmlResult += `
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h5 class="font-bold text-md text-indigo-700 mb-3">${canalNome}</h5>
                            <div class="space-y-1 text-sm">
                                <p class="border-b pb-1">Preço Original: <span class="font-semibold float-right">R$ ${precoOriginal.toFixed(2)}</span></p>
                                <p>Preço Promocional (cliente vê): <span class="font-semibold float-right">R$ ${precoPromocional.toFixed(2)}</span></p>
                                <p class="text-gray-500">Base da comissão (${(canal.taxasPercentual * 100).toFixed(1)}%): <span class="float-right">R$ ${baseComissao.toFixed(2)}</span></p>
                                <p class="text-red-500">Comissão iFood: <span class="font-semibold float-right">- R$ ${taxasValor.toFixed(2)}</span></p>
                                <p class="text-green-500">Subsídio iFood: <span class="font-semibold float-right">+ R$ ${subsidio.toFixed(2)}</span></p>
                                <p class="border-t pt-1 font-bold">Você recebe: <span class="float-right text-blue-600">R$ ${recebidoRestaurante.toFixed(2)}</span></p>
                                <p>Custo do produto: <span class="float-right">R$ ${custoProduto.toFixed(2)}</span></p>
                                <p class="font-bold ${impactoClasse}">Lucro por unidade: <span class="float-right">R$ ${margemSobreCusto.toFixed(2)} (${margemPercentual.toFixed(1)}%)</span></p>
                                <p class="${impactoClasse} border-t pt-1">Impacto vs. sem promoção: <span class="font-bold float-right">R$ ${impactoLucro.toFixed(2)}</span></p>
                                ${aumentoNecessario !== Infinity && aumentoNecessario > 0 ? `<p class="text-orange-600 text-xs mt-1"><i class="fas fa-arrow-up mr-1"></i>Precisa vender <strong>${aumentoNecessario.toFixed(0)}% mais</strong> para compensar o desconto</p>` : ''}
                            </div>
                            <div class="mt-3 ${alertaClass} text-xs">${alertaMsg}</div>
                            <button onclick='obterConsultoriaPromocaoIA(this, ${JSON.stringify(dadosPromocao)})' class="mt-3 w-full bg-gray-700 text-white text-xs font-bold py-2 px-2 rounded-md hover:bg-gray-800 transition-colors">
                                ✨ Obter Consultoria da IA
                            </button>
                        </div>
                    `;
                }
            }

            if (!temCanalIfood) {
                htmlResult += `<div class="col-span-2 alert-warning">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    Nenhum canal com "iFood" no nome foi encontrado. Cadastre um canal com "iFood" no nome nas Configurações.
                </div>`;
            }

            htmlResult += `</div><div id="consultoria-ia-promocao" class="mt-4"></div>`;
            resultadoContainer.innerHTML = htmlResult;
            resultadoContainer.classList.remove('hidden');
        }
        window.simularFreteEmbutido = function() {
            const custoReal = parseFloat(document.getElementById('custo-real-entrega').value);
            const valorPagoCliente = parseFloat(document.getElementById('valor-pago-cliente').value);
            const resultadoContainer = document.getElementById('resultado-frete');
            if (Object.keys(ultimoCalculo).length === 0) {
                alert("Primeiro, calcule o preço de um produto.");
                return;
            }
            const custoFreteAbsorvido = custoReal - valorPagoCliente;
            if (custoFreteAbsorvido < 0) {
                alert("O valor pago pelo cliente não pode ser maior que o custo real da entrega.");
                return;
            }
            let htmlResult = `<h4 class="font-semibold text-lg mb-3">Resultado do Frete Embutido para "${ultimoCalculo.produtoNome}"</h4>`;
            htmlResult += `<p class="text-sm mb-4">Custo do frete absorvido pelo restaurante: <span class="font-bold">R$ ${custoFreteAbsorvido.toFixed(2)}</span></p>`;
            htmlResult += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            for (const canalNome in ultimoCalculo.canais) {
                const canal = ultimoCalculo.canais[canalNome];
                const novoPrecoBase = canal.liquidoOriginal + custoFreteAbsorvido;
                const novoPrecoFinal = novoPrecoBase / (1 - canal.taxasPercentual);
                const dadosFrete = {
                    nomeProduto: ultimoCalculo.produtoNome,
                    precoOriginal: canal.precoFinal,
                    novoPreco: novoPrecoFinal,
                    custoFreteAbsorvido: custoFreteAbsorvido
                };
                htmlResult += `
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h5 class="font-bold text-md text-indigo-700 mb-2">${canalNome}</h5>
                        <div class="space-y-1 text-sm">
                            <p>Preço Original: <span class="font-semibold float-right">R$ ${canal.precoFinal.toFixed(2)}</span></p>
                            <p class="text-blue-600">Novo Preço (Frete Embutido): <span class="font-bold float-right">R$ ${novoPrecoFinal.toFixed(2)}</span></p>
                        </div>
                        <button onclick='obterConsultoriaFreteIA(this, ${JSON.stringify(dadosFrete)})' class="mt-4 w-full bg-gray-700 text-white text-xs font-bold py-2 px-2 rounded-md hover:bg-gray-800 transition-colors">
                            ✨ Obter Consultoria da IA
                        </button>
                    </div>
                `;
            }
            htmlResult += `</div><div id="consultoria-ia-frete" class="mt-4"></div>`;
            resultadoContainer.innerHTML = htmlResult;
            resultadoContainer.classList.remove('hidden');
        }
        // === DASHBOARD FUNCTIONS ===
        let dashPriceChart = null;
        let dashCostChart = null;

        function atualizarDashboardSelects() {
            const produtos = window.appState.produtosCache();
            const select1 = document.getElementById('dash-produto-select');
            const select2 = document.getElementById('dash-be-produto');
            if (!select1 || !select2) return;

            select1.innerHTML = '<option value="todos">Todos os Produtos</option>';
            select2.innerHTML = '<option value="">Selecione um produto</option>';
            produtos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(p => {
                const opt1 = document.createElement('option');
                opt1.value = p.id;
                opt1.textContent = p.nome;
                select1.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = p.id;
                opt2.textContent = p.nome;
                select2.appendChild(opt2);
            });
        }

        function atualizarDashboardCards() {
            const produtos = window.appState.produtosCache();
            const insumos = window.appState.insumosCache();
            const config = window.appState.configCache();

            document.getElementById('dash-total-produtos').textContent = produtos.length;
            document.getElementById('dash-total-insumos').textContent = insumos.length;

            if (produtos.length > 0) {
                const custoMedio = produtos.reduce((sum, p) => sum + calcularCustoProduto(p.id), 0) / produtos.length;
                document.getElementById('dash-custo-medio').textContent = `R$ ${custoMedio.toFixed(2)}`;
            }

            const totalCustos = (config.custosOperacionais || []).reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;
            const custoOp = faturamento > 0 ? ((totalCustos / faturamento) * 100).toFixed(1) : '0';
            document.getElementById('dash-custo-op').textContent = custoOp + '%';
        }

        window.gerarDashboard = function() {
            const produtos = window.appState.produtosCache();
            const config = window.appState.configCache();
            const canais = config.canaisVenda || [];
            const margemInput = parseFloat(document.getElementById('dash-margem').value) / 100;
            const produtoFiltro = document.getElementById('dash-produto-select').value;

            if (isNaN(margemInput) || margemInput <= 0 || margemInput >= 1) {
                alert("Margem de lucro deve ser entre 1% e 99%.");
                return;
            }
            if (canais.length === 0) {
                alert("Cadastre canais de venda nas Configurações primeiro.");
                return;
            }
            if (produtos.length === 0) {
                alert("Cadastre produtos primeiro.");
                return;
            }

            const totalCustosOp = (config.custosOperacionais || []).reduce((s, c) => s + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 1;
            const custoOpPerc = totalCustosOp / faturamento;
            const denominadorBase = 1 - custoOpPerc - margemInput;

            if (denominadorBase <= 0) {
                alert("Custo operacional + margem >= 100%. Ajuste nas configurações.");
                return;
            }

            const produtosParaAnalise = produtoFiltro === 'todos'
                ? produtos
                : produtos.filter(p => p.id === produtoFiltro);

            // Generate profitability table
            let tabelaHtml = `<table class="min-w-full bg-white text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">Custo</th>`;
            canais.forEach(c => {
                tabelaHtml += `<th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">${c.nome}</th>`;
            });
            tabelaHtml += `<th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">Lucro/Un</th>
                        <th class="py-2 px-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr></thead><tbody class="divide-y divide-gray-200">`;

            const chartLabels = [];
            const chartDatasets = [];
            const coresCanais = ['#6366f1', '#f97316', '#10b981', '#ef4444', '#8b5cf6', '#06b6d4'];

            canais.forEach((canal, idx) => {
                chartDatasets.push({
                    label: canal.nome,
                    data: [],
                    backgroundColor: coresCanais[idx % coresCanais.length],
                    borderRadius: 4
                });
            });

            let totalLucroEstimado = 0;
            let produtoMaisRentavel = { nome: '', margem: 0 };
            let produtoMenosRentavel = { nome: '', margem: 100 };

            produtosParaAnalise.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(produto => {
                const custo = calcularCustoProduto(produto.id);
                const precoBase = custo / denominadorBase;
                const lucroUnit = precoBase * margemInput;
                chartLabels.push(produto.nome.length > 20 ? produto.nome.substring(0, 20) + '...' : produto.nome);

                const margemReal = custo > 0 ? ((precoBase - custo) / precoBase * 100) : 0;
                if (margemReal > produtoMaisRentavel.margem) produtoMaisRentavel = { nome: produto.nome, margem: margemReal };
                if (margemReal < produtoMenosRentavel.margem && custo > 0) produtoMenosRentavel = { nome: produto.nome, margem: margemReal };

                tabelaHtml += `<tr>
                    <td class="py-2 px-3 font-medium text-gray-900">${produto.nome}</td>
                    <td class="py-2 px-3 text-right text-gray-600">R$ ${custo.toFixed(2)}</td>`;

                canais.forEach((canal, idx) => {
                    const taxas = parseFloat(canal.taxaComissao) + parseFloat(canal.taxaTransacao);
                    const denom = 1 - taxas;
                    const precoFinal = denom > 0 ? precoBase / denom : 0;
                    chartDatasets[idx].data.push(precoFinal.toFixed(2));
                    tabelaHtml += `<td class="py-2 px-3 text-right font-semibold text-indigo-600">R$ ${precoFinal.toFixed(2)}</td>`;
                });

                totalLucroEstimado += lucroUnit;
                const statusColor = custo === 0 ? 'text-gray-400' : lucroUnit > 0 ? 'text-green-600' : 'text-red-600';
                const statusIcon = custo === 0 ? 'fa-question' : lucroUnit > 0 ? 'fa-check-circle' : 'fa-times-circle';

                tabelaHtml += `<td class="py-2 px-3 text-right font-bold text-green-600">R$ ${lucroUnit.toFixed(2)}</td>
                    <td class="py-2 px-3 text-center ${statusColor}"><i class="fas ${statusIcon}"></i></td></tr>`;
            });

            tabelaHtml += `</tbody></table>`;
            document.getElementById('dash-tabela-rentabilidade').innerHTML = tabelaHtml;

            // Price comparison chart
            const chartContainer = document.getElementById('dash-chart-container');
            chartContainer.classList.remove('hidden');
            if (dashPriceChart) dashPriceChart.destroy();
            const ctx = document.getElementById('dash-price-chart').getContext('2d');
            dashPriceChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: chartLabels, datasets: chartDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': R$ ' + parseFloat(context.raw).toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return 'R$ ' + value; }
                            }
                        }
                    }
                }
            });

            // Cost structure chart
            const custosOp = config.custosOperacionais || [];
            if (custosOp.length > 0) {
                if (dashCostChart) dashCostChart.destroy();
                const costCtx = document.getElementById('dash-cost-chart').getContext('2d');
                const costLabels = custosOp.map(c => c.nome || 'Sem nome');
                const costValues = custosOp.map(c => parseFloat(c.valor) || 0);
                const costColors = ['#6366f1', '#f97316', '#10b981', '#ef4444', '#8b5cf6', '#06b6d4', '#f59e0b', '#ec4899', '#14b8a6', '#84cc16'];
                dashCostChart = new Chart(costCtx, {
                    type: 'doughnut',
                    data: {
                        labels: costLabels,
                        datasets: [{
                            data: costValues,
                            backgroundColor: costColors.slice(0, costLabels.length),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 11 } } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const perc = ((context.raw / total) * 100).toFixed(1);
                                        return context.label + ': R$ ' + context.raw.toFixed(2) + ' (' + perc + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Insights
            const insightsContainer = document.getElementById('dash-insights');
            let insightsHtml = '';

            insightsHtml += `<div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                <p class="text-sm font-semibold text-indigo-800"><i class="fas fa-trophy mr-1"></i> Mais Rentável</p>
                <p class="text-xs text-indigo-600">${produtoMaisRentavel.nome} (margem ${produtoMaisRentavel.margem.toFixed(1)}%)</p>
            </div>`;

            if (produtoMenosRentavel.nome) {
                insightsHtml += `<div class="p-3 bg-red-50 rounded-lg border border-red-200">
                    <p class="text-sm font-semibold text-red-800"><i class="fas fa-exclamation-triangle mr-1"></i> Menos Rentável</p>
                    <p class="text-xs text-red-600">${produtoMenosRentavel.nome} (margem ${produtoMenosRentavel.margem.toFixed(1)}%)</p>
                </div>`;
            }

            const custoOpPercDisplay = (custoOpPerc * 100).toFixed(1);
            const classeCustoOp = custoOpPerc > 0.35 ? 'bg-red-50 border-red-200 text-red-800' : custoOpPerc > 0.25 ? 'bg-yellow-50 border-yellow-200 text-yellow-800' : 'bg-green-50 border-green-200 text-green-800';
            insightsHtml += `<div class="p-3 ${classeCustoOp} rounded-lg border">
                <p class="text-sm font-semibold"><i class="fas fa-percentage mr-1"></i> Custo Operacional: ${custoOpPercDisplay}%</p>
                <p class="text-xs">${custoOpPerc > 0.35 ? 'Acima do ideal (>35%). Revise seus custos.' : custoOpPerc > 0.25 ? 'Atenção (25-35%). Busque otimizar.' : 'Saudável (<25%). Bom controle de custos.'}</p>
            </div>`;

            // iFood specific insight
            const canalIfood = canais.find(c => c.nome.toLowerCase().includes('ifood'));
            if (canalIfood) {
                const taxaIfood = ((parseFloat(canalIfood.taxaComissao) + parseFloat(canalIfood.taxaTransacao)) * 100).toFixed(1);
                insightsHtml += `<div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <p class="text-sm font-semibold text-orange-800"><i class="fas fa-motorcycle mr-1"></i> Taxas iFood: ${taxaIfood}%</p>
                    <p class="text-xs text-orange-600">Com margem de ${(margemInput * 100).toFixed(0)}%, seu preço no iFood é ~${((1 / (1 - parseFloat(canalIfood.taxaComissao) - parseFloat(canalIfood.taxaTransacao)) - 1) * 100).toFixed(0)}% maior que o preço base.</p>
                </div>`;
            }

            insightsHtml += `<div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm font-semibold text-gray-800"><i class="fas fa-coins mr-1"></i> Lucro Estimado por Venda Completa</p>
                <p class="text-xs text-gray-600">Se vender 1 de cada produto: R$ ${totalLucroEstimado.toFixed(2)} de lucro bruto</p>
            </div>`;

            insightsContainer.innerHTML = insightsHtml;
        }

        // Break-Even Calculator
        window.calcularBreakEven = function() {
            const produtoId = document.getElementById('dash-be-produto').value;
            const comissao = parseFloat(document.getElementById('dash-be-plano').value);
            const descontoPerc = parseFloat(document.getElementById('dash-be-desconto').value) / 100;
            const resultadoContainer = document.getElementById('dash-be-resultado');

            if (!produtoId) {
                alert("Selecione um produto.");
                return;
            }
            if (isNaN(descontoPerc) || descontoPerc <= 0 || descontoPerc >= 1) {
                alert("Desconto deve ser entre 1% e 99%.");
                return;
            }

            const config = window.appState.configCache();
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            const custoProduto = calcularCustoProduto(produtoId);
            const totalCustosOp = (config.custosOperacionais || []).reduce((s, c) => s + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 1;
            const custoOpPerc = totalCustosOp / faturamento;
            const margemInput = parseFloat(document.getElementById('dash-margem').value) / 100 || 0.35;
            const denominadorBase = 1 - custoOpPerc - margemInput;

            if (denominadorBase <= 0) {
                alert("Custo operacional + margem >= 100%.");
                return;
            }

            const taxaTransacao = 0.032; // taxa de pagamento online iFood (3,2%)
            const taxaTotal = comissao + taxaTransacao;
            const precoBase = custoProduto / denominadorBase;
            const precoFinal = precoBase / (1 - taxaTotal);
            const descontoValor = precoFinal * descontoPerc;
            const precoPromo = precoFinal - descontoValor;

            // Comissão sobre preço ORIGINAL (padrão iFood)
            const comissaoValor = precoFinal * taxaTotal;
            const liquidoOriginal = precoFinal - (precoFinal * taxaTotal);
            const liquidoPromo = precoPromo - comissaoValor; // comissão sobre preço original!
            const lucroOriginal = liquidoOriginal - custoProduto;
            const lucroPromo = liquidoPromo - custoProduto;

            const isPreju = lucroPromo < 0;
            const aumentoNecessario = lucroPromo > 0 ? ((lucroOriginal / lucroPromo) - 1) * 100 : Infinity;

            // Preço mínimo para não ter prejuízo
            const precoMinimo = (custoProduto + comissaoValor) / 1; // preço mínimo é custo + comissão
            const descontoMaximo = precoFinal - (custoProduto / (1 - taxaTotal));
            const descontoMaximoPerc = (descontoMaximo / precoFinal) * 100;

            let html = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-gray-800 mb-3"><i class="fas fa-receipt mr-1 text-indigo-500"></i> Análise sem Promoção</h4>
                    <div class="space-y-1 text-sm">
                        <p>Produto: <span class="font-semibold float-right">${produto.nome}</span></p>
                        <p>Custo insumos: <span class="float-right">R$ ${custoProduto.toFixed(2)}</span></p>
                        <p>Preço no iFood: <span class="font-semibold float-right">R$ ${precoFinal.toFixed(2)}</span></p>
                        <p>Comissão (${(taxaTotal * 100).toFixed(1)}%): <span class="text-red-500 float-right">- R$ ${comissaoValor.toFixed(2)}</span></p>
                        <p class="border-t pt-1 font-bold">Recebido: <span class="text-blue-600 float-right">R$ ${liquidoOriginal.toFixed(2)}</span></p>
                        <p class="font-bold text-green-600">Lucro: <span class="float-right">R$ ${lucroOriginal.toFixed(2)}</span></p>
                    </div>
                </div>
                <div class="p-4 border-2 rounded-lg ${isPreju ? 'bg-red-50 border-red-300' : 'bg-orange-50 border-orange-300'}">
                    <h4 class="font-bold text-gray-800 mb-3"><i class="fas fa-tag mr-1 text-orange-500"></i> Com ${(descontoPerc * 100).toFixed(0)}% de Desconto</h4>
                    <div class="space-y-1 text-sm">
                        <p>Preço promocional: <span class="font-semibold float-right">R$ ${precoPromo.toFixed(2)}</span></p>
                        <p>Desconto: <span class="text-orange-500 float-right">- R$ ${descontoValor.toFixed(2)}</span></p>
                        <p class="text-red-500">Comissão sobre R$ ${precoFinal.toFixed(2)}: <span class="float-right">- R$ ${comissaoValor.toFixed(2)}</span></p>
                        <p class="border-t pt-1 font-bold">Recebido: <span class="text-blue-600 float-right">R$ ${liquidoPromo.toFixed(2)}</span></p>
                        <p class="font-bold ${isPreju ? 'text-red-600' : 'text-green-600'}">
                            Lucro: <span class="float-right">R$ ${lucroPromo.toFixed(2)}</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="${isPreju ? 'alert-danger' : aumentoNecessario > 100 ? 'alert-warning' : 'alert-success'}">
                    <p class="font-bold text-sm">${isPreju ? '<i class="fas fa-times-circle mr-1"></i> PREJUÍZO!' : '<i class="fas fa-arrow-up mr-1"></i> Aumento de vendas necessário'}</p>
                    <p class="text-2xl font-bold mt-1">${isPreju ? 'Inviável' : aumentoNecessario.toFixed(0) + '%'}</p>
                    <p class="text-xs mt-1">${isPreju ? 'Você perde dinheiro a cada venda!' : 'Precisa vender ' + aumentoNecessario.toFixed(0) + '% mais para manter o mesmo lucro total'}</p>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="font-bold text-sm text-blue-800"><i class="fas fa-shield-alt mr-1"></i> Desconto máximo seguro</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${descontoMaximoPerc > 0 ? descontoMaximoPerc.toFixed(1) + '%' : '0%'}</p>
                    <p class="text-xs text-blue-600 mt-1">Máximo antes de ter prejuízo (R$ ${descontoMaximo > 0 ? descontoMaximo.toFixed(2) : '0.00'})</p>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <p class="font-bold text-sm text-purple-800"><i class="fas fa-info-circle mr-1"></i> Impacto por unidade</p>
                    <p class="text-2xl font-bold text-purple-600 mt-1">- R$ ${(lucroOriginal - lucroPromo).toFixed(2)}</p>
                    <p class="text-xs text-purple-600 mt-1">Redução de lucro por unidade vendida</p>
                </div>
            </div>`;

            resultadoContainer.innerHTML = html;
            resultadoContainer.classList.remove('hidden');
        }

        // Input validation for margem de lucro
        document.getElementById('margem-lucro-input').addEventListener('change', function() {
            const val = parseFloat(this.value);
            if (val < 0) this.value = 0;
            if (val > 99) this.value = 99;
        });

        // ESC to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') fecharModal();
        });
        // Click outside modal to close
        document.getElementById('modal-backdrop').addEventListener('click', function(e) {
            if (e.target === this) fecharModal();
        });
    </script>
</body>
</html>
