<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precificador Show de Delicias</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 50;
        }
        .tab-button.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-button.dashboard-btn {
            border-bottom: none !important;
        }
        .tab-button.dashboard-btn.active {
            background-color: #15803d !important;
            color: white !important;
            border-bottom: none !important;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dashboard-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }
        .bar-chart-bar {
            transition: width 0.5s ease-out;
            border-radius: 0 4px 4px 0;
            min-width: 2px;
        }
        .promo-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .promo-type-card.selected {
            border-color: #f97316;
            background: #fff7ed;
        }
        .promo-type-card:hover {
            border-color: #f97316;
        }
        .ifood-plan-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .alert-danger {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-container" class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-indigo-50 via-white to-green-50 p-4" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem;background:#f0f0ff;">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg" style="max-width:28rem;width:100%;background:#fff;padding:2rem;border-radius:0.75rem;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
            <div class="text-center mb-6" style="text-align:center;margin-bottom:1.5rem;">
                <h1 class="text-3xl font-bold text-indigo-600" style="font-size:1.8rem;font-weight:700;color:#4f46e5;">Precificador Show de Delicias</h1>
                <p class="text-gray-500 mt-2" style="color:#6b7280;margin-top:0.5rem;">Sua ferramenta completa de precificacao inteligente.</p>
            </div>

            <!-- Tabs Login / Cadastro -->
            <div class="flex mb-6 border-b border-gray-200">
                <button onclick="alternarLoginCadastro('login')" id="tab-login" class="flex-1 py-3 text-center font-semibold text-indigo-600 border-b-2 border-indigo-600 transition-colors">
                    Entrar
                </button>
                <button onclick="alternarLoginCadastro('cadastro')" id="tab-cadastro" class="flex-1 py-3 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">
                    Criar Conta
                </button>
            </div>

            <!-- Formulario de Login -->
            <div id="form-login-email" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-envelope text-gray-400"></i>
                        </div>
                        <input type="email" id="login-email" placeholder="seu@email.com" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="login-senha" placeholder="Sua senha" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onkeydown="if(event.key==='Enter') loginComEmail()">
                    </div>
                </div>
                <div id="login-erro" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-lg"></div>
                <button onclick="loginComEmail()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                    <i class="fas fa-sign-in-alt mr-2"></i> Entrar
                </button>
                <div class="text-center">
                    <button onclick="recuperarSenha()" class="text-sm text-indigo-500 hover:text-indigo-700 underline">Esqueceu a senha?</button>
                </div>
            </div>

            <!-- Formulario de Cadastro -->
            <div id="form-cadastro-email" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome completo</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <input type="text" id="cadastro-nome" placeholder="Seu nome" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Restaurante / Empresa</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-store text-gray-400"></i>
                        </div>
                        <input type="text" id="cadastro-empresa" placeholder="Ex: Pizzaria do Joao" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-envelope text-gray-400"></i>
                        </div>
                        <input type="email" id="cadastro-email" placeholder="seu@email.com" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha (minimo 6 caracteres)</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="cadastro-senha" placeholder="Crie uma senha" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="cadastro-senha-confirmar" placeholder="Repita a senha" class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" onkeydown="if(event.key==='Enter') cadastrarComEmail()">
                    </div>
                </div>
                <div id="cadastro-erro" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-lg"></div>
                <button onclick="cadastrarComEmail()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                    <i class="fas fa-user-plus mr-2"></i> Criar Conta
                </button>
            </div>

            <!-- Divisor -->
            <div class="flex items-center my-6">
                <hr class="flex-1 border-gray-300">
                <span class="px-4 text-sm text-gray-400">ou continue com</span>
                <hr class="flex-1 border-gray-300">
            </div>

            <!-- Login social -->
            <button onclick="loginComGoogle()" class="w-full bg-white border-2 border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-colors flex items-center justify-center shadow-sm">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Entrar com Google
            </button>

            <!-- Rodape -->
            <p class="text-center text-xs text-gray-400 mt-6">
                Ao criar uma conta, voce concorda com os termos de uso.<br>
                Seus dados ficam seguros no Firebase (Google).
            </p>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 hidden" style="display:none;">
        <header class="mb-4">
            <div id="user-info" class="hidden flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-4">
                <div class="flex items-center gap-3">
                    <!-- Botao Dashboard no canto esquerdo -->
                    <button onclick="changeTab('dashboard')" class="tab-button dashboard-btn py-2 px-4 text-white bg-green-600 hover:bg-green-700 rounded-lg font-semibold shadow-md focus:outline-none transition-colors text-sm">
                        <i class="fas fa-chart-bar mr-1"></i> Dashboard
                    </button>
                    <div class="h-8 w-px bg-gray-200"></div>
                    <img id="user-photo" src="" alt="Foto do Utilizador" class="w-10 h-10 rounded-full">
                    <div>
                        <span id="user-name" class="font-semibold text-gray-700 block"></span>
                        <span id="user-email" class="text-xs text-gray-400"></span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Botoes Backup -->
                    <button onclick="exportarDados()" class="bg-blue-500 text-white py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors text-sm" title="Exportar backup dos dados">
                        <i class="fas fa-download mr-1"></i> Backup
                    </button>
                    <label class="bg-amber-500 text-white py-2 px-3 rounded-lg hover:bg-amber-600 transition-colors text-sm cursor-pointer" title="Importar backup">
                        <i class="fas fa-upload mr-1"></i> Restaurar
                        <input type="file" accept=".json" onchange="importarDados(event)" class="hidden">
                    </label>
                    <div class="h-8 w-px bg-gray-200"></div>
                    <button onclick="logout()" class="bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 transition-colors text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Sair
                    </button>
                </div>
            </div>

            <div class="text-center">
                <h1 class="text-4xl font-bold text-indigo-600">Precificador Show de Delícias</h1>
                <p class="text-lg text-gray-600 mt-2">Sua ferramenta completa para uma gestão de preços inteligente e lucrativa.</p>
            </div>
        </header>

        <div id="db-status" class="flex items-center justify-center mb-6 text-sm text-gray-600">
            <span id="db-status-dot" class="h-3 w-3 rounded-full bg-yellow-400 mr-2 animate-pulse"></span>
            <span id="db-status-text">A ligar à base de dados...</span>
        </div>

        <div class="flex flex-wrap justify-center border-b border-gray-200 mb-8">
            <button onclick="changeTab('simulador')" class="tab-button active py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-calculator mr-2"></i> Simulador de Preços
            </button>
            <button onclick="changeTab('montador')" class="tab-button py-4 px-6 text-white bg-yellow-500 hover:bg-yellow-600 rounded-lg mx-1 font-semibold shadow-md focus:outline-none transition-colors">
                <i class="fas fa-drumstick-bite mr-2"></i> Montador de Marmita
            </button>
            <button onclick="changeTab('produtos')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-utensils mr-2"></i> Produtos e Receitas
            </button>
            <button onclick="changeTab('insumos')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-carrot mr-2"></i> Insumos
            </button>
            <button onclick="changeTab('embalagens')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-box mr-2"></i> Embalagens
            </button>
            <!-- Dashboard movido para o header -->
            <button onclick="changeTab('analise')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-chart-line mr-2"></i> Análise Estratégica
            </button>
            <button onclick="changeTab('relatorios')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-file-csv mr-2"></i> Relatórios iFood
            </button>
            <button onclick="changeTab('configuracoes')" class="tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none">
                <i class="fas fa-cogs mr-2"></i> Configurações
            </button>
            <button onclick="changeTab('cardapio')" class="tab-button py-4 px-6 text-white bg-orange-500 hover:bg-orange-600 rounded-lg mx-1 font-semibold shadow-md focus:outline-none transition-colors">
                <i class="fas fa-store mr-2"></i> Cardápio Digital
            </button>
            <button onclick="changeTab('pedidos')" class="tab-button py-4 px-6 text-white bg-green-500 hover:bg-green-600 rounded-lg mx-1 font-semibold shadow-md focus:outline-none transition-colors relative">
                <i class="fas fa-bell mr-2"></i> Pedidos
                <span id="pedidos-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center animate-pulse">0</span>
            </button>
        </div>

        <main>
            <div id="simulador-tab" class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Selecione o Produto e a Margem de Lucro</h2>
                    
                    <div class="mb-4">
                        <label for="filtro-simulador" class="block text-sm font-medium text-gray-700 mb-1">Buscar Produto</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filtro-simulador" onkeyup="filtrarSimuladorSelect()" placeholder="Digite para filtrar produtos..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="produto-select" class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
                            <select id="produto-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="margem-lucro-input" class="block text-sm font-medium text-gray-700 mb-1">Margem de Lucro Desejada (%)</label>
                            <input type="number" id="margem-lucro-input" value="35" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button onclick="calcularPrecos()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg">
                            <i class="fas fa-magic mr-2"></i> Calcular Preços
                        </button>
                    </div>
                </div>

                <div id="resultado-precificacao" class="hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Resultado da Precificação</h2>
                    <div id="resumo-produto" class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200"></div>
                    <div id="tabela-precos" class="overflow-x-auto"></div>
                    <div id="analise-ia-container" class="mt-6 hidden">
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">✨ Análise de Preço com IA</h3>
                        <div id="analise-ia-content" class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-600"></div>
                    </div>
                    <!-- Análise de Mercado com Search Grounding -->
                    <div id="analise-mercado-container" class="mt-6">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 rounded-t-lg">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                <div>
                                    <h3 class="text-xl font-bold text-white"><i class="fas fa-search-dollar mr-2"></i>Análise de Mercado Inteligente</h3>
                                    <p class="text-purple-200 text-sm mt-1">Pesquisa em tempo real com Google Search Grounding - preços de concorrentes, CMV e SEO para iFood</p>
                                </div>
                                <button id="btn-analise-mercado" onclick="analisarMercadoComIA(this)" class="bg-white text-purple-700 font-bold py-2 px-6 rounded-lg hover:bg-purple-50 transition-colors shadow-md text-sm whitespace-nowrap">
                                    <i class="fas fa-globe mr-2"></i> Analisar Mercado em Manaus
                                </button>
                            </div>
                        </div>
                        <div id="analise-mercado-content" class="hidden border border-t-0 border-purple-200 rounded-b-lg">
                            <div id="analise-mercado-resultado" class="p-6 bg-white"></div>
                            <div id="analise-mercado-fontes" class="hidden px-6 pb-4">
                                <details class="text-sm">
                                    <summary class="cursor-pointer text-purple-600 font-medium hover:text-purple-800"><i class="fas fa-link mr-1"></i>Fontes consultadas (Google Search)</summary>
                                    <div id="analise-mercado-fontes-lista" class="mt-2 space-y-1 text-gray-500 text-xs"></div>
                                </details>
                            </div>
                        </div>
                    </div>
                    <div id="simulador-promocao" class="mt-8 pt-6 border-t border-gray-200">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">3. Simulador de Promoções iFood</h2>

                        <!-- Tipo de Promoção -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Promoção</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="promo-type-card selected" onclick="selecionarTipoPromo('cupom_restaurante')" id="promo-cupom_restaurante">
                                    <h4 class="font-bold text-sm text-gray-800"><i class="fas fa-tag text-orange-500 mr-1"></i> Cupom do Restaurante</h4>
                                    <p class="text-xs text-gray-500 mt-1">Desconto 100% bancado por você. Comissão iFood sobre o preço original.</p>
                                </div>
                                <div class="promo-type-card" onclick="selecionarTipoPromo('cupom_compartilhado')" id="promo-cupom_compartilhado">
                                    <h4 class="font-bold text-sm text-gray-800"><i class="fas fa-handshake text-blue-500 mr-1"></i> Cupom Compartilhado</h4>
                                    <p class="text-xs text-gray-500 mt-1">Desconto dividido entre restaurante e iFood. iFood subsidia parte.</p>
                                </div>
                                <div class="promo-type-card" onclick="selecionarTipoPromo('cupom_ifood')" id="promo-cupom_ifood">
                                    <h4 class="font-bold text-sm text-gray-800"><i class="fas fa-gift text-green-500 mr-1"></i> Cupom 100% iFood</h4>
                                    <p class="text-xs text-gray-500 mt-1">Desconto 100% subsidiado pelo iFood. Você recebe o valor cheio.</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <!-- Campanha Inteligente Presets -->
                            <div class="md:col-span-4 mb-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-bolt text-yellow-500 mr-1"></i> Descontos Fixos - Campanha Inteligente
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Faixas oficiais do iFood. Pode ter até +R$5 extra do iFood por item. Clique para preencher automaticamente.</span></span>
                                </label>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-2" id="presets-campanha">
                                    <button onclick="aplicarPresetCampanha(5, 15, 24.99)" class="text-xs p-2 border-2 border-orange-200 rounded-lg hover:bg-orange-50 hover:border-orange-400 transition-colors text-left">
                                        <span class="font-bold text-orange-600 block">R$ 5 off</span>
                                        <span class="text-gray-500">Itens R$15-R$24,99</span>
                                    </button>
                                    <button onclick="aplicarPresetCampanha(8, 25, 39.99)" class="text-xs p-2 border-2 border-orange-200 rounded-lg hover:bg-orange-50 hover:border-orange-400 transition-colors text-left">
                                        <span class="font-bold text-orange-600 block">R$ 8 off</span>
                                        <span class="text-gray-500">Itens R$25-R$39,99</span>
                                    </button>
                                    <button onclick="aplicarPresetCampanha(10, 40, 60)" class="text-xs p-2 border-2 border-orange-200 rounded-lg hover:bg-orange-50 hover:border-orange-400 transition-colors text-left">
                                        <span class="font-bold text-orange-600 block">R$ 10 off</span>
                                        <span class="text-gray-500">Itens R$40-R$60</span>
                                    </button>
                                    <button onclick="aplicarPresetCampanha(13, 60, 80)" class="text-xs p-2 border-2 border-orange-200 rounded-lg hover:bg-orange-50 hover:border-orange-400 transition-colors text-left">
                                        <span class="font-bold text-orange-600 block">R$ 13 off</span>
                                        <span class="text-gray-500">Itens R$60-R$80 (pizzas)</span>
                                    </button>
                                    <button onclick="aplicarPresetFrete()" class="text-xs p-2 border-2 border-teal-200 rounded-lg hover:bg-teal-50 hover:border-teal-400 transition-colors text-left">
                                        <span class="font-bold text-teal-600 block"><i class="fas fa-motorcycle mr-1"></i>Frete grátis</span>
                                        <span class="text-gray-500">Até R$10 (ate 3km)</span>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1"><i class="fas fa-plus-circle text-green-400 mr-1"></i>iFood pode adicionar até +R$5 extra por item (subsídio iFood automático)</p>
                            </div>
                            <div>
                                <label for="desconto-cliente" class="block text-sm font-medium text-gray-700 mb-1">
                                    Desconto para o Cliente (R$)
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Valor total do desconto que o cliente vê no app</span></span>
                                </label>
                                <input type="number" id="desconto-cliente" value="5.00" min="0" step="0.50" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="subsidio-ifood" class="block text-sm font-medium text-gray-700 mb-1">
                                    Subsídio do iFood (R$)
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Quanto o iFood paga do desconto. No cupom do restaurante = R$0</span></span>
                                </label>
                                <input type="number" id="subsidio-ifood" value="0.00" min="0" step="0.50" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button onclick="simularPromocao()" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors h-10">
                                <i class="fas fa-play mr-1"></i> Simular
                            </button>
                        </div>

                        <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg text-xs text-orange-800">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            <strong>Como o iFood calcula:</strong>
                            A comissão (ex: 23%) é cobrada sobre <strong>(preço do cardápio - subsídio que você banca)</strong>.
                            A taxa de pagamento online (3,2%) é cobrada sobre o <strong>preço original</strong>.
                            <br><strong>Exemplo:</strong> Prato R$30, cupom R$12 (seu custo): Comissão = 23% de R$18 = R$4,14. Taxa pgto = 3,2% de R$30 = R$0,96.
                            Você recebe: R$18 - R$4,14 - R$0,96 = <strong>R$12,90</strong>.
                        </div>

                        <div id="resultado-promocao" class="mt-6 hidden"></div>
                    </div>
                    <div id="simulador-frete" class="mt-8 pt-6 border-t border-gray-200">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">4. Simulador de Frete Embutido</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label for="custo-real-entrega" class="block text-sm font-medium text-gray-700 mb-1">Custo Real da Entrega (R$)</label>
                                <input type="number" id="custo-real-entrega" value="10.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="valor-pago-cliente" class="block text-sm font-medium text-gray-700 mb-1">Valor Pago pelo Cliente (R$)</label>
                                <input type="number" id="valor-pago-cliente" value="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button onclick="simularFreteEmbutido()" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors h-10">Calcular Preço com Frete</button>
                        </div>
                        <div id="resultado-frete" class="mt-6 hidden"></div>
                    </div>
                </div>
            </div>

            <div id="produtos-tab" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Gestão de Produtos e Receitas</h2>
                        <button id="btn-novo-produto" onclick="abrirModalProduto()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" disabled>
                            <i class="fas fa-plus mr-2"></i> Novo Produto
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filtro-produtos" onkeyup="filtrarProdutos()" placeholder="Buscar por nome do produto..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div id="lista-produtos" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- MONTADOR DE MARMITA TAB -->
            <div id="montador-tab" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-700"><i class="fas fa-drumstick-bite text-yellow-500 mr-2"></i>Montador de Marmita</h2>
                            <p class="text-sm text-gray-500 mt-1">Monte a marmita selecionando os componentes e veja o preço de venda em tempo real.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Coluna esquerda: Seleção de componentes -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Proteínas -->
                        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-red-400">
                            <h3 class="text-lg font-semibold text-red-700 mb-3"><i class="fas fa-drumstick-bite mr-2"></i>Proteína</h3>
                            <div id="montador-proteinas" class="space-y-2"></div>
                            <button type="button" onclick="adicionarComponenteMontador('proteina')" class="mt-2 text-sm text-red-600 hover:text-red-800 font-medium">+ Adicionar proteína</button>
                        </div>

                        <!-- Carboidratos -->
                        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-yellow-400">
                            <h3 class="text-lg font-semibold text-yellow-700 mb-3"><i class="fas fa-bread-slice mr-2"></i>Carboidratos</h3>
                            <div id="montador-carboidratos" class="space-y-2"></div>
                            <button type="button" onclick="adicionarComponenteMontador('carboidrato')" class="mt-2 text-sm text-yellow-600 hover:text-yellow-800 font-medium">+ Adicionar carboidrato</button>
                        </div>

                        <!-- Salada -->
                        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-green-400">
                            <h3 class="text-lg font-semibold text-green-700 mb-3"><i class="fas fa-leaf mr-2"></i>Salada</h3>
                            <div id="montador-saladas" class="space-y-2"></div>
                            <button type="button" onclick="adicionarComponenteMontador('salada')" class="mt-2 text-sm text-green-600 hover:text-green-800 font-medium">+ Adicionar salada</button>
                        </div>

                        <!-- Embalagens -->
                        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-indigo-400">
                            <h3 class="text-lg font-semibold text-indigo-700 mb-3"><i class="fas fa-box mr-2"></i>Embalagens</h3>
                            <div id="montador-embalagens" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Coluna direita: Resultado -->
                    <div class="space-y-4">
                        <!-- Margem de Lucro -->
                        <div class="bg-white p-5 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3"><i class="fas fa-percentage mr-2"></i>Margem de Lucro</h3>
                            <input type="number" id="montador-margem" value="30" min="1" max="99" oninput="calcularMontador()" class="block w-full p-3 border border-gray-300 rounded-lg text-center text-xl font-bold text-indigo-600" placeholder="30">
                            <p class="text-xs text-gray-500 mt-1 text-center">Percentual de lucro desejado</p>
                        </div>

                        <!-- Resumo de Custos -->
                        <div class="bg-white p-5 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3"><i class="fas fa-receipt mr-2"></i>Resumo de Custos</h3>
                            <div id="montador-resumo" class="space-y-2">
                                <p class="text-center text-gray-400 text-sm">Selecione os componentes para ver o resumo</p>
                            </div>
                        </div>

                        <!-- Preços por Canal -->
                        <div class="bg-white p-5 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3"><i class="fas fa-store mr-2"></i>Preço de Venda por Canal</h3>
                            <div id="montador-canais" class="space-y-2">
                                <p class="text-center text-gray-400 text-sm">-</p>
                            </div>
                        </div>

                        <!-- Ações -->
                        <div class="flex flex-col gap-2">
                            <button onclick="salvarMontadorComoProduto()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                                <i class="fas fa-save mr-2"></i> Salvar como Produto
                            </button>
                            <button onclick="limparMontador()" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                                <i class="fas fa-broom mr-2"></i> Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="insumos-tab" class="hidden space-y-6">
                <!-- Guia de FC -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button onclick="document.getElementById('fc-guia-content').classList.toggle('hidden')" class="flex items-center justify-between w-full text-left">
                        <h2 class="text-lg font-semibold text-gray-700"><i class="fas fa-book text-blue-500 mr-2"></i>Guia: Fator de Correção (FC) - Referência Rápida</h2>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="fc-guia-content" class="hidden mt-4">
                        <p class="text-sm text-gray-600 mb-3">O <strong>Fator de Correção (FC)</strong> representa quanto a mais você precisa comprar para compensar perdas no pré-preparo. <strong>FC = Peso Bruto / Peso Líquido</strong>.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                            <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                                <h4 class="font-bold text-red-800 mb-2"><i class="fas fa-drumstick-bite mr-1"></i> Carnes e Aves</h4>
                                <table class="w-full">
                                    <tr><td class="py-0.5">Alcatra</td><td class="text-right font-semibold">1,12-1,20</td></tr>
                                    <tr><td class="py-0.5">Acém</td><td class="text-right font-semibold">1,11-1,28</td></tr>
                                    <tr><td class="py-0.5">Peito de frango</td><td class="text-right font-semibold">2,17</td></tr>
                                    <tr><td class="py-0.5">Frango inteiro</td><td class="text-right font-semibold">2,38</td></tr>
                                    <tr><td class="py-0.5">Camarão</td><td class="text-right font-semibold">4,10</td></tr>
                                </table>
                            </div>
                            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-carrot mr-1"></i> Legumes e Verduras</h4>
                                <table class="w-full">
                                    <tr><td class="py-0.5">Batata</td><td class="text-right font-semibold">1,06-1,33</td></tr>
                                    <tr><td class="py-0.5">Cebola</td><td class="text-right font-semibold">1,03-1,17</td></tr>
                                    <tr><td class="py-0.5">Cenoura</td><td class="text-right font-semibold">1,12-1,17</td></tr>
                                    <tr><td class="py-0.5">Alface</td><td class="text-right font-semibold">1,33</td></tr>
                                    <tr><td class="py-0.5">Brócolis</td><td class="text-right font-semibold">1,40-2,20</td></tr>
                                </table>
                            </div>
                            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h4 class="font-bold text-yellow-800 mb-2"><i class="fas fa-apple-alt mr-1"></i> Frutas</h4>
                                <table class="w-full">
                                    <tr><td class="py-0.5">Banana</td><td class="text-right font-semibold">1,51</td></tr>
                                    <tr><td class="py-0.5">Laranja</td><td class="text-right font-semibold">1,34-2,00</td></tr>
                                    <tr><td class="py-0.5">Maçã</td><td class="text-right font-semibold">1,13</td></tr>
                                    <tr><td class="py-0.5">Abacaxi</td><td class="text-right font-semibold">1,47-1,89</td></tr>
                                    <tr><td class="py-0.5">Manga</td><td class="text-right font-semibold">1,38-1,66</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                            <i class="fas fa-lightbulb mr-1"></i>
                            <strong>Dica:</strong> FC 1,25 = 20% de desperdício. Se a carne custa R$40/kg e o FC é 1,25, o custo real é R$50/kg. Sempre meça o FC do seu próprio estabelecimento, pois varia conforme fornecedor e manipulador.
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Gestão de Insumos</h2>
                        <button id="btn-novo-insumo" onclick="abrirModalInsumo()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" disabled>
                            <i class="fas fa-plus mr-2"></i> Novo Insumo
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="flex gap-3">
                            <div class="relative flex-1">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="filtro-insumos" onkeyup="filtrarInsumos()" placeholder="Buscar por nome do insumo..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                            </div>
                            <select id="filtro-categoria-insumos" onchange="filtrarInsumos()" class="p-2 border border-gray-300 rounded-md text-sm">
                                <option value="">Todas as categorias</option>
                                <option value="proteina">Proteína</option>
                                <option value="carboidrato">Carboidrato</option>
                                <option value="salada">Salada</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </div>

                    <div id="lista-insumos" class="overflow-x-auto"></div>
                </div>
            </div>
            
            <!-- EMBALAGENS TAB -->
            <div id="embalagens-tab" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-700"><i class="fas fa-box text-indigo-500 mr-2"></i>Gestão de Embalagens</h2>
                            <p class="text-sm text-gray-500 mt-1">Cadastre as embalagens usadas nos seus produtos. O custo será somado automaticamente ao custo de insumos.</p>
                        </div>
                        <button id="btn-nova-embalagem" onclick="abrirModalEmbalagem()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" disabled>
                            <i class="fas fa-plus mr-2"></i> Nova Embalagem
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filtro-embalagens" onkeyup="filtrarEmbalagens()" placeholder="Buscar por nome da embalagem..." class="block w-full pl-10 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div id="lista-embalagens" class="overflow-x-auto"></div>
                </div>

                <!-- Dicas sobre embalagens -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button onclick="document.getElementById('embalagens-dicas-content').classList.toggle('hidden')" class="flex items-center justify-between w-full text-left">
                        <h2 class="text-lg font-semibold text-gray-700"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Dicas: Embalagens e Custos</h2>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="embalagens-dicas-content" class="hidden mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-box-open mr-1"></i> Tipos Comuns</h4>
                                <ul class="space-y-1 text-blue-700">
                                    <li>Marmita de alumínio</li>
                                    <li>Embalagem de isopor</li>
                                    <li>Pote plástico com tampa</li>
                                    <li>Saco kraft / papel</li>
                                    <li>Copo descartável</li>
                                    <li>Sacola delivery</li>
                                </ul>
                            </div>
                            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-tags mr-1"></i> Não Esqueça</h4>
                                <ul class="space-y-1 text-green-700">
                                    <li>Tampa / filme PVC</li>
                                    <li>Talheres descartáveis</li>
                                    <li>Guardanapo</li>
                                    <li>Etiqueta / adesivo</li>
                                    <li>Fita adesiva</li>
                                    <li>Molheira / sachê</li>
                                </ul>
                            </div>
                            <div class="p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                <h4 class="font-bold text-orange-800 mb-2"><i class="fas fa-calculator mr-1"></i> Como Calcular</h4>
                                <p class="text-orange-700">Divida o preço do pacote pela quantidade de unidades para obter o <strong>valor unitário</strong>.</p>
                                <p class="text-orange-700 mt-2"><strong>Ex:</strong> Pacote com 100 marmitas por R$ 45,00 = R$ 0,45 por unidade.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="dashboard-tab" class="hidden space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="dashboard-card border-l-4 border-indigo-500">
                        <div class="stat-value text-indigo-600" id="dash-total-produtos">0</div>
                        <div class="stat-label">Produtos Cadastrados</div>
                    </div>
                    <div class="dashboard-card border-l-4 border-green-500">
                        <div class="stat-value text-green-600" id="dash-custo-medio">R$ 0,00</div>
                        <div class="stat-label">Custo Médio dos Produtos</div>
                    </div>
                    <div class="dashboard-card border-l-4 border-orange-500">
                        <div class="stat-value text-orange-600" id="dash-total-insumos">0</div>
                        <div class="stat-label">Insumos Cadastrados</div>
                    </div>
                    <div class="dashboard-card border-l-4 border-red-500">
                        <div class="stat-value text-red-600" id="dash-custo-op">0%</div>
                        <div class="stat-label">Custo Operacional</div>
                    </div>
                </div>

                <!-- iFood Plans Info -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-info-circle text-orange-500 mr-2"></i>Planos iFood - Referência de Taxas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 border-2 border-gray-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">Plano Básico</h3>
                                <span class="ifood-plan-badge bg-green-100 text-green-800">12%</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">Restaurante realiza a própria entrega</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-green-500 mr-1"></i> Comissão: 12%</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> Taxa pagamento online: 3,2%</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> Total: ~15,2%</li>
                                <li><i class="fas fa-money-bill text-gray-400 mr-1"></i> Mensalidade: R$130 (se >R$1.800/mês)</li>
                                <li><i class="fas fa-truck text-gray-400 mr-1"></i> Entrega por conta própria</li>
                            </ul>
                        </div>
                        <div class="p-4 border-2 border-orange-200 bg-orange-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">Plano Entrega</h3>
                                <span class="ifood-plan-badge bg-orange-100 text-orange-800">23%</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">iFood realiza a entrega</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-orange-500 mr-1"></i> Comissão: 23%</li>
                                <li><i class="fas fa-check text-orange-500 mr-1"></i> Taxa pagamento online: 3,2%</li>
                                <li><i class="fas fa-check text-orange-500 mr-1"></i> Total: ~26,2%</li>
                                <li><i class="fas fa-money-bill text-orange-400 mr-1"></i> Mensalidade: R$150</li>
                                <li><i class="fas fa-truck text-orange-500 mr-1"></i> Entrega pelo iFood</li>
                            </ul>
                        </div>
                        <div class="p-4 border-2 border-red-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">Plano Premium</h3>
                                <span class="ifood-plan-badge bg-red-100 text-red-800">27%</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">Maior visibilidade + entrega iFood</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-red-500 mr-1"></i> Comissão: 27%</li>
                                <li><i class="fas fa-check text-red-500 mr-1"></i> Taxa pagamento online: 3,2%</li>
                                <li><i class="fas fa-check text-red-500 mr-1"></i> Total: ~30,2%</li>
                                <li><i class="fas fa-money-bill text-red-400 mr-1"></i> Mensalidade: R$150+</li>
                                <li><i class="fas fa-star text-yellow-500 mr-1"></i> Destaque na plataforma</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <strong>Importante:</strong> Em promoções, o iFood cobra comissão sobre <strong>(preço - subsídio do restaurante)</strong>, não sobre o preço com desconto total. A taxa de pagamento online (3,2%) é cobrada sobre o preço original. Cadastre a comissão e taxa de pagamento separadamente nos Canais de Venda (Configurações).
                    </div>
                </div>

                <!-- Price Comparison Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-balance-scale mr-2 text-indigo-500"></i>Comparativo de Preços por Canal</h2>
                    <p class="text-sm text-gray-500 mb-4">Selecione uma margem de lucro para ver os preços sugeridos em cada canal.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Margem de Lucro (%)</label>
                            <input type="number" id="dash-margem" value="35" min="1" max="90" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar Produto</label>
                            <select id="dash-produto-select" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="todos">Todos os Produtos</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="gerarDashboard()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                    <div id="dash-chart-container" class="hidden">
                        <canvas id="dash-price-chart" height="300"></canvas>
                    </div>
                </div>

                <!-- Products Profitability Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-table mr-2 text-green-500"></i>Relatório de Rentabilidade</h2>
                    <div id="dash-tabela-rentabilidade" class="overflow-x-auto">
                        <p class="text-center text-gray-500 py-4">Clique em "Gerar Relatório" para visualizar.</p>
                    </div>
                </div>

                <!-- Cost Structure -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-chart-pie mr-2 text-purple-500"></i>Estrutura de Custos</h2>
                        <div style="max-height:300px; display:flex; justify-content:center;">
                            <canvas id="dash-cost-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Insights Rápidos</h2>
                        <div id="dash-insights" class="space-y-3">
                            <p class="text-center text-gray-500 py-4">Gere o relatório para ver insights.</p>
                        </div>
                    </div>
                </div>

                <!-- iFood Promotion Break-Even Calculator -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-calculator mr-2 text-orange-500"></i>Calculadora de Ponto de Equilíbrio - Promoções iFood</h2>
                    <p class="text-sm text-gray-500 mb-4">Descubra quantas vendas extras você precisa para compensar o desconto de uma promoção.</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
                            <select id="dash-be-produto" class="w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plano iFood</label>
                            <select id="dash-be-plano" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="0.12">Básico (12%)</option>
                                <option value="0.23" selected>Entrega (23%)</option>
                                <option value="0.27">Premium (27%)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Desconto (%)</label>
                            <input type="number" id="dash-be-desconto" value="20" min="1" max="80" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div class="flex items-end">
                            <button onclick="calcularBreakEven()" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                                <i class="fas fa-calculator mr-2"></i> Calcular
                            </button>
                        </div>
                    </div>
                    <div id="dash-be-resultado" class="hidden"></div>
                </div>
            </div>

            <div id="analise-tab" class="hidden space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Registo de Vendas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div>
                            <label for="periodo-vendas" class="block text-sm font-medium text-gray-700 mb-1">Período de Vendas</label>
                            <input type="text" id="periodo-vendas" placeholder="Selecione o período" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="canal-analise" class="block text-sm font-medium text-gray-700 mb-1">Canal de Venda Principal</label>
                            <select id="canal-analise" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                        </div>
                        <button onclick="analisarVendas()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors h-10">
                            <i class="fas fa-chart-pie mr-2"></i> Analisar Vendas
                        </button>
                    </div>
                    <div id="lista-registro-vendas" class="mt-6 max-h-96 overflow-y-auto"></div>
                </div>
                <div id="resultado-analise-cardapio" class="hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Engenharia de Cardápio</h2>
                    <div id="container-analise" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    </div>
                </div>
            </div>

            <!-- RELATÓRIOS IFOOD TAB -->
            <div id="relatorios-tab" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-2 text-gray-700"><i class="fas fa-file-csv text-orange-500 mr-2"></i>Importar Relatório iFood</h2>
                    <p class="text-sm text-gray-500 mb-4">Importe o relatório financeiro do Portal do Parceiro iFood para análise detalhada de vendas, comissões e lucro real.</p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Como exportar -->
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
                            <h3 class="font-bold text-sm text-orange-800 mb-3"><i class="fas fa-question-circle mr-1"></i> Como exportar do iFood?</h3>
                            <ol class="text-xs text-orange-700 space-y-2 list-decimal list-inside">
                                <li>Acesse o <strong>Portal do Parceiro</strong> (<em>portal.ifood.com.br</em>)</li>
                                <li>Vá em <strong>Financeiro > Relatórios</strong></li>
                                <li>Selecione o período desejado</li>
                                <li>Clique em <strong>"Exportar CSV"</strong> ou <strong>"Exportar Excel"</strong></li>
                                <li>Salve o arquivo e importe aqui abaixo</li>
                            </ol>
                            <div class="mt-3 p-2 bg-white rounded border border-orange-300 text-xs">
                                <strong>Colunas esperadas:</strong> Data, Pedido, Itens, Valor Bruto, Desconto, Comissão, Taxa, Valor Líquido (nomes podem variar)
                            </div>
                        </div>

                        <!-- Upload -->
                        <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-indigo-400 transition-colors" id="csv-drop-zone">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-sm text-gray-600 mb-2">Arraste o arquivo CSV aqui ou clique para selecionar</p>
                            <input type="file" id="csv-file-input" accept=".csv,.xlsx,.xls" class="hidden" onchange="processarRelatorioCSV(this.files[0])">
                            <button onclick="document.getElementById('csv-file-input').click()" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                                <i class="fas fa-folder-open mr-2"></i> Selecionar Arquivo
                            </button>
                            <p class="text-xs text-gray-400 mt-2">Formatos aceitos: CSV (separado por ; ou ,)</p>
                        </div>
                    </div>
                </div>

                <!-- Resultado da análise do CSV -->
                <div id="relatorio-resultado" class="hidden space-y-6">
                    <!-- Cards de resumo -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="dashboard-card border-l-4 border-blue-500">
                            <div class="stat-value text-blue-600" id="rel-total-pedidos">0</div>
                            <div class="stat-label">Total de Pedidos</div>
                        </div>
                        <div class="dashboard-card border-l-4 border-green-500">
                            <div class="stat-value text-green-600" id="rel-faturamento-bruto">R$ 0</div>
                            <div class="stat-label">Faturamento Bruto</div>
                        </div>
                        <div class="dashboard-card border-l-4 border-red-500">
                            <div class="stat-value text-red-600" id="rel-total-taxas">R$ 0</div>
                            <div class="stat-label">Total Taxas + Comissões</div>
                        </div>
                        <div class="dashboard-card border-l-4 border-indigo-500">
                            <div class="stat-value text-indigo-600" id="rel-liquido">R$ 0</div>
                            <div class="stat-label">Valor Líquido Recebido</div>
                        </div>
                    </div>

                    <!-- Métricas extras -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="dashboard-card border-l-4 border-orange-500">
                            <div class="stat-value text-orange-600" id="rel-ticket-medio">R$ 0</div>
                            <div class="stat-label">Ticket Médio</div>
                        </div>
                        <div class="dashboard-card border-l-4 border-purple-500">
                            <div class="stat-value text-purple-600" id="rel-taxa-efetiva">0%</div>
                            <div class="stat-label">Taxa Efetiva Real</div>
                        </div>
                        <div class="dashboard-card border-l-4 border-yellow-500">
                            <div class="stat-value text-yellow-600" id="rel-total-descontos">R$ 0</div>
                            <div class="stat-label">Total Descontos/Promoções</div>
                        </div>
                        <div class="dashboard-card border-l-4 border-teal-500">
                            <div class="stat-value text-teal-600" id="rel-pedidos-dia">0</div>
                            <div class="stat-label">Média Pedidos/Dia</div>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700"><i class="fas fa-chart-line text-blue-500 mr-2"></i>Faturamento por Período</h3>
                            <canvas id="rel-chart-faturamento" height="250"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700"><i class="fas fa-chart-pie text-red-500 mr-2"></i>Composição: Líquido vs Taxas</h3>
                            <div style="max-height:250px; display:flex; justify-content:center;">
                                <canvas id="rel-chart-composicao"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela detalhada -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-table text-green-500 mr-2"></i>Detalhamento dos Pedidos</h3>
                            <div class="flex gap-2">
                                <input type="text" id="rel-filtro" placeholder="Filtrar..." class="p-2 border border-gray-300 rounded-md text-sm" onkeyup="filtrarTabelaRelatorio()">
                                <button onclick="exportarAnaliseCSV()" class="bg-green-500 text-white text-xs font-bold py-2 px-3 rounded-lg hover:bg-green-600 transition-colors">
                                    <i class="fas fa-download mr-1"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div id="rel-tabela-pedidos" class="overflow-x-auto max-h-96 overflow-y-auto"></div>
                    </div>

                    <!-- Insights do relatório -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Insights do Relatório</h3>
                        <div id="rel-insights" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <div id="configuracoes-tab" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">
                        Custos Operacionais
                        <span class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Insira aqui seus custos fixos e variáveis mensais e seu faturamento médio para calcular o percentual de custo operacional.</span>
                        </span>
                    </h2>
                    <div class="mb-4">
                        <label for="faturamento-mensal" class="block text-sm font-medium text-gray-700 mb-1">Faturamento Médio Mensal (R$)</label>
                        <input type="number" id="faturamento-mensal" placeholder="Ex: 40000" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div id="lista-custos-operacionais"></div>
                    <div class="mt-4 flex justify-between items-center">
                        <button onclick="adicionarCustoOperacional()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i> Adicionar Custo
                        </button>
                        <div class="text-right">
                            <p class="font-semibold">Total: <span id="total-custo-operacional" class="text-red-600">R$ 0,00</span></p>
                            <p class="font-semibold">Custo Operacional: <span id="percentual-custo-operacional" class="text-indigo-600">0.00%</span></p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">
                        Canais de Venda
                        <span class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Cadastre os canais de venda (ex: Balcão, iFood) e suas respectivas taxas.</span>
                        </span>
                    </h2>
                    <div id="lista-canais-venda"></div>
                    <button onclick="adicionarCanalVenda()" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i> Adicionar Canal
                    </button>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">
                        <i class="fas fa-robot text-purple-500 mr-2"></i>Assistente de IA (Gemini)
                        <span class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Configure sua chave da API Gemini para usar análises de preço, sugestões de ingredientes e consultoria com IA.</span>
                        </span>
                    </h2>
                    <div id="ia-status-banner" class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <strong>IA desativada.</strong> Configure sua chave da API Gemini abaixo para ativar as funcionalidades de IA (análise de preços, sugestões, consultoria).
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="gemini-api-key" class="block text-sm font-medium text-gray-700 mb-1">Chave da API Gemini (Google AI Studio)</label>
                            <input type="password" id="gemini-api-key" placeholder="Cole sua chave aqui: AIzaSy..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">Obtenha em: <a href="https://aistudio.google.com/apikey" target="_blank" class="text-indigo-600 underline">aistudio.google.com/apikey</a> (gratuito)</p>
                        </div>
                        <div>
                            <label for="gemini-model-select" class="block text-sm font-medium text-gray-700 mb-1">Modelo para Análise de Mercado</label>
                            <select id="gemini-model-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (Rápido)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Detalhado)</option>
                                <option value="gemini-3.1-pro-preview">Gemini 3.1 Pro Preview (Avançado)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Modelo usado na Análise de Mercado com Search Grounding</p>
                        </div>
                        <div>
                            <button onclick="testarConexaoIA()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-plug mr-2"></i> Testar Conexão
                            </button>
                            <span id="ia-test-result" class="ml-2 text-sm"></span>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 text-center mt-4">
                    <button id="btn-salvar-config" onclick="salvarConfiguracoes()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg" disabled>
                        <i class="fas fa-save mr-2"></i> Salvar Todas as Configurações
                    </button>
                </div>
            </div>

            <!-- ===== ABA CARDAPIO DIGITAL ===== -->
            <div id="cardapio-tab" class="hidden space-y-6">
                <!-- Header com link -->
                <div class="bg-gradient-to-r from-orange-500 to-red-500 p-6 rounded-xl shadow-lg text-white">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold"><i class="fas fa-store mr-2"></i>Seu Cardapio Digital</h2>
                            <p class="text-orange-100 mt-1">Configure e compartilhe seu cardapio online com seus clientes.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="previsualizarCardapio()" class="bg-white text-orange-600 font-bold py-2 px-4 rounded-lg hover:bg-orange-50 transition-colors text-sm">
                                <i class="fas fa-eye mr-1"></i> Visualizar
                            </button>
                            <button onclick="compartilharCardapio()" class="bg-orange-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-800 transition-colors text-sm">
                                <i class="fas fa-share-alt mr-1"></i> Compartilhar
                            </button>
                        </div>
                    </div>
                    <div id="cardapio-link-box" class="mt-4 bg-white/20 p-3 rounded-lg hidden">
                        <div class="flex items-center gap-2">
                            <input type="text" id="cardapio-link" readonly class="flex-1 bg-white text-gray-800 p-2 rounded text-sm">
                            <button onclick="copiarLinkCardapio()" class="bg-white text-orange-600 py-2 px-3 rounded text-sm font-bold hover:bg-orange-50">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Dados da Loja -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fas fa-store text-orange-500 mr-2"></i>Dados da Loja</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Nome do Restaurante / Loja</label>
                                <input type="text" id="loja-nome" placeholder="Ex: Pizzaria Show de Delicias" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Descricao curta</label>
                                <input type="text" id="loja-descricao" placeholder="Ex: A melhor pizza artesanal da cidade" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Logo da Loja</label>
                                <div class="flex items-center gap-3">
                                    <div id="loja-logo-preview" class="w-16 h-16 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50">
                                        <i class="fas fa-camera text-gray-300 text-xl"></i>
                                    </div>
                                    <label class="bg-orange-500 text-white text-sm py-2 px-3 rounded-lg cursor-pointer hover:bg-orange-600">
                                        <i class="fas fa-upload mr-1"></i> Enviar Logo
                                        <input type="file" accept="image/*" onchange="uploadLogoLoja(event)" class="hidden">
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Banner / Capa</label>
                                <div class="flex items-center gap-3">
                                    <div id="loja-banner-preview" class="w-full h-24 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50">
                                        <i class="fas fa-image text-gray-300 text-xl"></i>
                                    </div>
                                </div>
                                <label class="mt-2 inline-block bg-orange-500 text-white text-sm py-2 px-3 rounded-lg cursor-pointer hover:bg-orange-600">
                                    <i class="fas fa-upload mr-1"></i> Enviar Banner
                                    <input type="file" accept="image/*" onchange="uploadBannerLoja(event)" class="hidden">
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">WhatsApp</label>
                                    <input type="text" id="loja-whatsapp" placeholder="(92) 99999-9999" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Instagram</label>
                                    <input type="text" id="loja-instagram" placeholder="@seurestaurante" class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Endereco</label>
                                <input type="text" id="loja-endereco" placeholder="Rua, numero - Bairro, Cidade" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Horario de Funcionamento</label>
                                <input type="text" id="loja-horario" placeholder="Seg-Sex: 11h-23h | Sab-Dom: 11h-00h" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Cor do Tema</label>
                                <div class="flex gap-2">
                                    <button onclick="setCorTema('#ea580c')" class="w-8 h-8 rounded-full bg-orange-600 border-2 border-transparent hover:border-gray-400 cor-tema-btn" data-cor="#ea580c"></button>
                                    <button onclick="setCorTema('#dc2626')" class="w-8 h-8 rounded-full bg-red-600 border-2 border-transparent hover:border-gray-400 cor-tema-btn" data-cor="#dc2626"></button>
                                    <button onclick="setCorTema('#7c3aed')" class="w-8 h-8 rounded-full bg-purple-600 border-2 border-transparent hover:border-gray-400 cor-tema-btn" data-cor="#7c3aed"></button>
                                    <button onclick="setCorTema('#059669')" class="w-8 h-8 rounded-full bg-emerald-600 border-2 border-transparent hover:border-gray-400 cor-tema-btn" data-cor="#059669"></button>
                                    <button onclick="setCorTema('#2563eb')" class="w-8 h-8 rounded-full bg-blue-600 border-2 border-transparent hover:border-gray-400 cor-tema-btn" data-cor="#2563eb"></button>
                                    <button onclick="setCorTema('#d97706')" class="w-8 h-8 rounded-full bg-amber-600 border-2 border-transparent hover:border-gray-400 cor-tema-btn" data-cor="#d97706"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Entrega e Pagamento -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fas fa-motorcycle text-orange-500 mr-2"></i>Entrega e Logistica</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-600">Entrega ativa</label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="loja-entrega-ativa" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-600">Retirada no local</label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="loja-retirada-ativa" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                    </label>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">Taxa de entrega (R$)</label>
                                        <input type="number" id="loja-taxa-entrega" placeholder="5.00" step="0.50" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">Pedido minimo (R$)</label>
                                        <input type="number" id="loja-pedido-minimo" placeholder="20.00" step="1" class="w-full p-2 border rounded-lg">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Tempo estimado de entrega</label>
                                    <input type="text" id="loja-tempo-entrega" placeholder="30-50 min" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Entrega gratis acima de (R$)</label>
                                    <input type="number" id="loja-frete-gratis" placeholder="50.00" step="5" class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fas fa-credit-card text-orange-500 mr-2"></i>Formas de Pagamento</h3>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="pag-pix" class="w-4 h-4 text-orange-500 rounded" checked>
                                    <i class="fas fa-qrcode text-green-600"></i>
                                    <span class="text-sm">Pix</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="pag-cartao-credito" class="w-4 h-4 text-orange-500 rounded" checked>
                                    <i class="fas fa-credit-card text-blue-600"></i>
                                    <span class="text-sm">Cartao de Credito</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="pag-cartao-debito" class="w-4 h-4 text-orange-500 rounded" checked>
                                    <i class="fas fa-credit-card text-purple-600"></i>
                                    <span class="text-sm">Cartao de Debito</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="pag-dinheiro" class="w-4 h-4 text-orange-500 rounded" checked>
                                    <i class="fas fa-money-bill-wave text-green-700"></i>
                                    <span class="text-sm">Dinheiro</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="pag-vale-refeicao" class="w-4 h-4 text-orange-500 rounded">
                                    <i class="fas fa-ticket-alt text-orange-600"></i>
                                    <span class="text-sm">Vale Refeicao</span>
                                </label>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1 mt-2">Chave Pix (para exibir no pedido)</label>
                                    <input type="text" id="loja-chave-pix" placeholder="email@email.com ou CPF/CNPJ" class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cupons e Promocoes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fas fa-ticket-alt text-orange-500 mr-2"></i>Cupons de Desconto</h3>
                        <div id="lista-cupons"></div>
                        <button onclick="adicionarCupom()" class="mt-3 bg-orange-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-orange-600">
                            <i class="fas fa-plus mr-1"></i> Novo Cupom
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fas fa-bullhorn text-orange-500 mr-2"></i>Banners Publicitarios / Ads</h3>
                        <p class="text-xs text-gray-500 mb-3">Adicione banners promocionais que aparecem no topo do cardapio.</p>
                        <div id="lista-banners"></div>
                        <button onclick="adicionarBanner()" class="mt-3 bg-orange-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-orange-600">
                            <i class="fas fa-plus mr-1"></i> Novo Banner
                        </button>
                    </div>
                </div>

                <!-- Produtos no Cardapio -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fas fa-utensils text-orange-500 mr-2"></i>Produtos no Cardapio</h3>
                    <p class="text-xs text-gray-500 mb-4">Defina preco, categoria, destaque e desconto de cada produto no cardapio. Apenas produtos com preco definido aparecerao.</p>
                    <div id="cardapio-produtos-lista" class="space-y-3"></div>
                </div>

                <!-- Salvar -->
                <div class="text-center">
                    <button onclick="salvarCardapioConfig()" class="bg-orange-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-700 transition-colors shadow-lg text-lg">
                        <i class="fas fa-save mr-2"></i> Salvar Cardapio
                    </button>
                </div>
            </div>

            <!-- ===== ABA PEDIDOS RECEBIDOS ===== -->
            <div id="pedidos-tab" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-xl shadow-lg text-white">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold"><i class="fas fa-bell mr-2"></i>Pedidos Recebidos</h2>
                            <p class="text-green-100 mt-1">Acompanhe em tempo real todos os pedidos do seu cardapio digital.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="carregarPedidos()" class="bg-white text-green-600 font-bold py-2 px-4 rounded-lg hover:bg-green-50 transition-colors text-sm">
                                <i class="fas fa-sync-alt mr-1"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resumo dos pedidos -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <div class="text-3xl font-bold text-yellow-500" id="pedidos-novos-count">0</div>
                        <div class="text-xs text-gray-500 mt-1">Novos</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <div class="text-3xl font-bold text-blue-500" id="pedidos-preparo-count">0</div>
                        <div class="text-xs text-gray-500 mt-1">Em Preparo</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <div class="text-3xl font-bold text-green-500" id="pedidos-entregue-count">0</div>
                        <div class="text-xs text-gray-500 mt-1">Entregues Hoje</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <div class="text-3xl font-bold text-emerald-600" id="pedidos-total-dia">R$ 0</div>
                        <div class="text-xs text-gray-500 mt-1">Faturamento Hoje</div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="filtrarPedidos('todos')" class="filtro-pedido-btn bg-gray-800 text-white text-sm font-bold py-2 px-4 rounded-lg">Todos</button>
                    <button onclick="filtrarPedidos('novo')" class="filtro-pedido-btn bg-yellow-100 text-yellow-800 text-sm font-bold py-2 px-4 rounded-lg">Novos</button>
                    <button onclick="filtrarPedidos('preparo')" class="filtro-pedido-btn bg-blue-100 text-blue-800 text-sm font-bold py-2 px-4 rounded-lg">Em Preparo</button>
                    <button onclick="filtrarPedidos('entregue')" class="filtro-pedido-btn bg-green-100 text-green-800 text-sm font-bold py-2 px-4 rounded-lg">Entregues</button>
                    <button onclick="filtrarPedidos('cancelado')" class="filtro-pedido-btn bg-red-100 text-red-800 text-sm font-bold py-2 px-4 rounded-lg">Cancelados</button>
                </div>

                <!-- Lista de pedidos -->
                <div id="pedidos-lista" class="space-y-4">
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-5xl mb-4"></i>
                        <p class="text-lg font-semibold">Nenhum pedido ainda</p>
                        <p class="text-sm">Quando clientes fizerem pedidos pelo cardapio digital, eles aparecerao aqui.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-backdrop" class="modal-backdrop hidden" style="display:none;">
        <div id="modal-content" class="modal-content"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMP9yXGBnoBm6RVHas69fU3G51-a2l-vg",
            authDomain: "meu-precificador-show.firebaseapp.com",
            projectId: "meu-precificador-show",
            storageBucket: "meu-precificador-show.appspot.com",
            messagingSenderId: "767394530716",
            appId: "1:767394530716:web:412fe2b46d0081b6a07459"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'precificador-show-de-delicias';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.appState = {
            db,
            userId: null,
            isReady: false,
            apiKey: firebaseConfig.apiKey, 
            getCollectionRef,
            getConfigDocRef,
            insumosCache: () => insumosCache,
            produtosCache: () => produtosCache,
            embalagensCache: () => embalagensCache,
            configCache: () => configCache,
            doc, setDoc, getDoc, getDocs, collection, onSnapshot, addDoc, updateDoc, deleteDoc
        };

        let insumosCache = [];
        let produtosCache = [];
        let embalagensCache = [];
        let configCache = {};
        
        function getCollectionRef(collectionName) {
            if (!window.appState.userId) return null;
            return collection(db, `artifacts/${appId}/users/${window.appState.userId}/${collectionName}`);
        }
    
        function getConfigDocRef() {
            if (!window.appState.userId) return null;
            return doc(db, `artifacts/${appId}/users/${window.appState.userId}/configuracoes/main`);
        }
        
        function initializeAppState() {
            if (!window.appState.isReady || !window.appState.userId) return;
            
            const insumosRef = getCollectionRef('insumos');
            if (insumosRef) onSnapshot(insumosRef, snapshot => {
                insumosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarInsumos();
            });

            const produtosRef = getCollectionRef('produtos');
            if (produtosRef) onSnapshot(produtosRef, snapshot => {
                produtosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarProdutos();
                filtrarSimuladorSelect();
                if(typeof renderRegistroVendas === 'function') renderRegistroVendas();
            });

            const embalagensRef = getCollectionRef('embalagens');
            if (embalagensRef) onSnapshot(embalagensRef, snapshot => {
                embalagensCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarEmbalagens();
                filtrarProdutos();
            });

            const configRef = getConfigDocRef();
            if(configRef) onSnapshot(configRef, (doc) => {
                if (doc.exists()) {
                    configCache = doc.data();
                } else {
                    configCache = {
                        faturamentoMedioMensal: 40000,
                        custosOperacionais: [],
                        canaisVenda: []
                    };
                }
                renderConfiguracoes();
                updateCanalAnaliseSelect();
            });

            // Listener de pedidos em tempo real
            const pedidosRef = getCollectionRef('pedidos');
            if (pedidosRef) onSnapshot(pedidosRef, snapshot => {
                pedidosCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                pedidosCache.sort((a, b) => (b.criadoEm || '').localeCompare(a.criadoEm || ''));
                atualizarBadgePedidos();
                if (!document.getElementById('pedidos-tab').classList.contains('hidden')) {
                    renderPedidos();
                }
            });
        }
        
        const loginComGoogle = function() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Erro no login com Google:", error);
                mostrarErroLogin('login', traduzirErroFirebase(error.code));
            });
        }

        const logout = function() {
            signOut(auth).catch(error => console.error("Erro no logout:", error));
        }

        const loginComEmail = async function() {
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            const erroEl = document.getElementById('login-erro');
            erroEl.classList.add('hidden');

            if (!email || !senha) {
                mostrarErroLogin('login', 'Preencha email e senha.');
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, senha);
            } catch (error) {
                console.error("Erro no login:", error);
                mostrarErroLogin('login', traduzirErroFirebase(error.code));
            }
        }

        const cadastrarComEmail = async function() {
            const nome = document.getElementById('cadastro-nome').value.trim();
            const empresa = document.getElementById('cadastro-empresa').value.trim();
            const email = document.getElementById('cadastro-email').value.trim();
            const senha = document.getElementById('cadastro-senha').value;
            const senhaConfirm = document.getElementById('cadastro-senha-confirmar').value;
            const erroEl = document.getElementById('cadastro-erro');
            erroEl.classList.add('hidden');

            if (!nome) { mostrarErroLogin('cadastro', 'Informe seu nome.'); return; }
            if (!email) { mostrarErroLogin('cadastro', 'Informe seu email.'); return; }
            if (senha.length < 6) { mostrarErroLogin('cadastro', 'A senha deve ter no minimo 6 caracteres.'); return; }
            if (senha !== senhaConfirm) { mostrarErroLogin('cadastro', 'As senhas nao coincidem.'); return; }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
                // Atualizar perfil com nome
                await updateProfile(userCredential.user, {
                    displayName: nome
                });
                // Salvar dados extras do cadastro no Firestore
                const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/configuracoes/perfil`);
                await setDoc(userDocRef, {
                    nome: nome,
                    empresa: empresa,
                    email: email,
                    criadoEm: new Date().toISOString(),
                    plano: 'gratuito'
                });
                // Forçar atualização do nome na UI
                document.getElementById('user-name').textContent = nome;
            } catch (error) {
                console.error("Erro no cadastro:", error);
                mostrarErroLogin('cadastro', traduzirErroFirebase(error.code));
            }
        }

        const recuperarSenha = async function() {
            const email = document.getElementById('login-email').value.trim();
            if (!email) {
                mostrarErroLogin('login', 'Digite seu email no campo acima para receber o link de recuperacao.');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                const erroEl = document.getElementById('login-erro');
                erroEl.classList.remove('hidden');
                erroEl.className = 'text-sm text-green-600 bg-green-50 p-3 rounded-lg';
                erroEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Email de recuperacao enviado! Verifique sua caixa de entrada.';
            } catch (error) {
                console.error("Erro ao recuperar senha:", error);
                mostrarErroLogin('login', traduzirErroFirebase(error.code));
            }
        }

        function mostrarErroLogin(tipo, mensagem) {
            const erroEl = document.getElementById(tipo + '-erro');
            erroEl.classList.remove('hidden');
            erroEl.className = 'text-sm text-red-600 bg-red-50 p-3 rounded-lg';
            erroEl.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> ' + mensagem;
        }

        function traduzirErroFirebase(code) {
            const erros = {
                'auth/email-already-in-use': 'Este email ja esta cadastrado. Tente fazer login.',
                'auth/invalid-email': 'Email invalido. Verifique o formato.',
                'auth/weak-password': 'Senha muito fraca. Use no minimo 6 caracteres.',
                'auth/user-not-found': 'Email nao encontrado. Crie uma conta primeiro.',
                'auth/wrong-password': 'Senha incorreta. Tente novamente.',
                'auth/invalid-credential': 'Email ou senha incorretos. Verifique seus dados.',
                'auth/too-many-requests': 'Muitas tentativas. Aguarde alguns minutos.',
                'auth/popup-closed-by-user': 'Login cancelado. Tente novamente.',
                'auth/network-request-failed': 'Erro de conexao. Verifique sua internet.',
                'auth/popup-blocked': 'Popup bloqueado pelo navegador. Permita popups para este site.'
            };
            return erros[code] || `Erro: ${code}. Tente novamente.`;
        }

        const alternarLoginCadastro = function(tipo) {
            const tabLogin = document.getElementById('tab-login');
            const tabCadastro = document.getElementById('tab-cadastro');
            const formLogin = document.getElementById('form-login-email');
            const formCadastro = document.getElementById('form-cadastro-email');

            if (tipo === 'login') {
                tabLogin.className = 'flex-1 py-3 text-center font-semibold text-indigo-600 border-b-2 border-indigo-600 transition-colors';
                tabCadastro.className = 'flex-1 py-3 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors';
                formLogin.classList.remove('hidden');
                formCadastro.classList.add('hidden');
            } else {
                tabCadastro.className = 'flex-1 py-3 text-center font-semibold text-green-600 border-b-2 border-green-600 transition-colors';
                tabLogin.className = 'flex-1 py-3 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors';
                formCadastro.classList.remove('hidden');
                formLogin.classList.add('hidden');
            }
            // Limpar erros
            document.getElementById('login-erro').classList.add('hidden');
            document.getElementById('cadastro-erro').classList.add('hidden');
        }

        window.loginComGoogle = loginComGoogle;
        window.loginComEmail = loginComEmail;
        window.cadastrarComEmail = cadastrarComEmail;
        window.recuperarSenha = recuperarSenha;
        window.alternarLoginCadastro = alternarLoginCadastro;
        window.logout = logout;
        window.changeTab = changeTab;
        window.fecharModal = fecharModal;

        // === BACKUP / EXPORTACAO ===
        window.exportarDados = async function() {
            if (!window.appState.userId || !window.appState.isReady) {
                alert('Aguarde a conexao com o banco de dados.');
                return;
            }
            try {
                const backup = {
                    versao: '1.1',
                    dataExportacao: new Date().toISOString(),
                    usuario: {
                        nome: document.getElementById('user-name').textContent,
                        email: document.getElementById('user-email').textContent
                    },
                    insumos: [],
                    produtos: [],
                    embalagens: [],
                    configuracoes: {}
                };

                // Exportar insumos
                const insumosRef = getCollectionRef('insumos');
                if (insumosRef) {
                    const insumosSnap = await getDocs(insumosRef);
                    insumosSnap.forEach(d => backup.insumos.push({ id: d.id, ...d.data() }));
                }

                // Exportar produtos
                const produtosRef = getCollectionRef('produtos');
                if (produtosRef) {
                    const produtosSnap = await getDocs(produtosRef);
                    produtosSnap.forEach(d => backup.produtos.push({ id: d.id, ...d.data() }));
                }

                // Exportar embalagens
                const embalagensRef = getCollectionRef('embalagens');
                if (embalagensRef) {
                    const embalagensSnap = await getDocs(embalagensRef);
                    embalagensSnap.forEach(d => backup.embalagens.push({ id: d.id, ...d.data() }));
                }

                // Exportar configuracoes
                const configRef = getConfigDocRef();
                if (configRef) {
                    const configSnap = await getDoc(configRef);
                    if (configSnap.exists()) backup.configuracoes = configSnap.data();
                }

                // Exportar perfil
                const perfilRef = doc(db, `artifacts/${appId}/users/${window.appState.userId}/configuracoes/perfil`);
                const perfilSnap = await getDoc(perfilRef);
                if (perfilSnap.exists()) backup.perfil = perfilSnap.data();

                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const link = document.createElement('a');
                const data = new Date().toISOString().split('T')[0];
                link.href = URL.createObjectURL(blob);
                link.download = `backup_precificador_${data}.json`;
                link.click();
                URL.revokeObjectURL(link.href);

                alert(`Backup exportado com sucesso!\n\n${backup.insumos.length} insumos\n${backup.produtos.length} produtos\n${backup.embalagens.length} embalagens\nConfiguracoes incluidas`);
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar dados: ' + error.message);
            }
        };

        // === IMPORTACAO / RESTAURACAO ===
        window.importarDados = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = '';

            if (!window.appState.userId || !window.appState.isReady) {
                alert('Aguarde a conexao com o banco de dados.');
                return;
            }

            const confirmar = confirm(
                'ATENCAO: Importar um backup ira SUBSTITUIR todos os dados atuais.\n\n' +
                'Deseja continuar?\n\n' +
                '(Recomendamos fazer um backup antes de importar)'
            );
            if (!confirmar) return;

            try {
                const texto = await file.text();
                const backup = JSON.parse(texto);

                if (!backup.versao || !backup.insumos || !backup.produtos) {
                    alert('Arquivo de backup invalido. Verifique o formato.');
                    return;
                }

                let importados = { insumos: 0, produtos: 0, embalagens: 0 };

                // Importar insumos
                if (backup.insumos && backup.insumos.length > 0) {
                    // Limpar insumos atuais
                    const insumosRef = getCollectionRef('insumos');
                    const insumosAtuais = await getDocs(insumosRef);
                    for (const docSnap of insumosAtuais.docs) {
                        await deleteDoc(docSnap.ref);
                    }
                    // Inserir novos
                    for (const insumo of backup.insumos) {
                        const { id, ...dados } = insumo;
                        if (id) {
                            await setDoc(doc(db, `artifacts/${appId}/users/${window.appState.userId}/insumos/${id}`), dados);
                        } else {
                            await addDoc(insumosRef, dados);
                        }
                        importados.insumos++;
                    }
                }

                // Importar produtos
                if (backup.produtos && backup.produtos.length > 0) {
                    const produtosRef = getCollectionRef('produtos');
                    const produtosAtuais = await getDocs(produtosRef);
                    for (const docSnap of produtosAtuais.docs) {
                        await deleteDoc(docSnap.ref);
                    }
                    for (const produto of backup.produtos) {
                        const { id, ...dados } = produto;
                        if (id) {
                            await setDoc(doc(db, `artifacts/${appId}/users/${window.appState.userId}/produtos/${id}`), dados);
                        } else {
                            await addDoc(produtosRef, dados);
                        }
                        importados.produtos++;
                    }
                }

                // Importar embalagens
                if (backup.embalagens && backup.embalagens.length > 0) {
                    const embalagensRef = getCollectionRef('embalagens');
                    const embalagensAtuais = await getDocs(embalagensRef);
                    for (const docSnap of embalagensAtuais.docs) {
                        await deleteDoc(docSnap.ref);
                    }
                    for (const embalagem of backup.embalagens) {
                        const { id, ...dados } = embalagem;
                        if (id) {
                            await setDoc(doc(db, `artifacts/${appId}/users/${window.appState.userId}/embalagens/${id}`), dados);
                        } else {
                            await addDoc(embalagensRef, dados);
                        }
                        importados.embalagens++;
                    }
                }

                // Importar configuracoes
                if (backup.configuracoes && Object.keys(backup.configuracoes).length > 0) {
                    const configRef = getConfigDocRef();
                    await setDoc(configRef, backup.configuracoes);
                }

                alert(
                    `Backup restaurado com sucesso!\n\n` +
                    `${importados.insumos} insumos importados\n` +
                    `${importados.produtos} produtos importados\n` +
                    `${importados.embalagens} embalagens importadas\n` +
                    `Configuracoes restauradas\n\n` +
                    `Backup original de: ${backup.dataExportacao || 'data desconhecida'}`
                );

                // Recarregar pagina para atualizar tudo
                window.location.reload();
            } catch (error) {
                console.error('Erro ao importar:', error);
                alert('Erro ao importar backup: ' + error.message);
            }
        };

        onAuthStateChanged(auth, user => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app');
            const userInfoContainer = document.getElementById('user-info');

            if (user) {
                if (window.appState.isReady && window.appState.userId === user.uid) return;
                window.appState.userId = user.uid;
                window.appState.isReady = true;

                loginContainer.classList.add('hidden');
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                appContainer.style.display = '';
                userInfoContainer.classList.remove('hidden');
                userInfoContainer.style.display = '';

                const displayName = user.displayName || user.email?.split('@')[0] || 'Utilizador';
                document.getElementById('user-name').textContent = displayName;
                const photoEl = document.getElementById('user-photo');
                if (user.photoURL) {
                    photoEl.src = user.photoURL;
                } else {
                    photoEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=6366f1&color=fff&size=80`;
                }
                document.getElementById('user-email').textContent = user.email || '';

                const statusDot = document.getElementById('db-status-dot');
                const statusText = document.getElementById('db-status-text');
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Ligado e pronto a usar';

                document.getElementById('btn-novo-insumo').disabled = false;
                document.getElementById('btn-novo-produto').disabled = false;
                document.getElementById('btn-nova-embalagem').disabled = false;
                document.getElementById('btn-salvar-config').disabled = false;
                
                initializeAppState();
            } else {
                window.appState.isReady = false;
                window.appState.userId = null;
                loginContainer.classList.remove('hidden');
                loginContainer.style.display = '';
                appContainer.classList.add('hidden');
                appContainer.style.display = 'none';
                userInfoContainer.classList.add('hidden');
                userInfoContainer.style.display = 'none';
            }
        });
    </script>

    <script>
        // FUNÇÕES DE FILTRO
        function filtrarInsumos() {
            const filtro = document.getElementById('filtro-insumos').value.toLowerCase();
            const catFiltro = document.getElementById('filtro-categoria-insumos')?.value || '';
            const todosInsumos = window.appState.insumosCache();
            const insumosFiltrados = todosInsumos.filter(insumo => {
                const matchNome = insumo.nome.toLowerCase().includes(filtro);
                const matchCat = !catFiltro || (insumo.categoria || 'outros') === catFiltro;
                return matchNome && matchCat;
            });
            renderInsumos(insumosFiltrados);
        }

        function filtrarProdutos() {
            const filtro = document.getElementById('filtro-produtos').value.toLowerCase();
            const todosProdutos = window.appState.produtosCache();
            const produtosFiltrados = todosProdutos.filter(produto => produto.nome.toLowerCase().includes(filtro));
            renderProdutos(produtosFiltrados);
        }

        function filtrarEmbalagens() {
            const filtroEl = document.getElementById('filtro-embalagens');
            const filtro = filtroEl ? filtroEl.value.toLowerCase() : '';
            const todasEmbalagens = window.appState.embalagensCache();
            const embalagensFiltradas = todasEmbalagens.filter(e => e.nome.toLowerCase().includes(filtro));
            renderEmbalagens(embalagensFiltradas);
        }

        function filtrarSimuladorSelect() {
            const filtro = document.getElementById('filtro-simulador').value.toLowerCase();
            updateProdutoSelect(filtro);
        }

        // --- LÓGICA DA API GEMINI ---
        function getGeminiApiKey() {
            // Prioridade: 1) campo configurado e salvo, 2) localStorage, 3) Firebase key como fallback
            const savedKey = window.appState.configCache().geminiApiKey;
            const inputKey = document.getElementById('gemini-api-key')?.value?.trim();
            return inputKey || savedKey || localStorage.getItem('geminiApiKey') || '';
        }

        function atualizarStatusIA() {
            const key = getGeminiApiKey();
            const banner = document.getElementById('ia-status-banner');
            if (banner) {
                if (key && key.startsWith('AIza')) {
                    banner.className = 'mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800';
                    banner.innerHTML = '<i class="fas fa-check-circle mr-1"></i> <strong>IA ativada.</strong> As funcionalidades de IA estão prontas para uso.';
                } else {
                    banner.className = 'mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800';
                    banner.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> <strong>IA desativada.</strong> Configure sua chave da API Gemini abaixo para ativar as funcionalidades de IA (análise de preços, sugestões, consultoria).';
                }
            }
        }

        window.testarConexaoIA = async function() {
            const key = getGeminiApiKey();
            const resultSpan = document.getElementById('ia-test-result');
            if (!key) {
                resultSpan.innerHTML = '<span class="text-red-600"><i class="fas fa-times mr-1"></i>Insira uma chave API primeiro.</span>';
                return;
            }
            resultSpan.innerHTML = '<span class="text-gray-500"><span class="spinner"></span>Testando...</span>';
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: "Responda apenas: OK" }] }] })
                });
                if (response.ok) {
                    resultSpan.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Conexão OK! IA funcionando.</span>';
                    localStorage.setItem('geminiApiKey', key);
                    atualizarStatusIA();
                } else {
                    const err = await response.json().catch(() => ({}));
                    resultSpan.innerHTML = `<span class="text-red-600"><i class="fas fa-times mr-1"></i>Erro ${response.status}: ${err.error?.message || 'Chave inválida'}</span>`;
                }
            } catch (e) {
                resultSpan.innerHTML = `<span class="text-red-600"><i class="fas fa-times mr-1"></i>Erro de conexão: ${e.message}</span>`;
            }
        }

        async function callGeminiAPI(prompt) {
            const apiKey = getGeminiApiKey();
            if (!apiKey) {
                throw new Error("Assistente de IA não configurado. Vá em Configurações e insira sua chave da API Gemini (gratuita em aistudio.google.com/apikey).");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    console.error("Erro na API Gemini:", response.status, errorBody);
                    const errorMessage = errorBody.error?.message || `A API retornou um erro ${response.status}.`;
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason === 'SAFETY') {
                        throw new Error("A resposta foi bloqueada por motivos de segurança. Tente reformular o pedido.");
                    }
                    throw new Error("A IA retornou uma resposta vazia ou em formato inesperado.");
                }
            } catch (error) {
                console.error("Falha ao chamar a API Gemini:", error);
                throw error;
            }
        }

        async function callGeminiWithSearch(prompt, systemInstruction) {
            const apiKey = getGeminiApiKey();
            if (!apiKey) {
                throw new Error("Assistente de IA não configurado. Vá em Configurações e insira sua chave da API Gemini.");
            }
            const model = (window.appState.configCache && window.appState.configCache()?.geminiModel) || 'gemini-2.5-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                tools: [{ google_search: {} }]
            };
            if (systemInstruction) {
                payload.system_instruction = { parts: [{ text: systemInstruction }] };
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    console.error("Erro na API Gemini (Search):", response.status, errorBody);
                    throw new Error(errorBody.error?.message || `Erro ${response.status} na API.`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts) {
                    const textParts = result.candidates[0].content.parts.filter(p => p.text).map(p => p.text);
                    const groundingMeta = result.candidates[0].groundingMetadata;
                    return { text: textParts.join('\n'), grounding: groundingMeta || null };
                }
                if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                    throw new Error("Resposta bloqueada por segurança. Tente reformular.");
                }
                throw new Error("A IA retornou uma resposta vazia.");
            } catch (error) {
                console.error("Falha ao chamar Gemini com Search:", error);
                throw error;
            }
        }

        // --- LÓGICA DA INTERFACE (UI) ---

        function changeTab(tabName) {
            document.getElementById('simulador-tab').classList.add('hidden');
            document.getElementById('montador-tab').classList.add('hidden');
            document.getElementById('produtos-tab').classList.add('hidden');
            document.getElementById('insumos-tab').classList.add('hidden');
            document.getElementById('embalagens-tab').classList.add('hidden');
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('analise-tab').classList.add('hidden');
            document.getElementById('relatorios-tab').classList.add('hidden');
            document.getElementById('configuracoes-tab').classList.add('hidden');
            document.getElementById('cardapio-tab').classList.add('hidden');
            document.getElementById('pedidos-tab').classList.add('hidden');
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            const tabBtn = document.querySelector(`button[onclick="changeTab('${tabName}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
            if (tabName === 'dashboard') {
                atualizarDashboardSelects();
                atualizarDashboardCards();
            }
            if (tabName === 'cardapio') {
                renderCardapioProdutos();
                renderCupons();
                renderBanners();
                carregarCardapioConfig();
            }
            if (tabName === 'pedidos') {
                carregarPedidos();
            }
            if (tabName === 'embalagens') {
                filtrarEmbalagens();
            }
            if (tabName === 'montador') {
                renderMontador();
            }
        }

        // Tipo de promoção selecionado
        let tipoPromoSelecionado = 'cupom_restaurante';
        window.selecionarTipoPromo = function(tipo) {
            tipoPromoSelecionado = tipo;
            document.querySelectorAll('.promo-type-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('promo-' + tipo).classList.add('selected');
            const subsidioInput = document.getElementById('subsidio-ifood');
            const descontoInput = document.getElementById('desconto-cliente');
            if (tipo === 'cupom_restaurante') {
                subsidioInput.value = '0.00';
                subsidioInput.disabled = true;
            } else if (tipo === 'cupom_ifood') {
                subsidioInput.value = descontoInput.value;
                subsidioInput.disabled = true;
            } else {
                subsidioInput.disabled = false;
                subsidioInput.value = (parseFloat(descontoInput.value) / 2).toFixed(2);
            }
        }
        
        function updateProdutoSelect(filtro = '') {
            const todosProdutos = window.appState.produtosCache();
            const produtosFiltrados = todosProdutos.filter(produto => 
                produto.nome.toLowerCase().includes(filtro.toLowerCase())
            );
            const select = document.getElementById('produto-select');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Selecione um produto --</option>';
            produtosFiltrados.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = produto.nome;
                select.appendChild(option);
            });
            if (produtosFiltrados.some(p => p.id === currentVal)) {
                select.value = currentVal;
            }
        }

        function updateCanalAnaliseSelect() {
            const canais = window.appState.configCache().canaisVenda || [];
            const select = document.getElementById('canal-analise');
            select.innerHTML = '<option value="">-- Selecione um canal --</option>';
            canais.forEach(canal => {
                const option = document.createElement('option');
                option.value = canal.nome;
                option.textContent = canal.nome;
                select.appendChild(option);
            });
        }

        // --- RENDERIZAÇÃO ---
        
        function renderInsumos(lista = window.appState.insumosCache()) {
            const container = document.getElementById('lista-insumos');
            if (!lista.length) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum insumo encontrado.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Compra</th>
                        <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Desperdício</th>
                        <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">FC</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Real</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            lista.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(insumo => {
                const despPerc = parseFloat(insumo.percentualDesperdicio) || 0;
                const rendimento = 1 - despPerc;
                const fc = rendimento > 0 ? (1 / rendimento) : 0;
                const custoReal = rendimento > 0 ? parseFloat(insumo.precoCompra) / rendimento : 0;
                const unidadeCompra = insumo.unidadeCompra || 'un';
                const custoPorUnidade = parseFloat(insumo.qtdCompra) > 0 ? custoReal / parseFloat(insumo.qtdCompra) : 0;
                // Cor do badge de desperdício
                const despClass = despPerc > 0.40 ? 'bg-red-100 text-red-800' : despPerc > 0.20 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const fcClass = fc > 1.5 ? 'text-red-600 font-bold' : fc > 1.2 ? 'text-yellow-600 font-semibold' : 'text-green-600 font-semibold';
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                const catBadges = { proteina: 'bg-red-100 text-red-700', carboidrato: 'bg-yellow-100 text-yellow-700', salada: 'bg-green-100 text-green-700', outros: 'bg-gray-100 text-gray-600' };
                const catLabels = { proteina: 'Proteína', carboidrato: 'Carboidrato', salada: 'Salada', outros: 'Outros' };
                const cat = insumo.categoria || 'outros';
                tr.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${insumo.nome}</div>
                        <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${catBadges[cat]}">${catLabels[cat]}</span>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <div class="text-gray-700">R$ ${parseFloat(insumo.precoCompra).toFixed(2)}</div>
                        <div class="text-xs text-gray-400">${insumo.qtdCompra} ${unidadeCompra}</div>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap text-center">
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${despClass}">${(despPerc * 100).toFixed(0)}%</span>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap text-center">
                        <span class="${fcClass}">${fc.toFixed(2)}</span>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <div class="font-bold text-indigo-600">R$ ${custoReal.toFixed(2)} / ${insumo.qtdCompra} ${unidadeCompra}</div>
                        <div class="text-xs text-gray-500">R$ ${custoPorUnidade.toFixed(4)} / ${unidadeCompra}</div>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="abrirModalInsumo('${insumo.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="deletarItem('insumos', '${insumo.id}', 'insumo')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderProdutos(lista = window.appState.produtosCache()) {
            const container = document.getElementById('lista-produtos');
            if (!lista.length) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum produto encontrado.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Insumos</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Embalagens</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Total</th>
                        <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            lista.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(produto => {
                const custoInsumos = calcularCustoProduto(produto.id);
                const custoEmbalagens = calcularCustoEmbalagensProduto(produto.id);
                const custoTotal = custoInsumos + custoEmbalagens;
                const fotoHtml = produto.imagemUrl
                    ? `<img src="${produto.imagemUrl}" class="w-12 h-12 rounded-lg object-cover shadow-sm">`
                    : `<div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-300"><i class="fas fa-utensils text-lg"></i></div>`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap">
                        <div class="flex items-center gap-3">
                            ${fotoHtml}
                            <span class="font-medium text-gray-900">${produto.nome}</span>
                        </div>
                    </td>
                    <td class="py-3 px-6 whitespace-nowrap text-gray-700">R$ ${custoInsumos.toFixed(2)}</td>
                    <td class="py-3 px-6 whitespace-nowrap text-gray-700">${custoEmbalagens > 0 ? 'R$ ' + custoEmbalagens.toFixed(2) : '<span class="text-gray-400">-</span>'}</td>
                    <td class="py-3 px-6 whitespace-nowrap font-semibold text-gray-800">R$ ${custoTotal.toFixed(2)}</td>
                    <td class="py-3 px-6 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="abrirModalProduto('${produto.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                        <button onclick="deletarItem('produtos', '${produto.id}', 'produto')" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderConfiguracoes() {
            const config = window.appState.configCache();
            if (!config) return;
            document.getElementById('faturamento-mensal').value = config.faturamentoMedioMensal || '';
            const custosContainer = document.getElementById('lista-custos-operacionais');
            custosContainer.innerHTML = '';
            (config.custosOperacionais || []).forEach((custo, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 mb-2';
                div.innerHTML = `
                    <input type="text" value="${custo.nome}" onchange="updateCustoTemp(${index}, 'nome', this.value)" class="w-2/3 p-2 border border-gray-300 rounded-md" placeholder="Nome do Custo">
                    <input type="number" value="${custo.valor}" onchange="updateCustoTemp(${index}, 'valor', this.value)" class="w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Valor">
                    <button onclick="removerCustoOperacional(${index})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                `;
                custosContainer.appendChild(div);
            });
            const canaisContainer = document.getElementById('lista-canais-venda');
            canaisContainer.innerHTML = '';
            (config.canaisVenda || []).forEach((canal, index) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-4 items-center gap-2 mb-2';
                div.innerHTML = `
                    <input type="text" value="${canal.nome}" onchange="updateCanalTemp(${index}, 'nome', this.value)" class="col-span-2 p-2 border border-gray-300 rounded-md" placeholder="Nome do Canal">
                    <input type="number" value="${(canal.taxaComissao * 100).toFixed(2)}" onchange="updateCanalTemp(${index}, 'taxaComissao', this.value / 100)" class="p-2 border border-gray-300 rounded-md" placeholder="Comissão %">
                    <input type="number" value="${(canal.taxaTransacao * 100).toFixed(2)}" onchange="updateCanalTemp(${index}, 'taxaTransacao', this.value / 100)" class="p-2 border border-gray-300 rounded-md" placeholder="Transação %">
                    <button onclick="removerCanalVenda(${index})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                `;
                canaisContainer.appendChild(div);
            });
            calcularTotaisConfig();
            // Carregar chave Gemini
            const geminiKeyInput = document.getElementById('gemini-api-key');
            if (geminiKeyInput) {
                const savedKey = config.geminiApiKey || localStorage.getItem('geminiApiKey') || '';
                if (savedKey) geminiKeyInput.value = savedKey;
            }
            // Carregar modelo Gemini selecionado
            const modelSelect = document.getElementById('gemini-model-select');
            if (modelSelect && config.geminiModel) {
                modelSelect.value = config.geminiModel;
            }
            atualizarStatusIA();
        }

        function converterUnidade(quantidade, unidadeOrigem, unidadeDestino) {
            if (unidadeOrigem === unidadeDestino) return quantidade;
            const conversoes = {
                'g_kg': 0.001,
                'kg_g': 1000,
                'ml_L': 0.001,
                'L_ml': 1000,
            };
            const chave = `${unidadeOrigem}_${unidadeDestino}`;
            const fator = conversoes[chave];
            if (fator !== undefined) {
                return quantidade * fator;
            }
            return null;
        }

        function unidadesCompativeis(unidade) {
            const grupos = {
                peso: ['g', 'kg'],
                volume: ['ml', 'L'],
                unitario: ['un']
            };
            for (const grupo of Object.values(grupos)) {
                if (grupo.includes(unidade)) return grupo;
            }
            return [unidade];
        }

        function calcularCustoInsumo(insumoId, quantidade, unidade) {
            const insumos = window.appState.insumosCache();
            const insumo = insumos.find(i => i.id === insumoId);
            if (!insumo) return 0;
            const precoCompra = parseFloat(insumo.precoCompra);
            const qtdCompra = parseFloat(insumo.qtdCompra);
            const unidadeCompra = insumo.unidadeCompra;
            const desperdicio = parseFloat(insumo.percentualDesperdicio);
            if (qtdCompra === 0) return 0;
            const rendimento = 1 - desperdicio;
            let custoRealTotal = rendimento > 0 ? precoCompra / rendimento : precoCompra;
            // Aplicar índice de cocção se disponível
            if (insumo.indiceCoccao && insumo.indiceCoccao > 0 && insumo.indiceCoccao < 1) {
                custoRealTotal = custoRealTotal / insumo.indiceCoccao;
            }
            // Converter a quantidade da receita para a mesma unidade de compra
            const qtdNaUnidadeCompra = converterUnidade(quantidade, unidade, unidadeCompra);
            if (qtdNaUnidadeCompra === null) {
                console.warn(`Conversão incompatível: receita usa "${unidade}" mas insumo "${insumo.nome}" é comprado em "${unidadeCompra}". Usando quantidade sem conversão.`);
                return (custoRealTotal / qtdCompra) * quantidade;
            }
            return (custoRealTotal / qtdCompra) * qtdNaUnidadeCompra;
        }

        function calcularCustoProduto(produtoId) {
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            if (!produto || !produto.receita) return 0;
            return produto.receita.reduce((total, item) => {
                return total + calcularCustoInsumo(item.insumoId, parseFloat(item.quantidade), item.unidade);
            }, 0);
        }

        function calcularTotaisConfig() {
            const config = window.appState.configCache();
            const totalCustos = (config.custosOperacionais || []).reduce((sum, custo) => sum + (parseFloat(custo.valor) || 0), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;
            const percentual = faturamento > 0 ? (totalCustos / faturamento) : 0;
            document.getElementById('total-custo-operacional').textContent = `R$ ${totalCustos.toFixed(2)}`;
            document.getElementById('percentual-custo-operacional').textContent = `${(percentual * 100).toFixed(2)}%`;
        }
        let ultimoCalculo = {};
        window.calcularPrecos = function() {
            const produtoId = document.getElementById('produto-select').value;
            const margemLucroRaw = parseFloat(document.getElementById('margem-lucro-input').value);
            if (!produtoId) {
                alert("Por favor, selecione um produto.");
                return;
            }
            if (isNaN(margemLucroRaw) || margemLucroRaw <= 0 || margemLucroRaw >= 100) {
                alert("A margem de lucro deve ser entre 1% e 99%.");
                return;
            }
            const margemLucro = margemLucroRaw / 100;
            const config = window.appState.configCache();
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            const custoInsumos = calcularCustoProduto(produtoId);
            const custoEmbalagens = calcularCustoEmbalagensProduto(produtoId);
            const totalCustosOp = (config.custosOperacionais || []).reduce((sum, c) => sum + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal);
            if (!faturamento || faturamento <= 0) {
                alert("Configure o Faturamento Médio Mensal nas Configurações antes de calcular preços.");
                return;
            }
            const custoOpPercentual = totalCustosOp / faturamento;
            const denominadorBase = 1 - custoOpPercentual - margemLucro;
            if (denominadorBase <= 0) {
                alert(`Erro: A soma do Custo Operacional (${(custoOpPercentual * 100).toFixed(2)}%) e da Margem de Lucro (${(margemLucro * 100).toFixed(2)}%) não pode ser maior ou igual a 100%.`);
                return;
            }
            // Markup apenas sobre insumos; embalagem é repasse direto
            const precoVendaBase = (custoInsumos / denominadorBase) + custoEmbalagens;
            const custoProduto = custoInsumos + custoEmbalagens;
            const resumoContainer = document.getElementById('resumo-produto');
            const embalagemInfo = custoEmbalagens > 0 ? `
                    <div><p class="text-sm text-gray-500">Custo Insumos</p><p class="font-bold text-lg text-gray-800">R$ ${custoInsumos.toFixed(2)}</p></div>
                    <div><p class="text-sm text-gray-500">Embalagem (repasse)</p><p class="font-bold text-lg text-indigo-600">R$ ${custoEmbalagens.toFixed(2)}</p></div>` : `
                    <div><p class="text-sm text-gray-500">Custo dos Insumos</p><p class="font-bold text-lg text-gray-800">R$ ${custoInsumos.toFixed(2)}</p></div>`;
            resumoContainer.innerHTML = `
                <h3 class="text-xl font-bold mb-2 text-indigo-800">${produto.nome}</h3>
                <div class="grid grid-cols-2 md:grid-cols-${custoEmbalagens > 0 ? '5' : '4'} gap-4 text-center">
                    ${embalagemInfo}
                    <div><p class="text-sm text-gray-500">Custo Operacional</p><p class="font-bold text-lg text-gray-800">${(custoOpPercentual * 100).toFixed(2)}%</p></div>
                    <div><p class="text-sm text-gray-500">Margem de Lucro</p><p class="font-bold text-lg text-gray-800">${(margemLucro * 100).toFixed(2)}%</p></div>
                    <div><p class="text-sm text-gray-500">Preço Base (Balcão)</p><p class="font-bold text-lg text-green-600">R$ ${precoVendaBase.toFixed(2)}</p></div>
                </div>
                ${custoEmbalagens > 0 ? '<p class="text-xs text-gray-400 mt-2 text-center"><i class="fas fa-info-circle mr-1"></i>Embalagem somada como repasse direto, sem markup.</p>' : ''}
            `;
            const tabelaContainer = document.getElementById('tabela-precos');
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Canal de Venda</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxas Totais</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço de Venda Final</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Você Recebe</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lucro (R$)</th>
                        <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Análise IA</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            ultimoCalculo = {
                produtoId: produto.id,
                produtoNome: produto.nome,
                custoProduto: custoProduto,
                custoInsumos: custoInsumos,
                custoEmbalagens: custoEmbalagens,
                custoOpPercentual: custoOpPercentual,
                margemLucro: margemLucro,
                canais: {}
            };
            (config.canaisVenda || []).forEach(canal => {
                const taxaComissao = parseFloat(canal.taxaComissao);
                const taxaTransacao = parseFloat(canal.taxaTransacao);
                const taxasTotais = taxaComissao + taxaTransacao;

                // Markup divisor apenas sobre insumos; embalagem é repasse direto
                const denominadorCanal = 1 - taxasTotais - custoOpPercentual - margemLucro;
                const inviavel = denominadorCanal <= 0;
                const precoFinal = inviavel ? 0 : (custoInsumos / denominadorCanal) + custoEmbalagens;
                const recebidoCanal = precoFinal * (1 - taxasTotais);
                const custoOpPorPrato = precoFinal * custoOpPercentual;
                const lucroCanal = recebidoCanal - custoInsumos - custoEmbalagens - custoOpPorPrato;

                ultimoCalculo.canais[canal.nome] = {
                    precoFinal: precoFinal,
                    taxasPercentual: taxasTotais,
                    taxaComissao: taxaComissao,
                    taxaTransacao: taxaTransacao,
                    liquidoOriginal: recebidoCanal,
                    lucro: lucroCanal,
                    custoOpPorPrato: custoOpPorPrato,
                    inviavel: inviavel
                };
                const tr = document.createElement('tr');
                if (inviavel) {
                    tr.innerHTML = `
                        <td class="py-4 px-6 whitespace-nowrap font-medium text-gray-900">${canal.nome}</td>
                        <td class="py-4 px-6 whitespace-nowrap text-gray-500">${(taxasTotais * 100).toFixed(2)}%</td>
                        <td class="py-4 px-6 text-red-600 font-bold" colspan="3">
                            Inviável (Taxas ${(taxasTotais*100).toFixed(1)}% + Custo Op. ${(custoOpPercentual*100).toFixed(1)}% + Margem ${(margemLucro*100).toFixed(1)}% &ge; 100%)
                        </td>
                        <td></td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td class="py-4 px-6 whitespace-nowrap font-medium text-gray-900">${canal.nome}</td>
                        <td class="py-4 px-6 whitespace-nowrap text-gray-500">${(taxasTotais * 100).toFixed(2)}%</td>
                        <td class="py-4 px-6 whitespace-nowrap font-bold text-xl text-indigo-600">R$ ${precoFinal.toFixed(2)}</td>
                        <td class="py-4 px-6 whitespace-nowrap text-blue-600 font-semibold">R$ ${recebidoCanal.toFixed(2)}</td>
                        <td class="py-4 px-6 whitespace-nowrap font-bold text-green-600">R$ ${lucroCanal.toFixed(2)}</td>
                        <td class="py-4 px-6 whitespace-nowrap text-center">
                            <button onclick="analisarPrecoComIA('${produto.id}', '${canal.nome}', ${precoFinal}, this)" class="bg-purple-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-purple-600 transition-colors">
                                ✨ Analisar Preço
                            </button>
                        </td>
                    `;
                }
                tbody.appendChild(tr);
            });
            tabelaContainer.innerHTML = '';
            tabelaContainer.appendChild(table);
            document.getElementById('resultado-precificacao').classList.remove('hidden');
            document.getElementById('analise-ia-container').classList.add('hidden');
            document.getElementById('resultado-promocao').classList.add('hidden');
            document.getElementById('resultado-frete').classList.add('hidden');
        }
        window.gerarDescricaoProduto = async function(button) {
            const form = document.getElementById('form-produto');
            const nomeProduto = form.nome.value;
            const errorContainer = document.getElementById('descricao-ia-error');
            errorContainer.textContent = '';
            if (!nomeProduto) {
                alert("Por favor, insira um nome para o produto primeiro.");
                return;
            }
            const insumos = window.appState.insumosCache();
            const nomesIngredientes = window.tempReceita
                .map(item => insumos.find(i => i.id === item.insumoId)?.nome)
                .filter(Boolean)
                .join(', ');
            if (!nomesIngredientes) {
                alert("Adicione ingredientes à receita para gerar uma descrição.");
                return;
            }
            const prompt = `Crie uma descrição de marketing curta, apetitosa e vendedora para um prato chamado "${nomeProduto}". Os ingredientes principais são: ${nomesIngredientes}. A descrição deve ser ideal para um cardápio de delivery como o iFood.`;
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span> Gerando...`;
            try {
                const descricao = await callGeminiAPI(prompt);
                form.descricao.value = descricao.replace(/"/g, '');
            } catch (error) {
                errorContainer.textContent = `Erro: ${error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = `✨ Gerar Descrição com IA`;
            }
        }
        window.analisarPrecoComIA = async function(produtoId, nomeCanal, precoFinal, button) {
            const produtos = window.appState.produtosCache();
            const insumos = window.appState.insumosCache();
            const produto = produtos.find(p => p.id === produtoId);
            const custoProduto = calcularCustoProduto(produtoId);
            const nomesIngredientes = (produto.receita || [])
                .map(item => insumos.find(i => i.id === item.insumoId)?.nome)
                .filter(Boolean)
                .join(', ');
            const prompt = `Sou dono de um restaurante em Manaus, Amazonas, Brasil. Estou precificando um produto chamado "${produto.nome}". O custo dos ingredientes é R$ ${custoProduto.toFixed(2)} e o preço final de venda no canal "${nomeCanal}" será R$ ${precoFinal.toFixed(2)}. Os ingredientes são: ${nomesIngredientes}. Faça uma breve análise: este preço é competitivo para o mercado de delivery em Manaus? Sugira um preço ideal ou faixa de preço e justifique sua resposta considerando os ingredientes (se são regionais ou comuns), o tipo de prato e o público local. Seja conciso e direto.`;
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span>`;
            const analiseContainer = document.getElementById('analise-ia-container');
            const analiseContent = document.getElementById('analise-ia-content');
            analiseContent.innerHTML = `<div class="flex items-center justify-center p-4"><span class="spinner"></span>Analisando...</div>`;
            analiseContainer.classList.remove('hidden');
            try {
                const analise = await callGeminiAPI(prompt);
                analiseContent.innerText = analise;
            } catch (error) {
                analiseContent.innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
                button.innerHTML = `✨ Analisar Preço`;
            }
        }

        window.analisarMercadoComIA = async function(button) {
            if (!ultimoCalculo || !ultimoCalculo.produtoId) {
                alert("Calcule o preço de um produto primeiro antes de analisar o mercado.");
                return;
            }
            const produtos = window.appState.produtosCache();
            const insumos = window.appState.insumosCache();
            const config = window.appState.configCache();
            const produto = produtos.find(p => p.id === ultimoCalculo.produtoId);
            if (!produto) { alert("Produto não encontrado."); return; }

            const custoProduto = calcularCustoProduto(produto.id);
            const receitaDetalhada = (produto.receita || []).map(item => {
                const ins = insumos.find(i => i.id === item.insumoId);
                if (!ins) return null;
                const custoUnit = calcularCustoInsumo(item.insumoId, parseFloat(item.quantidade), item.unidade);
                return `${ins.nome}: ${item.quantidade}${item.unidade} (custo: R$${custoUnit.toFixed(2)})`;
            }).filter(Boolean).join('\n   - ');

            const canaisInfo = Object.entries(ultimoCalculo.canais || {}).map(([nome, dados]) =>
                `${nome}: Preço R$${dados.precoFinal.toFixed(2)}, Taxas ${(dados.taxasPercentual * 100).toFixed(1)}%`
            ).join('\n   - ');

            const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;
            const totalCustosOp = (config.custosOperacionais || []).reduce((s, c) => s + (parseFloat(c.valor) || 0), 0);
            const margemInput = parseFloat(document.getElementById('margem-lucro-input')?.value) || 30;

            const canalPrincipal = (config.canaisVenda || []).find(c => c.nome?.toLowerCase().includes('ifood'));
            const taxaIfood = canalPrincipal ? `Comissão: ${(parseFloat(canalPrincipal.taxaComissao) * 100).toFixed(1)}%, Transação: ${(parseFloat(canalPrincipal.taxaTransacao) * 100).toFixed(1)}%` : 'Não configurado';

            const systemInstruction = `Atue como: Analista de Mercado Sênior e Especialista em Pricing Estratégico, com foco no mercado de Manaus/AM e plataformas de delivery (iFood).

Sua Missão:
1. Pesquisa em Tempo Real (Grounding): Utilize a busca do Google para encontrar o preço médio de mercado do produto especificamente em Manaus. Procure em grandes redes (DB, Assaí, Atacadão) e nos principais players do iFood na região.
2. Análise de Insumos: Pesquise o custo atual dos insumos (considerando os pesos informados) nos atacados de Manaus para calcular o CMV (Custo de Mercadoria Vendida) base.
3. SEO e Copywriting: Crie um Título de alta conversão (usando palavras-chave mais buscadas no iFood Manaus) e uma Descrição persuasiva que destaque o conceito de "Qualidade de Primeira".
4. Cálculo Financeiro: Com base nos parâmetros fornecidos (Faturamento, Despesas Fixas, Lucro Desejado, Taxas da Loja), aplique a fórmula de Markup para sugerir o preço de venda ideal.

Diretrizes de Resposta (Output):
- Resumo de Mercado: Apresente uma tabela comparativa com os preços dos 3 principais concorrentes encontrados em Manaus.
- Análise de Preço Atual: Compare o preço do usuário com a média encontrada e diga se está perdendo margem ou competitividade.
- Otimização de Anúncio: Título sugerido (Focado em SEO local) e Descrição (Enfatizando o padrão 'Tudo de Primeira').
- Sugestão de Preço Técnico: Cálculo detalhado considerando CMV + Taxas + Custo Fixo + Margem de Lucro. Veredito final com o preço recomendado para o iFood.

IMPORTANTE: Formate a resposta em Markdown. Use tabelas, negrito, e seções claras. Seja detalhado mas objetivo.`;

            const userPrompt = `Analise o seguinte produto do meu restaurante em Manaus/AM:

**Produto:** ${produto.nome}
**Descrição atual:** ${produto.descricao || 'Sem descrição'}

**Insumos/Pesos (Ficha Técnica):**
   - ${receitaDetalhada || 'Sem receita cadastrada'}

**CMV (Custo dos Insumos):** R$ ${custoProduto.toFixed(2)}

**Preços calculados por canal:**
   - ${canaisInfo || 'Nenhum canal configurado'}

**Configurações da Loja:**
   - Faturamento Médio Mensal: R$ ${faturamento.toFixed(2)}
   - Custos Fixos Mensais: R$ ${totalCustosOp.toFixed(2)}
   - Margem de Lucro Desejada: ${margemInput}%
   - Taxas iFood: ${taxaIfood}

Faça a análise completa de mercado conforme suas instruções.`;

            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span> Pesquisando mercado...`;
            const contentDiv = document.getElementById('analise-mercado-content');
            const resultDiv = document.getElementById('analise-mercado-resultado');
            const fontesDiv = document.getElementById('analise-mercado-fontes');
            const fontesLista = document.getElementById('analise-mercado-fontes-lista');
            contentDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 text-center">
                    <span class="spinner mb-3" style="width:40px;height:40px;border-width:4px;"></span>
                    <p class="text-purple-700 font-semibold text-lg">Pesquisando preços em Manaus...</p>
                    <p class="text-gray-500 text-sm mt-1">A IA está consultando o Google em tempo real para encontrar concorrentes e preços atuais.</p>
                </div>`;
            fontesDiv.classList.add('hidden');

            try {
                const resultado = await callGeminiWithSearch(userPrompt, systemInstruction);
                let html = resultado.text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^### (.*$)/gm, '<h3 class="text-lg font-bold text-gray-800 mt-4 mb-2">$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold text-purple-800 mt-5 mb-3 pb-2 border-b border-purple-200">$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold text-purple-900 mt-5 mb-3">$1</h1>')
                    .replace(/^\* (.*$)/gm, '<li class="ml-4 mb-1">$1</li>')
                    .replace(/^- (.*$)/gm, '<li class="ml-4 mb-1">$1</li>')
                    .replace(/(<li.*<\/li>\n?)+/g, '<ul class="list-disc mb-3">$&</ul>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\|(.+)\|/g, function(match) {
                        const cells = match.split('|').filter(c => c.trim());
                        if (cells.every(c => c.trim().match(/^[-:]+$/))) return '<tr class="border-separator"></tr>';
                        const tag = match.includes('---') ? 'th' : 'td';
                        const cellClass = tag === 'th' ? 'bg-purple-50 font-semibold text-purple-800 py-2 px-3 text-sm border border-purple-200' : 'py-2 px-3 text-sm border border-gray-200';
                        return '<tr>' + cells.map(c => `<${tag} class="${cellClass}">${c.trim()}</${tag}>`).join('') + '</tr>';
                    });
                html = html.replace(/<tr class="border-separator"><\/tr>/g, '');
                html = html.replace(/(<tr>.*<\/tr>\s*)+/g, '<div class="overflow-x-auto my-3"><table class="min-w-full border-collapse rounded-lg overflow-hidden">$&</table></div>');

                resultDiv.innerHTML = `<div class="prose max-w-none text-gray-700 leading-relaxed">${html}</div>`;

                if (resultado.grounding) {
                    const chunks = resultado.grounding.groundingChunks || resultado.grounding.searchEntryPoint?.renderedContent ? [] : [];
                    const supports = resultado.grounding.groundingSupports || [];
                    const searchQueries = resultado.grounding.webSearchQueries || [];
                    let fontesHtml = '';
                    if (searchQueries.length > 0) {
                        fontesHtml += '<p class="font-medium text-gray-600 mb-1">Buscas realizadas:</p>';
                        fontesHtml += searchQueries.map(q => `<span class="inline-block bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full mr-1 mb-1">${q}</span>`).join('');
                    }
                    const groundingChunks = resultado.grounding.groundingChunks || [];
                    if (groundingChunks.length > 0) {
                        fontesHtml += '<p class="font-medium text-gray-600 mt-2 mb-1">Sites consultados:</p>';
                        fontesHtml += groundingChunks.filter(c => c.web).map(c =>
                            `<a href="${c.web.uri}" target="_blank" class="block text-indigo-600 hover:text-indigo-800 text-xs underline">${c.web.title || c.web.uri}</a>`
                        ).join('');
                    }
                    if (fontesHtml) {
                        fontesLista.innerHTML = fontesHtml;
                        fontesDiv.classList.remove('hidden');
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                        <p class="text-red-700 font-semibold"><i class="fas fa-exclamation-circle mr-1"></i> Erro na análise de mercado</p>
                        <p class="text-red-600 text-sm mt-1">${error.message}</p>
                        <p class="text-gray-500 text-xs mt-2">Verifique se sua chave API tem acesso ao modelo selecionado e ao Google Search. Tente selecionar "Gemini 2.0 Flash" nas Configurações.</p>
                    </div>`;
            } finally {
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-globe mr-2"></i> Analisar Mercado em Manaus`;
            }
        }

        window.verificarPrecoComIA = async function(button) {
            const form = button.closest('form');
            const nomeInsumo = form.nome.value;
            const resultadoContainer = form.querySelector('#preco-ia-resultado');
            if (!nomeInsumo) {
                alert("Por favor, insira o nome do insumo para verificar o preço.");
                return;
            }
            resultadoContainer.innerHTML = `<div class="flex items-center"><span class="spinner"></span> Pesquisando...</div>`;
            resultadoContainer.classList.remove('hidden');
            button.disabled = true;
            const prompt = `Qual é o preço médio e promoções atuais para "${nomeInsumo}" em supermercados de Manaus, Amazonas, Brasil? Forneça uma faixa de preço por kg, litro ou unidade, conforme aplicável. Se possível, cite nomes de 1 a 2 supermercados com exemplos de preços ou promoções. Seja conciso e direto.`;
            try {
                const resposta = await callGeminiAPI(prompt);
                resultadoContainer.innerText = resposta;
            } catch (error) {
                resultadoContainer.innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        window.sugerirIngredientesComIA = async function(button) {
            const form = button.closest('form');
            const nomeProduto = form.nome.value;
            const errorContainer = form.querySelector('#sugestao-ia-error');
            errorContainer.textContent = '';
            if (!nomeProduto) {
                alert("Por favor, insira o nome do produto para obter sugestões.");
                return;
            }
            const insumosDisponiveis = window.appState.insumosCache();
            if (insumosDisponiveis.length === 0) {
                alert("Cadastre alguns insumos primeiro para que a IA possa fazer sugestões.");
                return;
            }
            const listaDeNomesDeInsumos = insumosDisponiveis.map(i => i.nome).join(', ');
            const prompt = `Você é um assistente de chef. O nome de um prato é '${nomeProduto}'. A seguir está uma lista de todos os insumos disponíveis no meu restaurante: ${listaDeNomesDeInsumos}. Com base no nome do prato, selecione os ingredientes mais comuns para essa receita A PARTIR DA LISTA FORNECIDA. Retorne apenas os nomes dos ingredientes selecionados, separados por vírgula. Não adicione nenhuma outra palavra ou explicação. Exemplo de resposta: Carne, Cebola, Alho, Creme de Leite`;
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span> Sugerindo...`;
            try {
                const resposta = await callGeminiAPI(prompt);
                const nomesSugeridos = resposta.split(',').map(nome => nome.trim().toLowerCase());
                window.tempReceita = []; 
                nomesSugeridos.forEach(nomeSugerido => {
                    const insumoEncontrado = insumosDisponiveis.find(i => i.nome.toLowerCase() === nomeSugerido);
                    if (insumoEncontrado) {
                        window.tempReceita.push({
                            insumoId: insumoEncontrado.id,
                            quantidade: 0,
                            unidade: 'g'
                        });
                    }
                });
                renderReceitaItems();
            } catch (error) {
                errorContainer.textContent = `Erro: ${error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = `✨ Sugerir Ingredientes`;
            }
        }
        window.obterConsultoriaPromocaoIA = async function(button, dadosPromocao) {
            const { nomeProduto, precoOriginal, desconto, subsidio, precoPromocional, novoLiquido, impactoLucro } = dadosPromocao;
            const prompt = `Sou dono de um restaurante em Manaus e estou pensando em participar de uma promoção no iFood para o prato '${nomeProduto}'. O preço normal de venda é R$${precoOriginal.toFixed(2)}. A promoção oferece R$${desconto.toFixed(2)} de desconto ao cliente. O iFood vai subsidiar R$${subsidio.toFixed(2)}. Com isso, o preço promocional será R$${precoPromocional.toFixed(2)} e meu recebimento líquido por venda será R$${novoLiquido.toFixed(2)}, o que representa uma redução de R$${Math.abs(impactoLucro).toFixed(2)} no meu lucro por unidade. Com base nestes números, e considerando o mercado de delivery em Manaus, você acha que vale a pena participar desta campanha? Quais são os prós e contras? Que estratégia devo adotar (ex: focar em volume, tentar fidelizar clientes)? Seja um consultor de negócios e dê uma recomendação clara.`;
            const resultadoContainer = document.getElementById('resultado-promocao');
            resultadoContainer.innerHTML += `<div id="consultoria-ia-promocao" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200"><div class="flex items-center"><span class="spinner"></span>Analisando estratégia...</div></div>`;
            button.disabled = true;
            try {
                const consultoria = await callGeminiAPI(prompt);
                document.getElementById('consultoria-ia-promocao').innerHTML = `<h4 class="font-semibold text-gray-800 mb-2">Consultoria da IA:</h4><p class="text-sm">${consultoria}</p>`;
            } catch (error) {
                document.getElementById('consultoria-ia-promocao').innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro ao obter a consultoria:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        window.obterConsultoriaFreteIA = async function(button, dadosFrete) {
            const { nomeProduto, precoOriginal, novoPreco, custoFreteAbsorvido } = dadosFrete;
            const prompt = `Sou dono de um restaurante em Manaus e estou pensando em oferecer frete com desconto, embutindo o custo no preço do produto '${nomeProduto}'. O preço original de venda é R$${precoOriginal.toFixed(2)}. Para absorver um custo de frete de R$${custoFreteAbsorvido.toFixed(2)}, o novo preço do produto precisaria ser R$${novoPreco.toFixed(2)}. Com base nestes números, e considerando o mercado de delivery em Manaus, você acha que esta é uma boa estratégia? Quais são os prós e contras de aumentar o preço do produto para oferecer um frete mais barato? Que impacto psicológico isso tem no cliente? Seja um consultor de negócios e dê uma recomendação clara.`;
            const resultadoContainer = document.getElementById('resultado-frete');
            resultadoContainer.innerHTML += `<div id="consultoria-ia-frete" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200"><div class="flex items-center"><span class="spinner"></span>Analisando estratégia...</div></div>`;
            button.disabled = true;
            try {
                const consultoria = await callGeminiAPI(prompt);
                document.getElementById('consultoria-ia-frete').innerHTML = `<h4 class="font-semibold text-gray-800 mb-2">Consultoria da IA:</h4><p class="text-sm">${consultoria}</p>`;
            } catch (error) {
                document.getElementById('consultoria-ia-frete').innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro ao obter a consultoria:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        window.sugerirPerdaComIA = async function(button) {
            const form = button.closest('form');
            const nomeInsumo = form.nome.value;
            const resultadoContainer = form.querySelector('#perda-ia-resultado');
            const desperdicioInput = form.percentualDesperdicio;
            if (!nomeInsumo) {
                alert("Por favor, insira o nome do insumo para obter uma sugestão de perda.");
                return;
            }
            resultadoContainer.innerHTML = `<div class="flex items-center"><span class="spinner"></span> Pesquisando sugestão...</div>`;
            resultadoContainer.classList.remove('hidden');
            button.disabled = true;
            const prompt = `Como um consultor de food service, estime o percentual de desperdício médio para o insumo "${nomeInsumo}" durante o pré-preparo em uma cozinha profissional (ex: cascas, sementes, aparas, ossos). Forneça apenas o número do percentual, sem o símbolo '%' ou qualquer texto adicional. Por exemplo, se a estimativa for 15%, retorne apenas "15".`;
            try {
                const resposta = await callGeminiAPI(prompt);
                const percentualSugerido = parseFloat(resposta);
                if (!isNaN(percentualSugerido)) {
                    desperdicioInput.value = percentualSugerido.toFixed(0);
                    resultadoContainer.innerText = `Sugestão da IA: ${percentualSugerido.toFixed(0)}%. O valor foi inserido no campo acima.`;
                } else {
                    resultadoContainer.innerHTML = `<p class="text-orange-600 font-semibold">A IA retornou uma resposta inesperada:</p><p class="text-sm text-gray-700">${resposta}</p>`;
                }
            } catch (error) {
                resultadoContainer.innerHTML = `<p class="text-red-600 font-semibold">Ocorreu um erro:</p><p class="text-sm text-gray-700">${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        function fecharModal() {
            const el = document.getElementById('modal-backdrop');
            el.classList.add('hidden');
            el.style.display = 'none';
        }
        window.tempReceita = [];
        function renderReceitaItems() {
            const container = document.getElementById('receita-container');
            if (!container) return;
            const insumos = window.appState.insumosCache();
            container.innerHTML = ''; 
            window.tempReceita.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'receita-item flex items-center gap-2 mb-2';
                const insumosOptions = insumos.sort((a,b) => a.nome.localeCompare(b.nome))
                                                .map(i => `<option value="${i.id}" ${i.id === item.insumoId ? 'selected' : ''}>${i.nome}</option>`)
                                                .join('');
                const insumoSelecionado = insumos.find(i => i.id === item.insumoId);
                const todasUnidades = ['g', 'kg', 'ml', 'L', 'un'];
                const unidades = insumoSelecionado ? unidadesCompativeis(insumoSelecionado.unidadeCompra || 'un') : todasUnidades;
                if (insumoSelecionado && !unidades.includes(item.unidade)) {
                    item.unidade = unidades[0];
                }
                const unidadesOptions = unidades.map(u => `<option value="${u}" ${u === item.unidade ? 'selected' : ''}>${u}</option>`).join('');
                itemDiv.innerHTML = `
                    <select class="w-1/2 p-2 border border-gray-300 rounded-md" onchange="updateReceitaItem(${index}, 'insumoId', this.value)">
                        <option value="">Selecione um insumo</option>
                        ${insumosOptions}
                    </select>
                    <input type="number" step="0.001" value="${item.quantidade || ''}" onchange="updateReceitaItem(${index}, 'quantidade', this.value)" class="w-1/4 p-2 border border-gray-300 rounded-md" placeholder="Qtd.">
                    <select class="w-1/4 p-2 border border-gray-300 rounded-md" onchange="updateReceitaItem(${index}, 'unidade', this.value)">
                        ${unidadesOptions}
                    </select>
                    <button type="button" onclick="removerReceitaItem(${index})" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(itemDiv);
            });
        }
        window.adicionarReceitaItem = function() {
            window.tempReceita.push({ insumoId: '', quantidade: 0, unidade: 'g' });
            renderReceitaItems(); 
        }
        window.removerReceitaItem = function(index) {
            window.tempReceita.splice(index, 1);
            renderReceitaItems(); 
        }
        window.updateReceitaItem = function(index, field, value) {
            window.tempReceita[index][field] = value;
            if (field === 'insumoId') {
                renderReceitaItems();
            }
        }

        // === EMBALAGENS NO MODAL DE PRODUTO ===
        function renderEmbalagensProduto() {
            const container = document.getElementById('embalagens-produto-container');
            if (!container) return;
            const embalagens = window.appState.embalagensCache();
            if (!embalagens.length) {
                container.innerHTML = `<p class="text-sm text-gray-400 italic">Nenhuma embalagem cadastrada. <a href="javascript:changeTab('embalagens')" class="text-indigo-500 underline">Cadastre embalagens primeiro</a>.</p>`;
                atualizarCustoTotalPreview();
                return;
            }
            container.innerHTML = '';
            embalagens.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(embalagem => {
                const existente = (window.tempEmbalagens || []).find(e => e.embalagemId === embalagem.id);
                const isChecked = existente && existente.quantidade > 0;
                const quantidade = existente ? existente.quantidade : 1;
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 mb-2 p-2 rounded-lg border ' + (isChecked ? 'border-indigo-200 bg-indigo-50' : 'border-gray-200 bg-white');
                div.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleEmbalagemProduto('${embalagem.id}', this.checked)" class="w-4 h-4 text-indigo-600 rounded">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-800">${embalagem.nome}</span>
                        <span class="text-xs text-gray-500 ml-2">R$ ${parseFloat(embalagem.valorUnitario).toFixed(2)}/un</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <label class="text-xs text-gray-500">Qtd:</label>
                        <input type="number" min="1" step="1" value="${quantidade}" ${!isChecked ? 'disabled' : ''}
                            onchange="updateEmbalagemQtd('${embalagem.id}', this.value)"
                            class="w-16 p-1 text-sm border border-gray-300 rounded-md text-center ${!isChecked ? 'bg-gray-100 opacity-50' : ''}">
                    </div>
                    <span class="text-xs font-semibold ${isChecked ? 'text-indigo-600' : 'text-gray-400'}" id="emb-subtotal-${embalagem.id}">
                        R$ ${isChecked ? (parseFloat(embalagem.valorUnitario) * quantidade).toFixed(2) : '0,00'}
                    </span>
                `;
                container.appendChild(div);
            });
            atualizarCustoTotalPreview();
        }

        window.toggleEmbalagemProduto = function(embalagemId, checked) {
            if (!window.tempEmbalagens) window.tempEmbalagens = [];
            if (checked) {
                const existing = window.tempEmbalagens.find(e => e.embalagemId === embalagemId);
                if (!existing) {
                    window.tempEmbalagens.push({ embalagemId: embalagemId, quantidade: 1 });
                } else {
                    existing.quantidade = existing.quantidade || 1;
                }
            } else {
                window.tempEmbalagens = window.tempEmbalagens.filter(e => e.embalagemId !== embalagemId);
            }
            renderEmbalagensProduto();
        }

        window.updateEmbalagemQtd = function(embalagemId, value) {
            if (!window.tempEmbalagens) return;
            const item = window.tempEmbalagens.find(e => e.embalagemId === embalagemId);
            if (item) {
                item.quantidade = parseInt(value) || 1;
                renderEmbalagensProduto();
            }
        }

        function calcularCustoEmbalagensProduto(produtoId) {
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            if (!produto || !produto.embalagens) return 0;
            const embalagens = window.appState.embalagensCache();
            return produto.embalagens.reduce((total, item) => {
                const embalagem = embalagens.find(e => e.id === item.embalagemId);
                if (!embalagem) return total;
                return total + (parseFloat(embalagem.valorUnitario) || 0) * (parseInt(item.quantidade) || 0);
            }, 0);
        }

        function atualizarCustoTotalPreview() {
            const container = document.getElementById('custo-total-preview');
            if (!container) return;
            // Calcular custo de insumos do tempReceita
            let custoInsumos = 0;
            (window.tempReceita || []).forEach(item => {
                if (item.insumoId && item.quantidade > 0) {
                    custoInsumos += calcularCustoInsumo(item.insumoId, parseFloat(item.quantidade), item.unidade);
                }
            });
            // Calcular custo de embalagens do tempEmbalagens
            let custoEmbalagens = 0;
            const embalagens = window.appState.embalagensCache();
            (window.tempEmbalagens || []).forEach(item => {
                const emb = embalagens.find(e => e.id === item.embalagemId);
                if (emb && item.quantidade > 0) {
                    custoEmbalagens += parseFloat(emb.valorUnitario) * parseInt(item.quantidade);
                }
            });
            const custoTotal = custoInsumos + custoEmbalagens;
            container.innerHTML = `
                <div class="flex justify-between items-center text-sm">
                    <div class="flex gap-4">
                        <span class="text-gray-600"><i class="fas fa-carrot text-green-500 mr-1"></i> Insumos: <strong>R$ ${custoInsumos.toFixed(2)}</strong></span>
                        <span class="text-gray-600"><i class="fas fa-box text-indigo-500 mr-1"></i> Embalagens: <strong>R$ ${custoEmbalagens.toFixed(2)}</strong></span>
                    </div>
                    <span class="text-lg font-bold text-gray-800">Total: R$ ${custoTotal.toFixed(2)}</span>
                </div>
            `;
        }

        window.abrirModalInsumo = function(id = null) {
            const insumos = window.appState.insumosCache();
            const insumo = id ? insumos.find(i => i.id === id) : {};
            const modalContent = document.getElementById('modal-content');
            const unidades = ['kg', 'g', 'L', 'ml', 'un'];
            const unidadesOptions = unidades.map(u => `<option value="${u}" ${u === (insumo.unidadeCompra || 'kg') ? 'selected' : ''}>${u}</option>`).join('');
            const categorias = ['proteina', 'carboidrato', 'salada', 'outros'];
            const categoriasLabels = { proteina: 'Proteína', carboidrato: 'Carboidrato', salada: 'Salada', outros: 'Outros' };
            const categoriasOptions = categorias.map(c => `<option value="${c}" ${c === (insumo.categoria || 'outros') ? 'selected' : ''}>${categoriasLabels[c]}</option>`).join('');
            const despVal = (insumo.percentualDesperdicio || 0) * 100;
            const fcVal = despVal < 100 ? (1 / (1 - despVal / 100)).toFixed(2) : '0.00';
            const indiceCoccao = insumo.indiceCoccao !== undefined ? (insumo.indiceCoccao * 100).toFixed(0) : '';
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${id ? 'Editar' : 'Novo'} Insumo</h2>
                <form id="form-insumo" onsubmit="salvarInsumo(event, '${id || ''}')" class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700">Nome do Insumo</label>
                            <button type="button" onclick="verificarPrecoComIA(this)" class="bg-teal-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-teal-600 transition-colors">
                                <i class="fas fa-search-dollar mr-1"></i> Verificar Preços com IA
                            </button>
                        </div>
                        <input type="text" name="nome" value="${insumo.nome || ''}" required class="block w-full p-2 border border-gray-300 rounded-md">
                        <div id="preco-ia-resultado" class="mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-md hidden"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Preço de Compra (R$)</label><input type="number" step="0.01" name="precoCompra" value="${insumo.precoCompra || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Qtd. Compra</label><input type="number" step="0.001" name="qtdCompra" value="${insumo.qtdCompra || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Unidade de Compra</label>
                            <select name="unidadeCompra" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                ${unidadesOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Categoria
                                <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Usado no Montador de Marmita para agrupar por tipo.</span></span>
                            </label>
                            <select name="categoria" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                ${categoriasOptions}
                            </select>
                        </div>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="text-sm font-bold text-blue-800 mb-2"><i class="fas fa-cut mr-1"></i> Fator de Correção (FC) - Pré-preparo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                   <label class="block text-sm font-medium text-gray-700">Desperdício no Pré-preparo (%)
                                       <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Cascas, sementes, ossos, aparas. Ex: 1kg carne com 300g de aparas = 30%.</span></span>
                                   </label>
                                   <button type="button" onclick="sugerirPerdaComIA(this)" class="bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-blue-600 transition-colors">✨ Sugerir Perda</button>
                                </div>
                                <input type="number" name="percentualDesperdicio" value="${despVal}" min="0" max="99" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md" oninput="atualizarFCPreview()">
                                <div id="perda-ia-resultado" class="mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-md hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">FC Calculado</label>
                                <div id="fc-preview" class="mt-1 p-2 bg-white border border-gray-300 rounded-md text-lg font-bold text-indigo-600">${fcVal}</div>
                                <p class="text-xs text-gray-500 mt-1">FC = 1 / (1 - desp%). Ex: FC 1,43 = precisa comprar 43% a mais.</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <h3 class="text-sm font-bold text-orange-800 mb-2"><i class="fas fa-fire mr-1"></i> Índice de Cocção (opcional)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Rendimento após cocção (%)
                                    <span class="tooltip"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltiptext">Quanto sobra após cozinhar. Ex: 1kg de carne assada vira 600g = 60%. Deixe vazio para ignorar.</span></span>
                                </label>
                                <input type="number" name="indiceCoccao" value="${indiceCoccao}" min="1" max="100" placeholder="Ex: 70 (opcional)" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <p class="text-xs text-gray-500 mt-1">Carnes gordurosas: 40-50% | Carnes magras: 60-70% | Legumes: 80-90%</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Custo Real Estimado</label>
                                <div id="custo-real-preview" class="mt-1 p-2 bg-white border border-gray-300 rounded-md text-lg font-bold text-green-600">
                                    R$ ${(parseFloat(insumo.precoCompra || 0) / (1 - (insumo.percentualDesperdicio || 0))).toFixed(2)}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Preço com FC aplicado (e cocção, se informada).</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4"><button type="button" onclick="fecharModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar</button></div>
                </form>
            `;
            const _mb = document.getElementById('modal-backdrop');
            _mb.classList.remove('hidden');
            _mb.style.display = 'flex';
        }
        window.abrirModalProduto = function(id = null) {
            const produtos = window.appState.produtosCache();
            const produto = id ? produtos.find(p => p.id === id) : { receita: [], descricao: '', imagemUrl: '', embalagens: [] };
            window.tempReceita = JSON.parse(JSON.stringify(produto.receita || []));
            window.tempEmbalagens = JSON.parse(JSON.stringify(produto.embalagens || []));
            window.tempImagemUrl = produto.imagemUrl || '';
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">${id ? 'Editar' : 'Novo'} Produto</h2>
                <form id="form-produto" onsubmit="salvarProduto(event, '${id || ''}')" class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <button type="button" onclick="sugerirIngredientesComIA(this)" class="bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-blue-600 transition-colors">✨ Sugerir Ingredientes</button>
                        </div>
                        <input type="text" name="nome" value="${produto.nome || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <div id="sugestao-ia-error" class="text-xs text-red-600 mt-1"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Descrição para Cardápio</label>
                            <button type="button" onclick="gerarDescricaoProduto(this)" class="bg-purple-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-purple-600 transition-colors">✨ Gerar Descrição com IA</button>
                        </div>
                        <div id="descricao-ia-error" class="text-xs text-red-600 mt-1"></div>
                        <textarea name="descricao" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Suculento filé de pirarucu na brasa...">${produto.descricao || ''}</textarea>
                    </div>
                    <!-- Secao de Foto do Produto -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-camera mr-1"></i> Foto do Produto</label>
                        <div class="flex flex-col sm:flex-row gap-3 items-start">
                            <div id="produto-foto-preview" class="w-32 h-32 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 flex-shrink-0">
                                ${produto.imagemUrl
                                    ? `<img src="${produto.imagemUrl}" class="w-full h-full object-cover rounded-lg">`
                                    : `<div class="text-center text-gray-400 text-xs p-2"><i class="fas fa-image text-2xl mb-1 block"></i>Sem foto</div>`}
                            </div>
                            <div class="flex flex-col gap-2 w-full">
                                <label class="bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors cursor-pointer text-center">
                                    <i class="fas fa-upload mr-1"></i> Enviar Foto
                                    <input type="file" accept="image/*" onchange="uploadFotoProduto(event)" class="hidden">
                                </label>
                                <button type="button" onclick="gerarFotoComIA()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-colors">
                                    <i class="fas fa-magic mr-1"></i> Gerar Foto com IA
                                </button>
                                ${produto.imagemUrl ? `<button type="button" onclick="removerFotoProduto()" class="text-red-500 text-xs hover:text-red-700 underline">Remover foto</button>` : ''}
                                <div id="foto-ia-status" class="text-xs text-gray-500"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Receita (Ficha Técnica)</h3>
                        <div id="receita-container"></div>
                        <button type="button" onclick="adicionarReceitaItem()" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Adicionar ingrediente</button>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2"><i class="fas fa-box text-indigo-500 mr-1"></i> Embalagens do Produto</h3>
                        <p class="text-xs text-gray-500 mb-2">Marque as embalagens usadas neste produto e informe a quantidade de cada uma.</p>
                        <div id="embalagens-produto-container"></div>
                    </div>
                    <div id="custo-total-preview" class="p-3 bg-gray-50 border border-gray-200 rounded-lg"></div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" onclick="fecharModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar</button>
                    </div>
                </form>
            `;
            renderReceitaItems();
            renderEmbalagensProduto();
            const _mb = document.getElementById('modal-backdrop');
            _mb.classList.remove('hidden');
            _mb.style.display = 'flex';
        }
        window.atualizarFCPreview = function() {
            const form = document.getElementById('form-insumo');
            if (!form) return;
            const desp = parseFloat(form.percentualDesperdicio.value) || 0;
            const preco = parseFloat(form.precoCompra?.value) || 0;
            const qtd = parseFloat(form.qtdCompra?.value) || 1;
            const ic = parseFloat(form.indiceCoccao?.value) || 0;
            const rendimento = 1 - desp / 100;
            const fc = rendimento > 0 ? (1 / rendimento) : 0;
            const fcPreview = document.getElementById('fc-preview');
            if (fcPreview) {
                fcPreview.textContent = fc.toFixed(2);
                fcPreview.className = 'mt-1 p-2 bg-white border border-gray-300 rounded-md text-lg font-bold ' +
                    (fc > 1.5 ? 'text-red-600' : fc > 1.2 ? 'text-yellow-600' : 'text-green-600');
            }
            const custoPreview = document.getElementById('custo-real-preview');
            if (custoPreview && preco > 0) {
                let custoReal = rendimento > 0 ? preco / rendimento : preco;
                if (ic > 0 && ic < 100) custoReal = custoReal / (ic / 100);
                custoPreview.textContent = `R$ ${custoReal.toFixed(2)}`;
            }
        }

        window.salvarInsumo = async function(event, id) {
            event.preventDefault();
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            const form = document.getElementById('form-insumo');
            const indiceCoccaoVal = parseFloat(form.indiceCoccao?.value);
            const data = {
                nome: form.nome.value,
                precoCompra: parseFloat(form.precoCompra.value),
                qtdCompra: parseFloat(form.qtdCompra.value),
                unidadeCompra: form.unidadeCompra.value,
                percentualDesperdicio: parseFloat(form.percentualDesperdicio.value) / 100,
                categoria: form.categoria.value || 'outros'
            };
            if (!isNaN(indiceCoccaoVal) && indiceCoccaoVal > 0) {
                data.indiceCoccao = indiceCoccaoVal / 100;
            } else {
                data.indiceCoccao = null;
            }
            try {
                const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
                const collectionRef = getCollectionRef('insumos');
                if (id) {
                    await updateDoc(doc(collectionRef, id), data);
                } else {
                    await addDoc(collectionRef, data);
                }
                fecharModal();
            } catch (e) {
                console.error("Erro ao salvar insumo: ", e);
                alert("Ocorreu um erro ao salvar o insumo. Verifique sua conexão e os dados inseridos.");
            }
        }
        // === MONTADOR DE MARMITA ===
        window.montadorState = {
            proteinas: [],
            carboidratos: [],
            saladas: [],
            embalagens: []
        };

        function renderMontador() {
            renderMontadorComponentes('proteina', 'montador-proteinas');
            renderMontadorComponentes('carboidrato', 'montador-carboidratos');
            renderMontadorComponentes('salada', 'montador-saladas');
            renderMontadorEmbalagens();
            calcularMontador();
        }

        function renderMontadorComponentes(categoria, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const stateKey = categoria === 'proteina' ? 'proteinas' : categoria === 'carboidrato' ? 'carboidratos' : 'saladas';
            const items = window.montadorState[stateKey];
            const insumos = window.appState.insumosCache().filter(i => (i.categoria || 'outros') === categoria).sort((a,b) => a.nome.localeCompare(b.nome));

            if (!items.length) {
                container.innerHTML = `<p class="text-sm text-gray-400 italic">Nenhum item adicionado.</p>`;
                return;
            }

            container.innerHTML = '';
            items.forEach((item, index) => {
                const options = insumos.map(i => `<option value="${i.id}" ${i.id === item.insumoId ? 'selected' : ''}>${i.nome}</option>`).join('');
                const insumoSel = insumos.find(i => i.id === item.insumoId);
                const unidadeCompra = insumoSel ? insumoSel.unidadeCompra : 'g';
                const custoItem = item.insumoId ? calcularCustoInsumo(item.insumoId, parseFloat(item.peso) || 0, item.unidade || 'g') : 0;

                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-2 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <select onchange="updateMontadorItem('${stateKey}', ${index}, 'insumoId', this.value)" class="flex-1 p-2 border border-gray-300 rounded-md text-sm">
                        <option value="">Selecione...</option>
                        ${options}
                    </select>
                    <input type="number" step="1" min="1" value="${item.peso || ''}" onchange="updateMontadorItem('${stateKey}', ${index}, 'peso', this.value)" class="w-20 p-2 border border-gray-300 rounded-md text-sm text-center" placeholder="Peso">
                    <span class="text-xs text-gray-500 w-6">${item.unidade || 'g'}</span>
                    <span class="text-xs font-semibold text-gray-700 w-20 text-right">R$ ${custoItem.toFixed(2)}</span>
                    <button onclick="removerMontadorItem('${stateKey}', ${index})" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(div);
            });

            if (!insumos.length) {
                container.innerHTML += `<p class="text-xs text-orange-500 mt-1"><i class="fas fa-exclamation-triangle mr-1"></i>Nenhum insumo com categoria "${categoria}" cadastrado. Edite seus insumos e atribua a categoria.</p>`;
            }
        }

        function renderMontadorEmbalagens() {
            const container = document.getElementById('montador-embalagens');
            if (!container) return;
            const embalagens = window.appState.embalagensCache();
            if (!embalagens.length) {
                container.innerHTML = `<p class="text-sm text-gray-400 italic">Nenhuma embalagem cadastrada.</p>`;
                return;
            }
            container.innerHTML = '';
            embalagens.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(emb => {
                const existente = window.montadorState.embalagens.find(e => e.embalagemId === emb.id);
                const isChecked = existente && existente.quantidade > 0;
                const qtd = existente ? existente.quantidade : 1;
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-2 rounded-lg border ' + (isChecked ? 'border-indigo-200 bg-indigo-50' : 'border-gray-200 bg-white');
                div.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleMontadorEmbalagem('${emb.id}', this.checked)" class="w-4 h-4 text-indigo-600 rounded">
                    <span class="flex-1 text-sm font-medium text-gray-800">${emb.nome}</span>
                    <span class="text-xs text-gray-500">R$ ${parseFloat(emb.valorUnitario).toFixed(2)}/un</span>
                    <input type="number" min="1" step="1" value="${qtd}" ${!isChecked ? 'disabled' : ''} onchange="updateMontadorEmbalagemQtd('${emb.id}', this.value)" class="w-14 p-1 text-sm border border-gray-300 rounded-md text-center ${!isChecked ? 'bg-gray-100 opacity-50' : ''}">
                    <span class="text-xs font-semibold ${isChecked ? 'text-indigo-600' : 'text-gray-400'} w-16 text-right">R$ ${isChecked ? (parseFloat(emb.valorUnitario) * qtd).toFixed(2) : '0,00'}</span>
                `;
                container.appendChild(div);
            });
        }

        window.adicionarComponenteMontador = function(categoria) {
            const stateKey = categoria === 'proteina' ? 'proteinas' : categoria === 'carboidrato' ? 'carboidratos' : 'saladas';
            const unidadePadrao = categoria === 'salada' ? 'g' : 'g';
            window.montadorState[stateKey].push({ insumoId: '', peso: '', unidade: unidadePadrao });
            renderMontador();
        }

        window.updateMontadorItem = function(stateKey, index, field, value) {
            window.montadorState[stateKey][index][field] = value;
            if (field === 'insumoId') {
                // Atualizar unidade baseada no insumo selecionado
                const insumo = window.appState.insumosCache().find(i => i.id === value);
                if (insumo) {
                    const uc = insumo.unidadeCompra;
                    // Usar a menor unidade compatível para porções
                    if (uc === 'kg') window.montadorState[stateKey][index].unidade = 'g';
                    else if (uc === 'L') window.montadorState[stateKey][index].unidade = 'ml';
                    else window.montadorState[stateKey][index].unidade = uc;
                }
            }
            renderMontador();
        }

        window.removerMontadorItem = function(stateKey, index) {
            window.montadorState[stateKey].splice(index, 1);
            renderMontador();
        }

        window.toggleMontadorEmbalagem = function(embalagemId, checked) {
            if (checked) {
                const existing = window.montadorState.embalagens.find(e => e.embalagemId === embalagemId);
                if (!existing) {
                    window.montadorState.embalagens.push({ embalagemId, quantidade: 1 });
                }
            } else {
                window.montadorState.embalagens = window.montadorState.embalagens.filter(e => e.embalagemId !== embalagemId);
            }
            renderMontador();
        }

        window.updateMontadorEmbalagemQtd = function(embalagemId, value) {
            const item = window.montadorState.embalagens.find(e => e.embalagemId === embalagemId);
            if (item) item.quantidade = parseInt(value) || 1;
            renderMontador();
        }

        window.calcularMontador = function() {
            const resumoContainer = document.getElementById('montador-resumo');
            const canaisContainer = document.getElementById('montador-canais');
            if (!resumoContainer || !canaisContainer) return;

            // Calcular custos de cada categoria
            let custoProteinas = 0, custoCarboidratos = 0, custoSaladas = 0, custoEmbalagens = 0;

            window.montadorState.proteinas.forEach(item => {
                if (item.insumoId && item.peso > 0) custoProteinas += calcularCustoInsumo(item.insumoId, parseFloat(item.peso), item.unidade || 'g');
            });
            window.montadorState.carboidratos.forEach(item => {
                if (item.insumoId && item.peso > 0) custoCarboidratos += calcularCustoInsumo(item.insumoId, parseFloat(item.peso), item.unidade || 'g');
            });
            window.montadorState.saladas.forEach(item => {
                if (item.insumoId && item.peso > 0) custoSaladas += calcularCustoInsumo(item.insumoId, parseFloat(item.peso), item.unidade || 'g');
            });

            const embalagensCache = window.appState.embalagensCache();
            window.montadorState.embalagens.forEach(item => {
                const emb = embalagensCache.find(e => e.id === item.embalagemId);
                if (emb) custoEmbalagens += parseFloat(emb.valorUnitario) * (parseInt(item.quantidade) || 1);
            });

            const custoInsumos = custoProteinas + custoCarboidratos + custoSaladas;
            const custoTotal = custoInsumos + custoEmbalagens;

            if (custoTotal === 0) {
                resumoContainer.innerHTML = `<p class="text-center text-gray-400 text-sm">Selecione os componentes para ver o resumo</p>`;
                canaisContainer.innerHTML = `<p class="text-center text-gray-400 text-sm">-</p>`;
                return;
            }

            resumoContainer.innerHTML = `
                <div class="space-y-1 text-sm">
                    ${custoProteinas > 0 ? `<div class="flex justify-between"><span class="text-red-600"><i class="fas fa-drumstick-bite mr-1"></i>Proteínas</span><span class="font-semibold">R$ ${custoProteinas.toFixed(2)}</span></div>` : ''}
                    ${custoCarboidratos > 0 ? `<div class="flex justify-between"><span class="text-yellow-600"><i class="fas fa-bread-slice mr-1"></i>Carboidratos</span><span class="font-semibold">R$ ${custoCarboidratos.toFixed(2)}</span></div>` : ''}
                    ${custoSaladas > 0 ? `<div class="flex justify-between"><span class="text-green-600"><i class="fas fa-leaf mr-1"></i>Saladas</span><span class="font-semibold">R$ ${custoSaladas.toFixed(2)}</span></div>` : ''}
                    <div class="border-t border-gray-200 pt-1 flex justify-between"><span class="text-gray-600 font-medium">Subtotal Insumos</span><span class="font-bold">R$ ${custoInsumos.toFixed(2)}</span></div>
                    ${custoEmbalagens > 0 ? `<div class="flex justify-between"><span class="text-indigo-600"><i class="fas fa-box mr-1"></i>Embalagens (repasse)</span><span class="font-semibold">R$ ${custoEmbalagens.toFixed(2)}</span></div>` : ''}
                    <div class="border-t-2 border-gray-300 pt-2 flex justify-between text-base"><span class="font-bold text-gray-800">Custo Total</span><span class="font-bold text-gray-800">R$ ${custoTotal.toFixed(2)}</span></div>
                </div>
            `;

            // Calcular preço por canal
            const config = window.appState.configCache();
            const margemRaw = parseFloat(document.getElementById('montador-margem')?.value) || 30;
            const margem = margemRaw / 100;
            const totalCustosOp = (config.custosOperacionais || []).reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;

            if (!faturamento || faturamento <= 0) {
                canaisContainer.innerHTML = `<p class="text-center text-orange-500 text-xs"><i class="fas fa-exclamation-triangle mr-1"></i>Configure o Faturamento Mensal em Configurações.</p>`;
                return;
            }

            const custoOpPerc = totalCustosOp / faturamento;
            const canais = config.canaisVenda || [];

            if (!canais.length) {
                canaisContainer.innerHTML = `<p class="text-center text-orange-500 text-xs"><i class="fas fa-exclamation-triangle mr-1"></i>Configure os Canais de Venda em Configurações.</p>`;
                return;
            }

            let canaisHtml = '';
            canais.forEach(canal => {
                const taxas = parseFloat(canal.taxaComissao) + parseFloat(canal.taxaTransacao);
                const denom = 1 - taxas - custoOpPerc - margem;
                if (denom <= 0) {
                    canaisHtml += `<div class="flex justify-between items-center p-2 bg-red-50 rounded-lg"><span class="text-sm font-medium text-gray-700">${canal.nome}</span><span class="text-xs text-red-600 font-semibold">Inviável</span></div>`;
                } else {
                    const preco = (custoInsumos / denom) + custoEmbalagens;
                    const recebido = preco * (1 - taxas);
                    const lucro = recebido - custoInsumos - custoEmbalagens - (preco * custoOpPerc);
                    canaisHtml += `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">${canal.nome}</span>
                                <span class="text-xl font-bold text-indigo-600">R$ ${preco.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Taxas: ${(taxas * 100).toFixed(1)}%</span>
                                <span>Recebe: R$ ${recebido.toFixed(2)}</span>
                                <span class="text-green-600 font-semibold">Lucro: R$ ${lucro.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }
            });
            canaisContainer.innerHTML = canaisHtml;
        }

        window.limparMontador = function() {
            window.montadorState = { proteinas: [], carboidratos: [], saladas: [], embalagens: [] };
            renderMontador();
        }

        window.salvarMontadorComoProduto = async function() {
            if (!window.appState.isReady) {
                alert("Aguarde a conexão com o banco de dados.");
                return;
            }

            // Montar a receita a partir dos componentes
            const receita = [];
            ['proteinas', 'carboidratos', 'saladas'].forEach(key => {
                window.montadorState[key].forEach(item => {
                    if (item.insumoId && item.peso > 0) {
                        receita.push({ insumoId: item.insumoId, quantidade: parseFloat(item.peso), unidade: item.unidade || 'g' });
                    }
                });
            });

            if (!receita.length) {
                alert("Adicione pelo menos um ingrediente antes de salvar.");
                return;
            }

            const embalagens = window.montadorState.embalagens.filter(e => e.embalagemId && e.quantidade > 0);

            // Montar nome sugerido
            const insumos = window.appState.insumosCache();
            const proteina = window.montadorState.proteinas.find(p => p.insumoId);
            const nomeProt = proteina ? insumos.find(i => i.id === proteina.insumoId)?.nome || '' : '';
            const nomeSugerido = nomeProt ? `Marmita - ${nomeProt}` : 'Marmita';

            const nome = prompt("Nome do produto:", nomeSugerido);
            if (!nome) return;

            const data = {
                nome: nome,
                descricao: '',
                imagemUrl: '',
                receita: receita,
                embalagens: embalagens
            };

            try {
                const { getCollectionRef, addDoc } = window.appState;
                const collectionRef = getCollectionRef('produtos');
                await addDoc(collectionRef, data);
                alert(`Produto "${nome}" salvo com sucesso!`);
            } catch (e) {
                console.error("Erro ao salvar produto:", e);
                alert("Erro ao salvar o produto.");
            }
        }

        // === EMBALAGENS - CRUD ===
        function renderEmbalagens(lista = window.appState.embalagensCache()) {
            const container = document.getElementById('lista-embalagens');
            if (!container) return;
            if (!lista.length) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma embalagem cadastrada. Clique em "Nova Embalagem" para começar.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Embalagem</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Unitário</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                        <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            lista.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(embalagem => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-500"><i class="fas fa-box"></i></div>
                            <span class="font-medium text-gray-900">${embalagem.nome}</span>
                        </div>
                    </td>
                    <td class="py-3 px-6 whitespace-nowrap text-gray-700 font-semibold">R$ ${parseFloat(embalagem.valorUnitario).toFixed(2)}</td>
                    <td class="py-3 px-6 text-gray-500 text-sm">${embalagem.descricao || '-'}</td>
                    <td class="py-3 px-6 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="abrirModalEmbalagem('${embalagem.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                        <button onclick="deletarItem('embalagens', '${embalagem.id}', 'embalagem')" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        window.abrirModalEmbalagem = function(id = null) {
            const embalagens = window.appState.embalagensCache();
            const embalagem = id ? embalagens.find(e => e.id === id) : {};
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-box text-indigo-500 mr-2"></i>${id ? 'Editar' : 'Nova'} Embalagem</h2>
                <form id="form-embalagem" onsubmit="salvarEmbalagem(event, '${id || ''}')" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome da Embalagem</label>
                        <input type="text" name="nome" value="${embalagem.nome || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Marmita de alumínio 500ml">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor Unitário (R$)</label>
                            <input type="number" step="0.01" name="valorUnitario" value="${embalagem.valorUnitario || ''}" required min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: 0.45">
                            <p class="text-xs text-gray-500 mt-1">Preço por unidade da embalagem</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Descrição (opcional)</label>
                            <input type="text" name="descricao" value="${embalagem.descricao || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Pacote c/ 100 un - R$45,00">
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" onclick="fecharModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar</button>
                    </div>
                </form>
            `;
            const _mb = document.getElementById('modal-backdrop');
            _mb.classList.remove('hidden');
            _mb.style.display = 'flex';
        }

        window.salvarEmbalagem = async function(event, id) {
            event.preventDefault();
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            const form = document.getElementById('form-embalagem');
            const data = {
                nome: form.nome.value,
                valorUnitario: parseFloat(form.valorUnitario.value),
                descricao: form.descricao.value || ''
            };
            try {
                const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
                const collectionRef = getCollectionRef('embalagens');
                if (id) {
                    await updateDoc(doc(collectionRef, id), data);
                } else {
                    await addDoc(collectionRef, data);
                }
                fecharModal();
            } catch (e) {
                console.error("Erro ao salvar embalagem: ", e);
                alert("Ocorreu um erro ao salvar a embalagem.");
            }
        }

        // === FOTO DO PRODUTO ===
        window.uploadFotoProduto = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                alert('A imagem deve ter no maximo 2MB. Tente uma foto menor.');
                return;
            }
            const statusEl = document.getElementById('foto-ia-status');
            statusEl.innerHTML = '<span class="text-blue-500"><span class="spinner"></span> Processando imagem...</span>';

            const reader = new FileReader();
            reader.onload = function(e) {
                // Redimensionar imagem para economizar espaco no Firestore
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxSize = 400;
                    let w = img.width, h = img.height;
                    if (w > h) { h = h * maxSize / w; w = maxSize; }
                    else { w = w * maxSize / h; h = maxSize; }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    window.tempImagemUrl = dataUrl;
                    atualizarPreviewFoto(dataUrl);
                    statusEl.innerHTML = '<span class="text-green-600"><i class="fas fa-check mr-1"></i>Foto carregada!</span>';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.removerFotoProduto = function() {
            window.tempImagemUrl = '';
            const preview = document.getElementById('produto-foto-preview');
            preview.innerHTML = `<div class="text-center text-gray-400 text-xs p-2"><i class="fas fa-image text-2xl mb-1 block"></i>Sem foto</div>`;
            document.getElementById('foto-ia-status').innerHTML = '';
        };

        window.gerarFotoComIA = async function() {
            const form = document.getElementById('form-produto');
            const nomeProduto = form?.nome?.value?.trim();
            if (!nomeProduto) {
                alert('Preencha o nome do produto primeiro.');
                return;
            }
            const apiKey = getGeminiApiKey();
            if (!apiKey) {
                alert('Configure a chave da API Gemini nas Configuracoes para usar a geracao de imagem por IA.');
                return;
            }
            const statusEl = document.getElementById('foto-ia-status');
            statusEl.innerHTML = '<span class="text-purple-500"><span class="spinner"></span> Gerando imagem com IA... (pode levar alguns segundos)</span>';

            try {
                const descricao = form?.descricao?.value?.trim() || '';
                const prompt = `Gere uma foto profissional e apetitosa de um prato chamado "${nomeProduto}"${descricao ? '. Descricao: ' + descricao : ''}. A foto deve ser estilo food photography profissional, com iluminacao natural, fundo clean, prato bem apresentado e atrativo para cardapio de restaurante. Vista de cima em angulo de 45 graus.`;

                // Usar Gemini com Imagen 3
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["IMAGE", "TEXT"],
                            responseMimeType: "text/plain"
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'Erro na API');
                }

                const data = await response.json();
                const parts = data.candidates?.[0]?.content?.parts || [];
                let imagemEncontrada = false;

                for (const part of parts) {
                    if (part.inlineData) {
                        const mimeType = part.inlineData.mimeType || 'image/png';
                        const dataUrl = `data:${mimeType};base64,${part.inlineData.data}`;
                        // Redimensionar a imagem gerada
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const maxSize = 400;
                            let w = img.width, h = img.height;
                            if (w > h) { h = h * maxSize / w; w = maxSize; }
                            else { w = w * maxSize / h; h = maxSize; }
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            const finalUrl = canvas.toDataURL('image/jpeg', 0.8);
                            window.tempImagemUrl = finalUrl;
                            atualizarPreviewFoto(finalUrl);
                            statusEl.innerHTML = '<span class="text-green-600"><i class="fas fa-check mr-1"></i>Imagem gerada com sucesso!</span>';
                        };
                        img.src = dataUrl;
                        imagemEncontrada = true;
                        break;
                    }
                }

                if (!imagemEncontrada) {
                    // Fallback: usar placeholder com o nome do produto
                    const fallbackUrl = `https://placehold.co/400x400/f8f4f0/333333?text=${encodeURIComponent(nomeProduto)}&font=roboto`;
                    window.tempImagemUrl = fallbackUrl;
                    atualizarPreviewFoto(fallbackUrl);
                    statusEl.innerHTML = '<span class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-1"></i>IA nao gerou imagem. Placeholder criado. Tente enviar uma foto manualmente.</span>';
                }
            } catch (error) {
                console.error('Erro ao gerar foto:', error);
                statusEl.innerHTML = `<span class="text-red-500"><i class="fas fa-times mr-1"></i>${error.message || 'Erro ao gerar imagem. Verifique sua chave API.'}</span>`;
            }
        };

        function atualizarPreviewFoto(url) {
            const preview = document.getElementById('produto-foto-preview');
            if (preview) {
                preview.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded-lg">`;
            }
        }

        window.salvarProduto = async function(event, id) {
            event.preventDefault();
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            const form = document.getElementById('form-produto');
            const data = {
                nome: form.nome.value,
                descricao: form.descricao.value,
                imagemUrl: window.tempImagemUrl || '',
                receita: window.tempReceita.map(item => ({
                    insumoId: item.insumoId,
                    quantidade: parseFloat(item.quantidade) || 0,
                    unidade: item.unidade
                })).filter(item => item.insumoId && item.quantidade > 0),
                embalagens: (window.tempEmbalagens || []).filter(e => e.embalagemId && e.quantidade > 0)
            };
            try {
                const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
                const collectionRef = getCollectionRef('produtos');
                if (id) {
                    await updateDoc(doc(collectionRef, id), data);
                } else {
                    await addDoc(collectionRef, data);
                }
                fecharModal();
            } catch (e) {
                console.error("Erro ao salvar produto: ", e);
                alert("Ocorreu um erro ao salvar o produto.");
            }
        }
        window.deletarItem = async function(collectionName, id, itemName) {
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            if (confirm(`Tem certeza que deseja excluir este ${itemName}?`)) {
                try {
                    const { getCollectionRef, deleteDoc, doc } = window.appState;
                    const collectionRef = getCollectionRef(collectionName);
                    await deleteDoc(doc(collectionRef, id));
                } catch (e) {
                    console.error(`Erro ao excluir ${itemName}: `, e);
                    alert(`Ocorreu um erro ao excluir o ${itemName}.`);
                }
            }
        }
        window.updateCustoTemp = function(index, field, value) {
            window.appState.configCache().custosOperacionais[index][field] = field === 'valor' ? parseFloat(value) : value;
            calcularTotaisConfig();
        }
        window.adicionarCustoOperacional = function() {
            if (!window.appState.configCache().custosOperacionais) window.appState.configCache().custosOperacionais = [];
            window.appState.configCache().custosOperacionais.push({ nome: '', valor: 0 });
            renderConfiguracoes();
        }
        window.removerCustoOperacional = function(index) {
            window.appState.configCache().custosOperacionais.splice(index, 1);
            renderConfiguracoes();
        }
        window.updateCanalTemp = function(index, field, value) {
            window.appState.configCache().canaisVenda[index][field] = field === 'nome' ? value : parseFloat(value);
        }
        window.adicionarCanalVenda = function() {
            if (!window.appState.configCache().canaisVenda) window.appState.configCache().canaisVenda = [];
            window.appState.configCache().canaisVenda.push({ nome: '', taxaComissao: 0, taxaTransacao: 0 });
            renderConfiguracoes();
        }
        window.removerCanalVenda = function(index) {
            window.appState.configCache().canaisVenda.splice(index, 1);
            renderConfiguracoes();
        }
        window.salvarConfiguracoes = async function() {
            if (!window.appState.isReady) {
                alert("A aplicação ainda está a ligar-se à base de dados. Por favor, aguarde um momento.");
                return;
            }
            try {
                const { getConfigDocRef, setDoc } = window.appState;
                const docRef = getConfigDocRef();
                const config = window.appState.configCache();
                config.faturamentoMedioMensal = parseFloat(document.getElementById('faturamento-mensal').value) || 0;
                // Salvar chave Gemini e modelo
                const geminiKey = document.getElementById('gemini-api-key')?.value?.trim();
                if (geminiKey) {
                    config.geminiApiKey = geminiKey;
                    localStorage.setItem('geminiApiKey', geminiKey);
                }
                const geminiModel = document.getElementById('gemini-model-select')?.value;
                if (geminiModel) {
                    config.geminiModel = geminiModel;
                }
                await setDoc(docRef, config);
                atualizarStatusIA();
                alert("Configurações salvas com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar configurações: ", e);
                alert("Ocorreu um erro ao salvar as configurações.");
            }
        }
        window.simularPromocao = function() {
            const desconto = parseFloat(document.getElementById('desconto-cliente').value) || 0;
            const subsidio = parseFloat(document.getElementById('subsidio-ifood').value) || 0;
            const resultadoContainer = document.getElementById('resultado-promocao');

            if (desconto < 0 || subsidio < 0) {
                alert("Os valores de desconto e subsídio não podem ser negativos.");
                return;
            }
            if (subsidio > desconto) {
                alert("O subsídio do iFood não pode ser maior que o desconto total.");
                return;
            }
            if (Object.keys(ultimoCalculo).length === 0) {
                alert("Primeiro, calcule o preço de um produto na seção acima.");
                return;
            }

            // Custo bancado pelo restaurante = desconto total - o que o iFood paga
            const custoBancadoRestaurante = desconto - subsidio;
            const custoProduto = calcularCustoProduto(ultimoCalculo.produtoId);

            let htmlResult = `<h4 class="font-semibold text-lg mb-3">Resultado da Simulação de Promoção para "${ultimoCalculo.produtoNome}"</h4>`;

            const tipoLabels = {
                'cupom_restaurante': 'Cupom do Restaurante (100% seu custo)',
                'cupom_compartilhado': 'Cupom Compartilhado (custo dividido)',
                'cupom_ifood': 'Cupom 100% iFood (custo zero para você)'
            };
            htmlResult += `<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                <strong>Tipo:</strong> ${tipoLabels[tipoPromoSelecionado]} |
                <strong>Desconto total:</strong> R$ ${desconto.toFixed(2)} |
                <strong>iFood paga:</strong> R$ ${subsidio.toFixed(2)} |
                <strong>Você paga:</strong> R$ ${custoBancadoRestaurante.toFixed(2)}
            </div>`;

            htmlResult += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            let temCanalIfood = false;

            for (const canalNome in ultimoCalculo.canais) {
                if (canalNome.toLowerCase().includes('ifood')) {
                    temCanalIfood = true;
                    const canal = ultimoCalculo.canais[canalNome];
                    const precoOriginal = canal.precoFinal;
                    const precoPromocional = precoOriginal - desconto;

                    if (precoPromocional <= 0) {
                        htmlResult += `<div class="alert-danger"><strong>${canalNome}:</strong> O desconto de R$ ${desconto.toFixed(2)} é maior que o preço do produto (R$ ${precoOriginal.toFixed(2)}). Promoção inviável.</div>`;
                        continue;
                    }

                    // FÓRMULA CORRETA DO IFOOD (baseada em pesquisa):
                    // Comissão: cobrada sobre (preço original - subsídio do restaurante)
                    // Taxa pgto online: cobrada sobre o preço original
                    // Recebido = (preço - custoBancadoRest) * (1 - comissão%) - preço * taxaPgto%
                    const baseComissao = precoOriginal - custoBancadoRestaurante;
                    const comissaoValor = baseComissao * canal.taxaComissao;
                    const taxaPgtoValor = precoOriginal * canal.taxaTransacao;

                    // O que o restaurante recebe líquido
                    const recebidoRestaurante = (precoOriginal - custoBancadoRestaurante) - comissaoValor - taxaPgtoValor;
                    const liquidoOriginal = canal.liquidoOriginal;
                    const impactoLucro = recebidoRestaurante - liquidoOriginal;

                    // Custo operacional por prato (do cálculo principal)
                    const custoOpPorPrato = canal.custoOpPorPrato || 0;

                    // Lucro real = recebido - custo insumos - custo operacional
                    const lucroOriginal = liquidoOriginal - custoProduto - custoOpPorPrato;
                    const lucroPromo = recebidoRestaurante - custoProduto - custoOpPorPrato;
                    const margemSobreCusto = lucroPromo;
                    const margemPercentual = recebidoRestaurante > 0 ? (lucroPromo / recebidoRestaurante) * 100 : 0;

                    // Aumento de vendas necessário para compensar
                    const aumentoNecessario = lucroPromo > 0 ? ((lucroOriginal / lucroPromo) - 1) * 100 : Infinity;

                    const impactoClasse = impactoLucro < 0 ? 'text-red-600' : 'text-green-600';
                    const alertaClass = margemSobreCusto < 0 ? 'alert-danger' : margemPercentual < 10 ? 'alert-warning' : 'alert-success';
                    const alertaMsg = margemSobreCusto < 0
                        ? '<i class="fas fa-times-circle mr-1"></i> PREJUÍZO! Você está vendendo abaixo do custo!'
                        : margemPercentual < 10
                        ? '<i class="fas fa-exclamation-triangle mr-1"></i> Margem muito baixa. Avalie se o volume compensa.'
                        : '<i class="fas fa-check-circle mr-1"></i> Margem positiva. Promoção pode ser viável.';

                    const dadosPromocao = {
                        nomeProduto: ultimoCalculo.produtoNome,
                        precoOriginal: precoOriginal,
                        desconto: desconto,
                        subsidio: subsidio,
                        precoPromocional: precoPromocional,
                        novoLiquido: recebidoRestaurante,
                        impactoLucro: impactoLucro,
                        custoProduto: custoProduto,
                        margemPercentual: margemPercentual,
                        aumentoNecessario: aumentoNecessario
                    };

                    htmlResult += `
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h5 class="font-bold text-md text-indigo-700 mb-3">${canalNome}</h5>
                            <div class="space-y-1 text-sm">
                                <p class="border-b pb-1">Preço no Cardápio: <span class="font-semibold float-right">R$ ${precoOriginal.toFixed(2)}</span></p>
                                <p>Preço Promocional (cliente vê): <span class="font-semibold float-right">R$ ${precoPromocional.toFixed(2)}</span></p>
                                <hr class="my-1">
                                <p class="text-gray-500 text-xs">Base comissão (${(canal.taxaComissao * 100).toFixed(1)}%): R$ ${baseComissao.toFixed(2)} <em>(preço - seu subsídio)</em></p>
                                <p class="text-red-500">Comissão iFood (${(canal.taxaComissao * 100).toFixed(1)}%): <span class="font-semibold float-right">- R$ ${comissaoValor.toFixed(2)}</span></p>
                                <p class="text-red-400">Taxa pgto online (${(canal.taxaTransacao * 100).toFixed(1)}%): <span class="font-semibold float-right">- R$ ${taxaPgtoValor.toFixed(2)}</span></p>
                                ${custoBancadoRestaurante > 0 ? `<p class="text-orange-500">Seu subsídio: <span class="font-semibold float-right">- R$ ${custoBancadoRestaurante.toFixed(2)}</span></p>` : ''}
                                <p class="border-t pt-1 font-bold">Você recebe líquido: <span class="float-right text-blue-600">R$ ${recebidoRestaurante.toFixed(2)}</span></p>
                                <p>Custo dos insumos: <span class="float-right">R$ ${custoProduto.toFixed(2)}</span></p>
                                ${custoOpPorPrato > 0 ? `<p>Custo operacional: <span class="float-right">R$ ${custoOpPorPrato.toFixed(2)}</span></p>` : ''}
                                <p class="font-bold ${impactoClasse}">Lucro por unidade: <span class="float-right">R$ ${lucroPromo.toFixed(2)} (${margemPercentual.toFixed(1)}%)</span></p>
                                <p class="${impactoClasse} border-t pt-1">Impacto vs. sem promoção: <span class="font-bold float-right">R$ ${impactoLucro.toFixed(2)}</span></p>
                                ${aumentoNecessario !== Infinity && aumentoNecessario > 0 ? `<p class="text-orange-600 text-xs mt-1"><i class="fas fa-arrow-up mr-1"></i>Precisa vender <strong>${aumentoNecessario.toFixed(0)}% mais</strong> para compensar o desconto</p>` : ''}
                            </div>
                            <div class="mt-3 ${alertaClass} text-xs">${alertaMsg}</div>
                            <button onclick='obterConsultoriaPromocaoIA(this, ${JSON.stringify(dadosPromocao)})' class="mt-3 w-full bg-gray-700 text-white text-xs font-bold py-2 px-2 rounded-md hover:bg-gray-800 transition-colors">
                                ✨ Obter Consultoria da IA
                            </button>
                        </div>
                    `;
                }
            }

            if (!temCanalIfood) {
                htmlResult += `<div class="col-span-2 alert-warning">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    Nenhum canal com "iFood" no nome foi encontrado. Cadastre um canal com "iFood" no nome nas Configurações.
                </div>`;
            }

            htmlResult += `</div><div id="consultoria-ia-promocao" class="mt-4"></div>`;
            resultadoContainer.innerHTML = htmlResult;
            resultadoContainer.classList.remove('hidden');
        }
        window.simularFreteEmbutido = function() {
            const custoReal = parseFloat(document.getElementById('custo-real-entrega').value);
            const valorPagoCliente = parseFloat(document.getElementById('valor-pago-cliente').value);
            const resultadoContainer = document.getElementById('resultado-frete');
            if (Object.keys(ultimoCalculo).length === 0) {
                alert("Primeiro, calcule o preço de um produto.");
                return;
            }
            const custoFreteAbsorvido = custoReal - valorPagoCliente;
            if (custoFreteAbsorvido < 0) {
                alert("O valor pago pelo cliente não pode ser maior que o custo real da entrega.");
                return;
            }
            let htmlResult = `<h4 class="font-semibold text-lg mb-3">Resultado do Frete Embutido para "${ultimoCalculo.produtoNome}"</h4>`;
            htmlResult += `<p class="text-sm mb-4">Custo do frete absorvido pelo restaurante: <span class="font-bold">R$ ${custoFreteAbsorvido.toFixed(2)}</span></p>`;
            htmlResult += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            for (const canalNome in ultimoCalculo.canais) {
                const canal = ultimoCalculo.canais[canalNome];
                const novoPrecoBase = canal.liquidoOriginal + custoFreteAbsorvido;
                const novoPrecoFinal = novoPrecoBase / (1 - canal.taxasPercentual);
                const dadosFrete = {
                    nomeProduto: ultimoCalculo.produtoNome,
                    precoOriginal: canal.precoFinal,
                    novoPreco: novoPrecoFinal,
                    custoFreteAbsorvido: custoFreteAbsorvido
                };
                htmlResult += `
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h5 class="font-bold text-md text-indigo-700 mb-2">${canalNome}</h5>
                        <div class="space-y-1 text-sm">
                            <p>Preço Original: <span class="font-semibold float-right">R$ ${canal.precoFinal.toFixed(2)}</span></p>
                            <p class="text-blue-600">Novo Preço (Frete Embutido): <span class="font-bold float-right">R$ ${novoPrecoFinal.toFixed(2)}</span></p>
                        </div>
                        <button onclick='obterConsultoriaFreteIA(this, ${JSON.stringify(dadosFrete)})' class="mt-4 w-full bg-gray-700 text-white text-xs font-bold py-2 px-2 rounded-md hover:bg-gray-800 transition-colors">
                            ✨ Obter Consultoria da IA
                        </button>
                    </div>
                `;
            }
            htmlResult += `</div><div id="consultoria-ia-frete" class="mt-4"></div>`;
            resultadoContainer.innerHTML = htmlResult;
            resultadoContainer.classList.remove('hidden');
        }
        // === CAMPANHA INTELIGENTE PRESETS ===
        window.aplicarPresetCampanha = function(desconto, precoMin, precoMax) {
            document.getElementById('desconto-cliente').value = desconto.toFixed(2);
            // Se for cupom do restaurante, subsídio = 0; se compartilhado, iFood paga até R$5
            if (tipoPromoSelecionado === 'cupom_restaurante') {
                document.getElementById('subsidio-ifood').value = '0.00';
            } else if (tipoPromoSelecionado === 'cupom_compartilhado') {
                document.getElementById('subsidio-ifood').value = Math.min(5, desconto).toFixed(2);
            }
            // Verificar se o produto calculado está na faixa
            if (Object.keys(ultimoCalculo).length > 0) {
                let foraFaixa = false;
                for (const canalNome in ultimoCalculo.canais) {
                    if (canalNome.toLowerCase().includes('ifood')) {
                        const preco = ultimoCalculo.canais[canalNome].precoFinal;
                        if (preco < precoMin || preco > precoMax) {
                            foraFaixa = true;
                        }
                    }
                }
                if (foraFaixa) {
                    alert(`Atenção: Este desconto de R$${desconto} é recomendado para itens entre R$${precoMin.toFixed(2)} e R$${precoMax.toFixed(2)}. Verifique se o preço do seu produto está nesta faixa.`);
                }
            }
            // Destaque visual no botão clicado
            document.querySelectorAll('#presets-campanha button').forEach(btn => btn.classList.remove('bg-orange-100', 'border-orange-400'));
            event.currentTarget.classList.add('bg-orange-100', 'border-orange-400');
        }
        window.aplicarPresetFrete = function() {
            // Preencher o simulador de frete ao invés do simulador de promoção
            document.getElementById('custo-real-entrega').value = '10.00';
            document.getElementById('valor-pago-cliente').value = '0.00';
            document.getElementById('simulador-frete').scrollIntoView({ behavior: 'smooth' });
        }

        // === RELATÓRIOS IFOOD - CSV IMPORT ===
        let relatorioData = [];
        let relFatChart = null;
        let relCompChart = null;

        // Drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('csv-drop-zone');
            if (dropZone) {
                ['dragenter', 'dragover'].forEach(evt => {
                    dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('border-indigo-400', 'bg-indigo-50'); });
                });
                ['dragleave', 'drop'].forEach(evt => {
                    dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('border-indigo-400', 'bg-indigo-50'); });
                });
                dropZone.addEventListener('drop', e => {
                    if (e.dataTransfer.files.length > 0) processarRelatorioCSV(e.dataTransfer.files[0]);
                });
            }
        });

        window.processarRelatorioCSV = function(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const dados = parseCSV(text);
                    if (dados.length === 0) {
                        alert('Arquivo vazio ou formato não reconhecido.');
                        return;
                    }
                    relatorioData = dados;
                    renderizarRelatorio(dados);
                    document.getElementById('relatorio-resultado').classList.remove('hidden');
                } catch (err) {
                    alert('Erro ao processar o arquivo: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            // Detectar separador
            const sep = lines[0].includes(';') ? ';' : ',';
            const headers = lines[0].split(sep).map(h => h.trim().replace(/^["']|["']$/g, '').toLowerCase());

            // Mapear colunas de forma flexível
            const colMap = {};
            const mappings = {
                data: ['data', 'date', 'data do pedido', 'data pedido', 'dt_pedido'],
                pedido: ['pedido', 'order', 'nº pedido', 'numero pedido', 'id pedido', 'id_pedido', 'nº do pedido'],
                itens: ['itens', 'items', 'item', 'descrição', 'descricao', 'produto', 'nome do item'],
                valorBruto: ['valor bruto', 'valor total', 'total', 'valor do pedido', 'vlr_bruto', 'valor_bruto', 'subtotal', 'valor pedido'],
                desconto: ['desconto', 'discount', 'valor desconto', 'vlr_desconto', 'valor_desconto', 'promoção', 'promocao'],
                comissao: ['comissão', 'comissao', 'commission', 'taxa comissão', 'vlr_comissao', 'valor_comissao', 'comissão ifood'],
                taxa: ['taxa', 'fee', 'taxa de serviço', 'taxa servico', 'vlr_taxa', 'taxa_servico', 'taxa pagamento', 'outras taxas'],
                valorLiquido: ['valor líquido', 'valor liquido', 'net', 'vlr_liquido', 'valor_liquido', 'recebido', 'valor recebido', 'a receber']
            };

            for (const [key, alternatives] of Object.entries(mappings)) {
                const idx = headers.findIndex(h => alternatives.some(alt => h.includes(alt)));
                if (idx !== -1) colMap[key] = idx;
            }

            const dados = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(sep).map(c => c.trim().replace(/^["']|["']$/g, ''));
                if (cols.length < 2 || cols.every(c => !c)) continue;

                const parseNum = (idx) => {
                    if (idx === undefined || !cols[idx]) return 0;
                    return parseFloat(cols[idx].replace(/[R$\s]/g, '').replace('.', '').replace(',', '.')) || 0;
                };

                const registro = {
                    data: colMap.data !== undefined ? cols[colMap.data] : '',
                    pedido: colMap.pedido !== undefined ? cols[colMap.pedido] : `#${i}`,
                    itens: colMap.itens !== undefined ? cols[colMap.itens] : '',
                    valorBruto: parseNum(colMap.valorBruto),
                    desconto: Math.abs(parseNum(colMap.desconto)),
                    comissao: Math.abs(parseNum(colMap.comissao)),
                    taxa: Math.abs(parseNum(colMap.taxa)),
                    valorLiquido: parseNum(colMap.valorLiquido)
                };
                // Se não tem valor líquido calculado, calcular
                if (!registro.valorLiquido && registro.valorBruto > 0) {
                    registro.valorLiquido = registro.valorBruto - registro.desconto - registro.comissao - registro.taxa;
                }
                if (registro.valorBruto > 0) dados.push(registro);
            }
            return dados;
        }

        function renderizarRelatorio(dados) {
            const totalPedidos = dados.length;
            const faturamentoBruto = dados.reduce((s, d) => s + d.valorBruto, 0);
            const totalDescontos = dados.reduce((s, d) => s + d.desconto, 0);
            const totalComissao = dados.reduce((s, d) => s + d.comissao, 0);
            const totalTaxa = dados.reduce((s, d) => s + d.taxa, 0);
            const totalTaxas = totalComissao + totalTaxa;
            const totalLiquido = dados.reduce((s, d) => s + d.valorLiquido, 0);
            const ticketMedio = totalPedidos > 0 ? faturamentoBruto / totalPedidos : 0;
            const taxaEfetiva = faturamentoBruto > 0 ? (totalTaxas / faturamentoBruto) * 100 : 0;

            // Calcular dias únicos
            const datasUnicas = new Set(dados.map(d => d.data).filter(Boolean));
            const numDias = Math.max(datasUnicas.size, 1);
            const pedidosDia = totalPedidos / numDias;

            // Cards
            document.getElementById('rel-total-pedidos').textContent = totalPedidos;
            document.getElementById('rel-faturamento-bruto').textContent = `R$ ${faturamentoBruto.toFixed(2)}`;
            document.getElementById('rel-total-taxas').textContent = `R$ ${totalTaxas.toFixed(2)}`;
            document.getElementById('rel-liquido').textContent = `R$ ${totalLiquido.toFixed(2)}`;
            document.getElementById('rel-ticket-medio').textContent = `R$ ${ticketMedio.toFixed(2)}`;
            document.getElementById('rel-taxa-efetiva').textContent = `${taxaEfetiva.toFixed(1)}%`;
            document.getElementById('rel-total-descontos').textContent = `R$ ${totalDescontos.toFixed(2)}`;
            document.getElementById('rel-pedidos-dia').textContent = pedidosDia.toFixed(1);

            // Gráfico de faturamento por data
            const porData = {};
            dados.forEach(d => {
                const dt = d.data || 'Sem data';
                if (!porData[dt]) porData[dt] = { bruto: 0, liquido: 0, pedidos: 0 };
                porData[dt].bruto += d.valorBruto;
                porData[dt].liquido += d.valorLiquido;
                porData[dt].pedidos++;
            });
            const labels = Object.keys(porData).sort();
            const brutoArr = labels.map(l => porData[l].bruto);
            const liquidoArr = labels.map(l => porData[l].liquido);

            if (relFatChart) relFatChart.destroy();
            const ctx1 = document.getElementById('rel-chart-faturamento').getContext('2d');
            relFatChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Bruto', data: brutoArr, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 },
                        { label: 'Líquido', data: liquidoArr, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => 'R$' + v.toFixed(0) } } }
                }
            });

            // Gráfico de composição (pizza)
            if (relCompChart) relCompChart.destroy();
            const ctx2 = document.getElementById('rel-chart-composicao').getContext('2d');
            relCompChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Líquido Recebido', 'Comissão iFood', 'Taxas/Pgto', 'Descontos/Promoções'],
                    datasets: [{
                        data: [totalLiquido, totalComissao, totalTaxa, totalDescontos],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: R$ ${ctx.parsed.toFixed(2)}` } }
                    }
                }
            });

            // Tabela de pedidos
            let tabelaHtml = `<table class="min-w-full text-sm">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Data</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Pedido</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Itens</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500">Bruto</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500">Desconto</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500">Comissão</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500">Taxas</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500">Líquido</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="rel-tbody">`;
            dados.forEach(d => {
                const lucroClass = d.valorLiquido >= 0 ? 'text-green-600' : 'text-red-600';
                tabelaHtml += `<tr class="rel-row hover:bg-gray-50">
                    <td class="py-2 px-3">${d.data}</td>
                    <td class="py-2 px-3 font-mono text-xs">${d.pedido}</td>
                    <td class="py-2 px-3 max-w-xs truncate" title="${d.itens}">${d.itens || '-'}</td>
                    <td class="py-2 px-3 text-right">R$ ${d.valorBruto.toFixed(2)}</td>
                    <td class="py-2 px-3 text-right text-orange-500">${d.desconto > 0 ? '-R$ ' + d.desconto.toFixed(2) : '-'}</td>
                    <td class="py-2 px-3 text-right text-red-500">-R$ ${d.comissao.toFixed(2)}</td>
                    <td class="py-2 px-3 text-right text-red-400">-R$ ${d.taxa.toFixed(2)}</td>
                    <td class="py-2 px-3 text-right font-bold ${lucroClass}">R$ ${d.valorLiquido.toFixed(2)}</td>
                </tr>`;
            });
            tabelaHtml += `</tbody></table>`;
            document.getElementById('rel-tabela-pedidos').innerHTML = tabelaHtml;

            // Insights
            const insightsHtml = gerarInsightsRelatorio(dados, faturamentoBruto, totalTaxas, totalDescontos, totalLiquido, ticketMedio, taxaEfetiva, pedidosDia);
            document.getElementById('rel-insights').innerHTML = insightsHtml;
        }

        function gerarInsightsRelatorio(dados, bruto, taxas, descontos, liquido, ticket, taxaEfetiva, pedidosDia) {
            let html = '';
            // Taxa efetiva vs esperada
            const taxaClass = taxaEfetiva > 26 ? 'alert-danger' : taxaEfetiva > 20 ? 'alert-warning' : 'alert-success';
            const taxaIcon = taxaEfetiva > 26 ? 'times-circle' : taxaEfetiva > 20 ? 'exclamation-triangle' : 'check-circle';
            html += `<div class="${taxaClass}">
                <i class="fas fa-${taxaIcon} mr-2"></i>
                <strong>Taxa efetiva real: ${taxaEfetiva.toFixed(1)}%</strong> -
                ${taxaEfetiva > 26 ? 'Acima do Plano Entrega (26,2%). Promoções e descontos estão pesando.' :
                  taxaEfetiva > 20 ? 'Compatível com Plano Entrega (~26,2%). Dentro do esperado.' :
                  'Abaixo de 20%. Você pode estar no Plano Básico ou com bom controle de custos.'}
            </div>`;

            // Impacto das promoções
            if (descontos > 0) {
                const percDesconto = (descontos / bruto * 100);
                html += `<div class="alert-warning">
                    <i class="fas fa-tag mr-2"></i>
                    <strong>Promoções representam ${percDesconto.toFixed(1)}% do faturamento bruto</strong> (R$ ${descontos.toFixed(2)}).
                    ${percDesconto > 15 ? ' Valor alto! Avalie se o volume extra compensa.' : ' Dentro de uma faixa razoável.'}
                </div>`;
            }

            // Ticket médio
            html += `<div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                <i class="fas fa-receipt mr-2"></i>
                <strong>Ticket médio: R$ ${ticket.toFixed(2)}</strong> | Média de <strong>${pedidosDia.toFixed(1)} pedidos/dia</strong>.
                ${ticket < 25 ? ' Ticket baixo - considere combos para aumentar o valor médio.' :
                  ticket > 50 ? ' Ticket alto - bom sinal de valor agregado!' : ' Ticket dentro da média.'}
            </div>`;

            // Retenção do iFood
            const retencaoPerc = bruto > 0 ? ((bruto - liquido) / bruto * 100) : 0;
            html += `<div class="p-3 bg-purple-50 border border-purple-200 rounded-lg text-sm text-purple-800">
                <i class="fas fa-hand-holding-usd mr-2"></i>
                <strong>O iFood retém ${retencaoPerc.toFixed(1)}% do seu faturamento bruto</strong>.
                De cada R$ 100 que o cliente paga, você recebe R$ ${(100 - retencaoPerc).toFixed(2)}.
            </div>`;

            return html;
        }

        window.filtrarTabelaRelatorio = function() {
            const filtro = document.getElementById('rel-filtro').value.toLowerCase();
            document.querySelectorAll('.rel-row').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(filtro) ? '' : 'none';
            });
        }

        window.exportarAnaliseCSV = function() {
            if (relatorioData.length === 0) return;
            let csv = 'Data;Pedido;Itens;Valor Bruto;Desconto;Comissão;Taxas;Valor Líquido\n';
            relatorioData.forEach(d => {
                csv += `${d.data};${d.pedido};"${d.itens}";${d.valorBruto.toFixed(2)};${d.desconto.toFixed(2)};${d.comissao.toFixed(2)};${d.taxa.toFixed(2)};${d.valorLiquido.toFixed(2)}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'analise_ifood_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // === CARDAPIO DIGITAL FUNCTIONS ===
        let cardapioConfig = {};

        async function carregarCardapioConfig() {
            if (!window.appState.userId) return;
            try {
                const configRef = doc(db, `artifacts/${appId}/users/${window.appState.userId}/configuracoes/cardapio`);
                const snap = await getDoc(configRef);
                if (snap.exists()) {
                    cardapioConfig = snap.data();
                    // Preencher campos
                    document.getElementById('loja-nome').value = cardapioConfig.nomeLoja || '';
                    document.getElementById('loja-descricao').value = cardapioConfig.descricaoLoja || '';
                    document.getElementById('loja-whatsapp').value = cardapioConfig.whatsapp || '';
                    document.getElementById('loja-instagram').value = cardapioConfig.instagram || '';
                    document.getElementById('loja-endereco').value = cardapioConfig.endereco || '';
                    document.getElementById('loja-horario').value = cardapioConfig.horario || '';
                    document.getElementById('loja-taxa-entrega').value = cardapioConfig.taxaEntrega || '';
                    document.getElementById('loja-pedido-minimo').value = cardapioConfig.pedidoMinimo || '';
                    document.getElementById('loja-tempo-entrega').value = cardapioConfig.tempoEntrega || '';
                    document.getElementById('loja-frete-gratis').value = cardapioConfig.freteGratisAcima || '';
                    document.getElementById('loja-chave-pix').value = cardapioConfig.chavePix || '';
                    document.getElementById('loja-entrega-ativa').checked = cardapioConfig.entregaAtiva !== false;
                    document.getElementById('loja-retirada-ativa').checked = cardapioConfig.retiradaAtiva !== false;
                    document.getElementById('pag-pix').checked = cardapioConfig.pagPix !== false;
                    document.getElementById('pag-cartao-credito').checked = cardapioConfig.pagCartaoCredito !== false;
                    document.getElementById('pag-cartao-debito').checked = cardapioConfig.pagCartaoDebito !== false;
                    document.getElementById('pag-dinheiro').checked = cardapioConfig.pagDinheiro !== false;
                    document.getElementById('pag-vale-refeicao').checked = cardapioConfig.pagValeRefeicao || false;
                    if (cardapioConfig.logoUrl) {
                        document.getElementById('loja-logo-preview').innerHTML = `<img src="${cardapioConfig.logoUrl}" class="w-full h-full object-cover rounded-full">`;
                    }
                    if (cardapioConfig.bannerUrl) {
                        document.getElementById('loja-banner-preview').innerHTML = `<img src="${cardapioConfig.bannerUrl}" class="w-full h-full object-cover rounded-lg">`;
                    }
                    if (cardapioConfig.corTema) setCorTema(cardapioConfig.corTema);
                }
            } catch (e) { console.error('Erro ao carregar cardapio config:', e); }
        }

        window.salvarCardapioConfig = async function() {
            if (!window.appState.userId) return;
            const data = {
                nomeLoja: document.getElementById('loja-nome').value.trim(),
                descricaoLoja: document.getElementById('loja-descricao').value.trim(),
                whatsapp: document.getElementById('loja-whatsapp').value.trim(),
                instagram: document.getElementById('loja-instagram').value.trim(),
                endereco: document.getElementById('loja-endereco').value.trim(),
                horario: document.getElementById('loja-horario').value.trim(),
                taxaEntrega: parseFloat(document.getElementById('loja-taxa-entrega').value) || 0,
                pedidoMinimo: parseFloat(document.getElementById('loja-pedido-minimo').value) || 0,
                tempoEntrega: document.getElementById('loja-tempo-entrega').value.trim(),
                freteGratisAcima: parseFloat(document.getElementById('loja-frete-gratis').value) || 0,
                chavePix: document.getElementById('loja-chave-pix').value.trim(),
                entregaAtiva: document.getElementById('loja-entrega-ativa').checked,
                retiradaAtiva: document.getElementById('loja-retirada-ativa').checked,
                pagPix: document.getElementById('pag-pix').checked,
                pagCartaoCredito: document.getElementById('pag-cartao-credito').checked,
                pagCartaoDebito: document.getElementById('pag-cartao-debito').checked,
                pagDinheiro: document.getElementById('pag-dinheiro').checked,
                pagValeRefeicao: document.getElementById('pag-vale-refeicao').checked,
                logoUrl: cardapioConfig.logoUrl || '',
                bannerUrl: cardapioConfig.bannerUrl || '',
                corTema: cardapioConfig.corTema || '#ea580c',
                cupons: cardapioConfig.cupons || [],
                banners: cardapioConfig.banners || [],
                atualizadoEm: new Date().toISOString()
            };

            // Salvar precos dos produtos no cardapio
            const produtosCardapio = {};
            document.querySelectorAll('.cardapio-produto-row').forEach(row => {
                const id = row.dataset.id;
                produtosCardapio[id] = {
                    ativo: row.querySelector('.cp-ativo').checked,
                    preco: parseFloat(row.querySelector('.cp-preco').value) || 0,
                    precoPromocional: parseFloat(row.querySelector('.cp-preco-promo').value) || 0,
                    categoria: row.querySelector('.cp-categoria').value.trim(),
                    destaque: row.querySelector('.cp-destaque').checked
                };
            });
            data.produtosCardapio = produtosCardapio;

            try {
                const configRef = doc(db, `artifacts/${appId}/users/${window.appState.userId}/configuracoes/cardapio`);
                await setDoc(configRef, data);
                cardapioConfig = data;
                alert('Cardapio salvo com sucesso!');
            } catch (e) {
                console.error('Erro ao salvar cardapio:', e);
                alert('Erro ao salvar: ' + e.message);
            }
        };

        function renderCardapioProdutos() {
            const container = document.getElementById('cardapio-produtos-lista');
            const produtos = window.appState.produtosCache();
            if (!produtos.length) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum produto cadastrado. Cadastre produtos na aba "Produtos e Receitas" primeiro.</p>';
                return;
            }
            const pc = cardapioConfig.produtosCardapio || {};
            container.innerHTML = `
                <div class="hidden md:grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 uppercase pb-2 border-b">
                    <div class="col-span-1">Ativo</div>
                    <div class="col-span-3">Produto</div>
                    <div class="col-span-2">Categoria</div>
                    <div class="col-span-2">Preco (R$)</div>
                    <div class="col-span-2">Promo (R$)</div>
                    <div class="col-span-1">Destaque</div>
                    <div class="col-span-1">Desconto</div>
                </div>
            `;
            produtos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(p => {
                const cfg = pc[p.id] || {};
                const custo = calcularCustoProduto(p.id);
                const desconto = cfg.preco && cfg.precoPromocional ? Math.round((1 - cfg.precoPromocional / cfg.preco) * 100) : 0;
                const div = document.createElement('div');
                div.className = 'cardapio-produto-row grid grid-cols-1 md:grid-cols-12 gap-2 items-center py-3 border-b border-gray-100 hover:bg-orange-50 transition-colors';
                div.dataset.id = p.id;
                div.innerHTML = `
                    <div class="md:col-span-1 flex items-center">
                        <label class="md:hidden text-xs text-gray-500 mr-2">Ativo:</label>
                        <input type="checkbox" class="cp-ativo w-4 h-4 text-orange-500 rounded" ${cfg.ativo ? 'checked' : ''}>
                    </div>
                    <div class="md:col-span-3 flex items-center gap-2">
                        ${p.imagemUrl ? `<img src="${p.imagemUrl}" class="w-10 h-10 rounded-lg object-cover">` : `<div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-300"><i class="fas fa-utensils"></i></div>`}
                        <div>
                            <span class="font-medium text-sm text-gray-800">${p.nome}</span>
                            <span class="block text-xs text-gray-400">Custo: R$ ${custo.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="md:hidden text-xs text-gray-500">Categoria:</label>
                        <input type="text" class="cp-categoria w-full p-1.5 border rounded text-sm" placeholder="Ex: Pratos" value="${cfg.categoria || ''}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="md:hidden text-xs text-gray-500">Preco:</label>
                        <input type="number" class="cp-preco w-full p-1.5 border rounded text-sm" step="0.50" placeholder="0.00" value="${cfg.preco || ''}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="md:hidden text-xs text-gray-500">Promo:</label>
                        <input type="number" class="cp-preco-promo w-full p-1.5 border rounded text-sm" step="0.50" placeholder="Sem promo" value="${cfg.precoPromocional || ''}">
                    </div>
                    <div class="md:col-span-1 flex items-center">
                        <label class="md:hidden text-xs text-gray-500 mr-2">Destaque:</label>
                        <input type="checkbox" class="cp-destaque w-4 h-4 text-yellow-500 rounded" ${cfg.destaque ? 'checked' : ''}>
                        <i class="fas fa-star text-yellow-400 ml-1 text-xs"></i>
                    </div>
                    <div class="md:col-span-1">
                        ${desconto > 0 ? `<span class="bg-red-500 text-white text-xs font-bold py-1 px-2 rounded-full">-${desconto}%</span>` : '<span class="text-gray-300 text-xs">--</span>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Cupons
        function renderCupons() {
            const container = document.getElementById('lista-cupons');
            const cupons = cardapioConfig.cupons || [];
            if (!cupons.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm py-2">Nenhum cupom cadastrado.</p>';
                return;
            }
            container.innerHTML = '';
            cupons.forEach((cupom, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 mb-2 p-2 bg-orange-50 rounded-lg';
                div.innerHTML = `
                    <input type="text" value="${cupom.codigo}" onchange="cardapioConfig.cupons[${i}].codigo = this.value.toUpperCase()" class="w-1/3 p-1.5 border rounded text-sm font-mono uppercase" placeholder="CODIGO">
                    <select onchange="cardapioConfig.cupons[${i}].tipo = this.value" class="p-1.5 border rounded text-sm">
                        <option value="percentual" ${cupom.tipo === 'percentual' ? 'selected' : ''}>%</option>
                        <option value="fixo" ${cupom.tipo === 'fixo' ? 'selected' : ''}>R$</option>
                    </select>
                    <input type="number" value="${cupom.valor}" onchange="cardapioConfig.cupons[${i}].valor = parseFloat(this.value)" class="w-20 p-1.5 border rounded text-sm" placeholder="10">
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${cupom.ativo ? 'checked' : ''} onchange="cardapioConfig.cupons[${i}].ativo = this.checked" class="w-3 h-3"> Ativo</label>
                    <button onclick="cardapioConfig.cupons.splice(${i}, 1); renderCupons();" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash text-xs"></i></button>
                `;
                container.appendChild(div);
            });
        }

        window.adicionarCupom = function() {
            if (!cardapioConfig.cupons) cardapioConfig.cupons = [];
            cardapioConfig.cupons.push({ codigo: '', tipo: 'percentual', valor: 10, ativo: true });
            renderCupons();
        };

        // Banners publicitarios
        function renderBanners() {
            const container = document.getElementById('lista-banners');
            const banners = cardapioConfig.banners || [];
            if (!banners.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm py-2">Nenhum banner cadastrado.</p>';
                return;
            }
            container.innerHTML = '';
            banners.forEach((banner, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 mb-2 p-2 bg-orange-50 rounded-lg';
                div.innerHTML = `
                    <div class="w-20 h-12 rounded bg-gray-200 flex items-center justify-center overflow-hidden flex-shrink-0">
                        ${banner.imagemUrl ? `<img src="${banner.imagemUrl}" class="w-full h-full object-cover">` : '<i class="fas fa-image text-gray-400"></i>'}
                    </div>
                    <div class="flex-1">
                        <input type="text" value="${banner.titulo || ''}" onchange="cardapioConfig.banners[${i}].titulo = this.value" class="w-full p-1 border rounded text-sm mb-1" placeholder="Titulo do banner">
                        <label class="bg-blue-500 text-white text-xs py-1 px-2 rounded cursor-pointer hover:bg-blue-600">
                            <i class="fas fa-image"></i> Img
                            <input type="file" accept="image/*" onchange="uploadBannerImg(event, ${i})" class="hidden">
                        </label>
                    </div>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${banner.ativo ? 'checked' : ''} onchange="cardapioConfig.banners[${i}].ativo = this.checked" class="w-3 h-3"> Ativo</label>
                    <button onclick="cardapioConfig.banners.splice(${i}, 1); renderBanners();" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash text-xs"></i></button>
                `;
                container.appendChild(div);
            });
        }

        window.adicionarBanner = function() {
            if (!cardapioConfig.banners) cardapioConfig.banners = [];
            cardapioConfig.banners.push({ titulo: '', imagemUrl: '', ativo: true });
            renderBanners();
        };

        window.uploadBannerImg = function(event, index) {
            const file = event.target.files[0];
            if (!file) return;
            comprimirImagem(file, 800, 0.8, (dataUrl) => {
                cardapioConfig.banners[index].imagemUrl = dataUrl;
                renderBanners();
            });
        };

        // Upload logo e banner da loja
        window.uploadLogoLoja = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            comprimirImagem(file, 200, 0.8, (dataUrl) => {
                cardapioConfig.logoUrl = dataUrl;
                document.getElementById('loja-logo-preview').innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover rounded-full">`;
            });
        };

        window.uploadBannerLoja = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            comprimirImagem(file, 800, 0.8, (dataUrl) => {
                cardapioConfig.bannerUrl = dataUrl;
                document.getElementById('loja-banner-preview').innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover rounded-lg">`;
            });
        };

        window.setCorTema = function(cor) {
            cardapioConfig.corTema = cor;
            document.querySelectorAll('.cor-tema-btn').forEach(btn => {
                btn.classList.toggle('border-gray-800', btn.dataset.cor === cor);
                btn.classList.toggle('border-transparent', btn.dataset.cor !== cor);
                btn.classList.toggle('scale-110', btn.dataset.cor === cor);
            });
        };

        function comprimirImagem(file, maxSize, quality, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > h) { h = h * maxSize / w; w = maxSize; }
                    else { w = w * maxSize / h; h = maxSize; }
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Compartilhar e visualizar
        window.previsualizarCardapio = function() {
            // Coletar dados atuais da tela (sem precisar salvar antes)
            const produtos = window.appState.produtosCache();
            const produtosCardapio = {};
            document.querySelectorAll('.cardapio-produto-row').forEach(row => {
                const id = row.dataset.id;
                produtosCardapio[id] = {
                    ativo: row.querySelector('.cp-ativo').checked,
                    preco: parseFloat(row.querySelector('.cp-preco').value) || 0,
                    precoPromocional: parseFloat(row.querySelector('.cp-preco-promo').value) || 0,
                    categoria: row.querySelector('.cp-categoria').value.trim(),
                    destaque: row.querySelector('.cp-destaque').checked
                };
            });

            const previewData = {
                loja: {
                    nomeLoja: document.getElementById('loja-nome').value.trim(),
                    descricaoLoja: document.getElementById('loja-descricao').value.trim(),
                    whatsapp: document.getElementById('loja-whatsapp').value.trim(),
                    instagram: document.getElementById('loja-instagram').value.trim(),
                    endereco: document.getElementById('loja-endereco').value.trim(),
                    horario: document.getElementById('loja-horario').value.trim(),
                    taxaEntrega: parseFloat(document.getElementById('loja-taxa-entrega').value) || 0,
                    pedidoMinimo: parseFloat(document.getElementById('loja-pedido-minimo').value) || 0,
                    tempoEntrega: document.getElementById('loja-tempo-entrega').value.trim(),
                    freteGratisAcima: parseFloat(document.getElementById('loja-frete-gratis').value) || 0,
                    chavePix: document.getElementById('loja-chave-pix').value.trim(),
                    entregaAtiva: document.getElementById('loja-entrega-ativa').checked,
                    retiradaAtiva: document.getElementById('loja-retirada-ativa').checked,
                    pagPix: document.getElementById('pag-pix').checked,
                    pagCartaoCredito: document.getElementById('pag-cartao-credito').checked,
                    pagCartaoDebito: document.getElementById('pag-cartao-debito').checked,
                    pagDinheiro: document.getElementById('pag-dinheiro').checked,
                    pagValeRefeicao: document.getElementById('pag-vale-refeicao').checked,
                    logoUrl: cardapioConfig.logoUrl || '',
                    bannerUrl: cardapioConfig.bannerUrl || '',
                    corTema: cardapioConfig.corTema || '#ea580c',
                    cupons: cardapioConfig.cupons || [],
                    banners: cardapioConfig.banners || [],
                    produtosCardapio: produtosCardapio
                },
                produtos: produtos
            };
            localStorage.setItem('cardapio_preview', JSON.stringify(previewData));
            const url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}cardapio.html?preview=1`;
            window.open(url, '_blank');
        };

        window.compartilharCardapio = function() {
            const url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}cardapio.html?loja=${window.appState.userId}`;
            const linkBox = document.getElementById('cardapio-link-box');
            document.getElementById('cardapio-link').value = url;
            linkBox.classList.remove('hidden');
        };

        window.copiarLinkCardapio = function() {
            const input = document.getElementById('cardapio-link');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                alert('Link copiado! Compartilhe com seus clientes.');
            });
        };

        // === PEDIDOS RECEBIDOS ===
        let pedidosCache = [];
        let pedidosFiltro = 'todos';

        window.carregarPedidos = async function() {
            if (!window.appState.userId) return;
            try {
                const pedidosRef = collection(db, `artifacts/${appId}/users/${window.appState.userId}/pedidos`);
                const snap = await getDocs(pedidosRef);
                pedidosCache = [];
                snap.forEach(d => pedidosCache.push({ id: d.id, ...d.data() }));
                pedidosCache.sort((a, b) => (b.criadoEm || '').localeCompare(a.criadoEm || ''));
                renderPedidos();
                atualizarBadgePedidos();
            } catch (e) {
                console.error('Erro ao carregar pedidos:', e);
            }
        };

        function atualizarBadgePedidos() {
            const novos = pedidosCache.filter(p => p.status === 'novo').length;
            const badge = document.getElementById('pedidos-badge');
            if (novos > 0) {
                badge.textContent = novos;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        window.filtrarPedidos = function(filtro) {
            pedidosFiltro = filtro;
            document.querySelectorAll('.filtro-pedido-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
            });
            renderPedidos();
        };

        function renderPedidos() {
            const container = document.getElementById('pedidos-lista');
            let lista = pedidosCache;
            if (pedidosFiltro !== 'todos') {
                lista = lista.filter(p => p.status === pedidosFiltro);
            }

            // Contadores
            const hoje = new Date().toISOString().slice(0, 10);
            const pedidosHoje = pedidosCache.filter(p => (p.criadoEm || '').slice(0, 10) === hoje);
            document.getElementById('pedidos-novos-count').textContent = pedidosCache.filter(p => p.status === 'novo').length;
            document.getElementById('pedidos-preparo-count').textContent = pedidosCache.filter(p => p.status === 'preparo').length;
            document.getElementById('pedidos-entregue-count').textContent = pedidosHoje.filter(p => p.status === 'entregue').length;
            const faturamentoHoje = pedidosHoje.filter(p => p.status !== 'cancelado').reduce((s, p) => s + (p.total || 0), 0);
            document.getElementById('pedidos-total-dia').textContent = `R$ ${faturamentoHoje.toFixed(2)}`;

            if (lista.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-5xl mb-4"></i>
                        <p class="text-lg font-semibold">${pedidosFiltro === 'todos' ? 'Nenhum pedido ainda' : 'Nenhum pedido com este status'}</p>
                        <p class="text-sm">Quando clientes fizerem pedidos pelo cardapio digital, eles aparecerao aqui.</p>
                    </div>`;
                return;
            }

            const statusConfig = {
                novo: { cor: 'yellow', icone: 'fa-clock', texto: 'Novo' },
                preparo: { cor: 'blue', icone: 'fa-fire', texto: 'Em Preparo' },
                entregue: { cor: 'green', icone: 'fa-check-circle', texto: 'Entregue' },
                cancelado: { cor: 'red', icone: 'fa-times-circle', texto: 'Cancelado' }
            };

            container.innerHTML = lista.map(p => {
                const st = statusConfig[p.status] || statusConfig.novo;
                const data = p.criadoEm ? new Date(p.criadoEm).toLocaleString('pt-BR') : '';
                const itensResumo = (p.itens || []).map(i => `${i.qtd}x ${i.nome}`).join(', ');
                return `
                    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-${st.cor}-500 hover:shadow-lg transition-shadow">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="bg-${st.cor}-100 text-${st.cor}-800 text-xs font-bold py-1 px-3 rounded-full"><i class="fas ${st.icone} mr-1"></i>${st.texto}</span>
                                    <span class="font-bold text-gray-800">#${p.numeroPedido || '???'}</span>
                                    <span class="text-xs text-gray-400">${data}</span>
                                </div>
                                <div class="text-sm text-gray-700">
                                    <p><i class="fas fa-user text-gray-400 mr-1 w-4"></i><strong>${p.cliente || 'Sem nome'}</strong> ${p.telefone ? `<a href="https://wa.me/55${(p.telefone||'').replace(/\D/g,'')}" target="_blank" class="text-green-600 text-xs ml-1"><i class="fab fa-whatsapp"></i> ${p.telefone}</a>` : ''}</p>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-shopping-bag text-gray-400 mr-1 w-4"></i>${itensResumo || 'Sem itens'}</p>
                                    ${p.tipoEntrega === 'entrega' && p.endereco ? `<p class="text-xs text-gray-500"><i class="fas fa-map-marker-alt text-gray-400 mr-1 w-4"></i>${p.endereco}${p.bairro ? ', ' + p.bairro : ''}</p>` : ''}
                                    <p class="text-xs text-gray-500"><i class="fas fa-credit-card text-gray-400 mr-1 w-4"></i>${p.pagamentoNome || p.pagamento || ''} | ${p.tipoEntrega === 'entrega' ? 'Delivery' : 'Retirada'}</p>
                                </div>
                            </div>
                            <div class="text-right flex flex-col items-end gap-2">
                                <div class="text-xl font-bold text-green-600">R$ ${(p.total || 0).toFixed(2)}</div>
                                <div class="flex gap-1">
                                    ${p.status === 'novo' ? `<button onclick="atualizarStatusPedido('${p.id}','preparo')" class="bg-blue-500 text-white text-xs font-bold py-1.5 px-3 rounded-lg hover:bg-blue-600"><i class="fas fa-fire mr-1"></i>Preparar</button>` : ''}
                                    ${p.status === 'preparo' ? `<button onclick="atualizarStatusPedido('${p.id}','entregue')" class="bg-green-500 text-white text-xs font-bold py-1.5 px-3 rounded-lg hover:bg-green-600"><i class="fas fa-check mr-1"></i>Entregue</button>` : ''}
                                    ${p.status !== 'cancelado' && p.status !== 'entregue' ? `<button onclick="atualizarStatusPedido('${p.id}','cancelado')" class="bg-red-100 text-red-600 text-xs font-bold py-1.5 px-3 rounded-lg hover:bg-red-200"><i class="fas fa-times mr-1"></i>Cancelar</button>` : ''}
                                    <button onclick="imprimirPedidoAdmin('${p.id}')" class="bg-gray-100 text-gray-600 text-xs font-bold py-1.5 px-3 rounded-lg hover:bg-gray-200"><i class="fas fa-print mr-1"></i></button>
                                </div>
                            </div>
                        </div>
                        ${p.observacoes ? `<div class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg"><i class="fas fa-sticky-note mr-1"></i>${p.observacoes}</div>` : ''}
                    </div>`;
            }).join('');
        }

        window.atualizarStatusPedido = async function(pedidoId, novoStatus) {
            if (!window.appState.userId) return;
            try {
                const pedidoRef = doc(db, `artifacts/${appId}/users/${window.appState.userId}/pedidos/${pedidoId}`);
                await setDoc(pedidoRef, { status: novoStatus, atualizadoEm: new Date().toISOString() }, { merge: true });
                const pedido = pedidosCache.find(p => p.id === pedidoId);
                if (pedido) pedido.status = novoStatus;
                renderPedidos();
                atualizarBadgePedidos();
            } catch (e) {
                console.error('Erro ao atualizar pedido:', e);
                alert('Erro ao atualizar status do pedido.');
            }
        };

        window.imprimirPedidoAdmin = function(pedidoId) {
            const p = pedidosCache.find(x => x.id === pedidoId);
            if (!p) return;
            const agora = p.criadoEm ? new Date(p.criadoEm).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR');
            let itensHtml = '';
            (p.itens || []).forEach(item => {
                itensHtml += `<tr><td style="padding:2px 0;text-align:left">${item.qtd}x ${item.nome}</td><td style="padding:2px 0;text-align:right">R$ ${(item.preco * item.qtd).toFixed(2)}</td></tr>`;
                if (item.obs) itensHtml += `<tr><td colspan="2" style="padding:0 0 2px 15px;font-size:11px;color:#666;">* ${item.obs}</td></tr>`;
            });
            const nomeLoja = cardapioConfig?.nomeLoja || 'Restaurante';
            const printHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Pedido #${p.numeroPedido}</title>
<style>@page{margin:5mm;size:80mm auto}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Courier New',monospace;font-size:13px;width:72mm;margin:0 auto;color:#000}.center{text-align:center}.bold{font-weight:bold}.line{border-top:1px dashed #000;margin:6px 0}.double-line{border-top:2px solid #000;margin:6px 0}table{width:100%;border-collapse:collapse}td{font-size:12px;vertical-align:top}.total-row td{font-size:16px;font-weight:bold;padding-top:4px}@media print{body{width:100%}}</style></head><body>
<div class="center"><div class="bold" style="font-size:16px">${nomeLoja}</div></div>
<div class="double-line"></div>
<div class="center bold" style="font-size:14px">PEDIDO #${p.numeroPedido}</div>
<div class="center" style="font-size:11px">${agora}</div>
<div class="line"></div>
<div><strong>Cliente:</strong> ${p.cliente || ''}<br>${p.telefone ? `<strong>Fone:</strong> ${p.telefone}<br>` : ''}<strong>Entrega:</strong> ${p.tipoEntrega === 'entrega' ? 'DELIVERY' : 'RETIRADA'}${p.tipoEntrega === 'entrega' && p.endereco ? `<br><strong>End:</strong> ${p.endereco}${p.bairro ? ', ' + p.bairro : ''}` : ''}<br><strong>Pgto:</strong> ${p.pagamentoNome || p.pagamento || ''}</div>
<div class="double-line"></div>
<div class="bold">ITENS DO PEDIDO</div>
<table>${itensHtml}</table>
<div class="line"></div>
<table><tr><td>Subtotal</td><td style="text-align:right">R$ ${(p.subtotal || 0).toFixed(2)}</td></tr>
${p.desconto > 0 ? `<tr><td>Desconto${p.cupom ? ' (' + p.cupom + ')' : ''}</td><td style="text-align:right;color:green">-R$ ${p.desconto.toFixed(2)}</td></tr>` : ''}
${p.taxaEntrega > 0 ? `<tr><td>Entrega</td><td style="text-align:right">R$ ${p.taxaEntrega.toFixed(2)}</td></tr>` : ''}</table>
<div class="double-line"></div>
<table><tr class="total-row"><td>TOTAL</td><td style="text-align:right">R$ ${(p.total || 0).toFixed(2)}</td></tr></table>
<div class="double-line"></div>
${p.observacoes ? `<div><strong>OBS:</strong> ${p.observacoes}</div><div class="line"></div>` : ''}
<div class="center" style="font-size:11px;color:#555;margin-top:6px">Obrigado pela preferencia!</div>
</body></html>`;
            const w = window.open('', '_blank', 'width=350,height=600');
            w.document.write(printHtml);
            w.document.close();
            w.onload = function() { w.print(); };
        };

        // === DASHBOARD FUNCTIONS ===
        let dashPriceChart = null;
        let dashCostChart = null;

        function atualizarDashboardSelects() {
            const produtos = window.appState.produtosCache();
            const select1 = document.getElementById('dash-produto-select');
            const select2 = document.getElementById('dash-be-produto');
            if (!select1 || !select2) return;

            select1.innerHTML = '<option value="todos">Todos os Produtos</option>';
            select2.innerHTML = '<option value="">Selecione um produto</option>';
            produtos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(p => {
                const opt1 = document.createElement('option');
                opt1.value = p.id;
                opt1.textContent = p.nome;
                select1.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = p.id;
                opt2.textContent = p.nome;
                select2.appendChild(opt2);
            });
        }

        function atualizarDashboardCards() {
            const produtos = window.appState.produtosCache();
            const insumos = window.appState.insumosCache();
            const config = window.appState.configCache();

            document.getElementById('dash-total-produtos').textContent = produtos.length;
            document.getElementById('dash-total-insumos').textContent = insumos.length;

            if (produtos.length > 0) {
                const custoMedio = produtos.reduce((sum, p) => sum + calcularCustoProduto(p.id), 0) / produtos.length;
                document.getElementById('dash-custo-medio').textContent = `R$ ${custoMedio.toFixed(2)}`;
            }

            const totalCustos = (config.custosOperacionais || []).reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;
            const custoOp = faturamento > 0 ? ((totalCustos / faturamento) * 100).toFixed(1) : '0';
            document.getElementById('dash-custo-op').textContent = custoOp + '%';
        }

        window.gerarDashboard = function() {
            const produtos = window.appState.produtosCache();
            const config = window.appState.configCache();
            const canais = config.canaisVenda || [];
            const margemInput = parseFloat(document.getElementById('dash-margem').value) / 100;
            const produtoFiltro = document.getElementById('dash-produto-select').value;

            if (isNaN(margemInput) || margemInput <= 0 || margemInput >= 1) {
                alert("Margem de lucro deve ser entre 1% e 99%.");
                return;
            }
            if (canais.length === 0) {
                alert("Cadastre canais de venda nas Configurações primeiro.");
                return;
            }
            if (produtos.length === 0) {
                alert("Cadastre produtos primeiro.");
                return;
            }

            const totalCustosOp = (config.custosOperacionais || []).reduce((s, c) => s + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 1;
            const custoOpPerc = totalCustosOp / faturamento;
            const denominadorBase = 1 - custoOpPerc - margemInput;

            if (denominadorBase <= 0) {
                alert("Custo operacional + margem >= 100%. Ajuste nas configurações.");
                return;
            }

            const produtosParaAnalise = produtoFiltro === 'todos'
                ? produtos
                : produtos.filter(p => p.id === produtoFiltro);

            // Generate profitability table
            let tabelaHtml = `<table class="min-w-full bg-white text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                        <th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">Custo</th>`;
            canais.forEach(c => {
                tabelaHtml += `<th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">${c.nome}</th>`;
            });
            tabelaHtml += `<th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">Lucro/Un</th>
                        <th class="py-2 px-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr></thead><tbody class="divide-y divide-gray-200">`;

            const chartLabels = [];
            const chartDatasets = [];
            const coresCanais = ['#6366f1', '#f97316', '#10b981', '#ef4444', '#8b5cf6', '#06b6d4'];

            canais.forEach((canal, idx) => {
                chartDatasets.push({
                    label: canal.nome,
                    data: [],
                    backgroundColor: coresCanais[idx % coresCanais.length],
                    borderRadius: 4
                });
            });

            let totalLucroEstimado = 0;
            let produtoMaisRentavel = { nome: '', margem: 0 };
            let produtoMenosRentavel = { nome: '', margem: 100 };

            produtosParaAnalise.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(produto => {
                const custo = calcularCustoProduto(produto.id);
                const precoBase = custo / denominadorBase;
                const lucroBase = precoBase * margemInput;
                chartLabels.push(produto.nome.length > 20 ? produto.nome.substring(0, 20) + '...' : produto.nome);

                const margemReal = custo > 0 ? ((precoBase - custo) / precoBase * 100) : 0;
                if (margemReal > produtoMaisRentavel.margem) produtoMaisRentavel = { nome: produto.nome, margem: margemReal };
                if (margemReal < produtoMenosRentavel.margem && custo > 0) produtoMenosRentavel = { nome: produto.nome, margem: margemReal };

                tabelaHtml += `<tr>
                    <td class="py-2 px-3 font-medium text-gray-900">${produto.nome}</td>
                    <td class="py-2 px-3 text-right text-gray-600">R$ ${custo.toFixed(2)}</td>`;

                canais.forEach((canal, idx) => {
                    const taxas = parseFloat(canal.taxaComissao) + parseFloat(canal.taxaTransacao);
                    const denomCanal = 1 - taxas - custoOpPerc - margemInput;
                    const precoFinal = denomCanal > 0 ? custo / denomCanal : 0;
                    chartDatasets[idx].data.push(precoFinal.toFixed(2));
                    tabelaHtml += `<td class="py-2 px-3 text-right font-semibold text-indigo-600">R$ ${precoFinal.toFixed(2)}</td>`;
                });

                totalLucroEstimado += lucroBase;
                const statusColor = custo === 0 ? 'text-gray-400' : lucroBase > 0 ? 'text-green-600' : 'text-red-600';
                const statusIcon = custo === 0 ? 'fa-question' : lucroBase > 0 ? 'fa-check-circle' : 'fa-times-circle';

                tabelaHtml += `<td class="py-2 px-3 text-right font-bold text-green-600">R$ ${lucroBase.toFixed(2)}</td>
                    <td class="py-2 px-3 text-center ${statusColor}"><i class="fas ${statusIcon}"></i></td></tr>`;
            });

            tabelaHtml += `</tbody></table>`;
            document.getElementById('dash-tabela-rentabilidade').innerHTML = tabelaHtml;

            // Price comparison chart
            const chartContainer = document.getElementById('dash-chart-container');
            chartContainer.classList.remove('hidden');
            if (dashPriceChart) dashPriceChart.destroy();
            const ctx = document.getElementById('dash-price-chart').getContext('2d');
            dashPriceChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: chartLabels, datasets: chartDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': R$ ' + parseFloat(context.raw).toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return 'R$ ' + value; }
                            }
                        }
                    }
                }
            });

            // Cost structure chart
            const custosOp = config.custosOperacionais || [];
            if (custosOp.length > 0) {
                if (dashCostChart) dashCostChart.destroy();
                const costCtx = document.getElementById('dash-cost-chart').getContext('2d');
                const costLabels = custosOp.map(c => c.nome || 'Sem nome');
                const costValues = custosOp.map(c => parseFloat(c.valor) || 0);
                const costColors = ['#6366f1', '#f97316', '#10b981', '#ef4444', '#8b5cf6', '#06b6d4', '#f59e0b', '#ec4899', '#14b8a6', '#84cc16'];
                dashCostChart = new Chart(costCtx, {
                    type: 'doughnut',
                    data: {
                        labels: costLabels,
                        datasets: [{
                            data: costValues,
                            backgroundColor: costColors.slice(0, costLabels.length),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 11 } } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const perc = ((context.raw / total) * 100).toFixed(1);
                                        return context.label + ': R$ ' + context.raw.toFixed(2) + ' (' + perc + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Insights
            const insightsContainer = document.getElementById('dash-insights');
            let insightsHtml = '';

            insightsHtml += `<div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                <p class="text-sm font-semibold text-indigo-800"><i class="fas fa-trophy mr-1"></i> Mais Rentável</p>
                <p class="text-xs text-indigo-600">${produtoMaisRentavel.nome} (margem ${produtoMaisRentavel.margem.toFixed(1)}%)</p>
            </div>`;

            if (produtoMenosRentavel.nome) {
                insightsHtml += `<div class="p-3 bg-red-50 rounded-lg border border-red-200">
                    <p class="text-sm font-semibold text-red-800"><i class="fas fa-exclamation-triangle mr-1"></i> Menos Rentável</p>
                    <p class="text-xs text-red-600">${produtoMenosRentavel.nome} (margem ${produtoMenosRentavel.margem.toFixed(1)}%)</p>
                </div>`;
            }

            const custoOpPercDisplay = (custoOpPerc * 100).toFixed(1);
            const classeCustoOp = custoOpPerc > 0.35 ? 'bg-red-50 border-red-200 text-red-800' : custoOpPerc > 0.25 ? 'bg-yellow-50 border-yellow-200 text-yellow-800' : 'bg-green-50 border-green-200 text-green-800';
            insightsHtml += `<div class="p-3 ${classeCustoOp} rounded-lg border">
                <p class="text-sm font-semibold"><i class="fas fa-percentage mr-1"></i> Custo Operacional: ${custoOpPercDisplay}%</p>
                <p class="text-xs">${custoOpPerc > 0.35 ? 'Acima do ideal (>35%). Revise seus custos.' : custoOpPerc > 0.25 ? 'Atenção (25-35%). Busque otimizar.' : 'Saudável (<25%). Bom controle de custos.'}</p>
            </div>`;

            // iFood specific insight
            const canalIfood = canais.find(c => c.nome.toLowerCase().includes('ifood'));
            if (canalIfood) {
                const taxasIfoodVal = parseFloat(canalIfood.taxaComissao) + parseFloat(canalIfood.taxaTransacao);
                const taxaIfood = (taxasIfoodVal * 100).toFixed(1);
                const denomBase = 1 - custoOpPerc - margemInput;
                const denomIfood = 1 - taxasIfoodVal - custoOpPerc - margemInput;
                const diffPerc = denomIfood > 0 && denomBase > 0 ? ((denomBase / denomIfood - 1) * 100).toFixed(0) : '---';
                insightsHtml += `<div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <p class="text-sm font-semibold text-orange-800"><i class="fas fa-motorcycle mr-1"></i> Taxas iFood: ${taxaIfood}%</p>
                    <p class="text-xs text-orange-600">Com margem de ${(margemInput * 100).toFixed(0)}%, seu preço no iFood é ~${diffPerc}% maior que o preço de balcão.</p>
                </div>`;
            }

            insightsHtml += `<div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm font-semibold text-gray-800"><i class="fas fa-coins mr-1"></i> Lucro Estimado por Venda Completa</p>
                <p class="text-xs text-gray-600">Se vender 1 de cada produto: R$ ${totalLucroEstimado.toFixed(2)} de lucro bruto</p>
            </div>`;

            insightsContainer.innerHTML = insightsHtml;
        }

        // Break-Even Calculator
        window.calcularBreakEven = function() {
            const produtoId = document.getElementById('dash-be-produto').value;
            const comissao = parseFloat(document.getElementById('dash-be-plano').value);
            const descontoPerc = parseFloat(document.getElementById('dash-be-desconto').value) / 100;
            const resultadoContainer = document.getElementById('dash-be-resultado');

            if (!produtoId) {
                alert("Selecione um produto.");
                return;
            }
            if (isNaN(descontoPerc) || descontoPerc <= 0 || descontoPerc >= 1) {
                alert("Desconto deve ser entre 1% e 99%.");
                return;
            }

            const config = window.appState.configCache();
            const produtos = window.appState.produtosCache();
            const produto = produtos.find(p => p.id === produtoId);
            const custoProduto = calcularCustoProduto(produtoId);
            const totalCustosOp = (config.custosOperacionais || []).reduce((s, c) => s + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 1;
            const custoOpPerc = totalCustosOp / faturamento;
            const margemInput = parseFloat(document.getElementById('dash-margem').value) / 100 || 0.35;
            const denominadorBase = 1 - custoOpPerc - margemInput;

            if (denominadorBase <= 0) {
                alert("Custo operacional + margem >= 100%.");
                return;
            }

            const taxaTransacao = 0.032; // taxa de pagamento online iFood (3,2%)
            const taxaTotal = comissao + taxaTransacao;

            // Fórmula de markup divisor: inclui taxas do canal no denominador
            const denominadorCanal = 1 - taxaTotal - custoOpPerc - margemInput;
            if (denominadorCanal <= 0) {
                alert(`Inviável: Taxas (${(taxaTotal*100).toFixed(1)}%) + Custo Op. (${(custoOpPerc*100).toFixed(1)}%) + Margem (${(margemInput*100).toFixed(1)}%) >= 100%`);
                return;
            }
            const precoFinal = custoProduto / denominadorCanal;
            const descontoValor = precoFinal * descontoPerc;
            const precoPromo = precoFinal - descontoValor;

            // Decomposição do preço
            const comissaoValor = precoFinal * taxaTotal;
            const custoOpPorPrato = precoFinal * custoOpPerc;
            const liquidoOriginal = precoFinal * (1 - taxaTotal);
            const liquidoPromo = precoPromo - comissaoValor; // comissão sobre preço original no iFood
            const lucroOriginal = liquidoOriginal - custoProduto - custoOpPorPrato;
            const lucroPromo = liquidoPromo - custoProduto - custoOpPorPrato;

            const isPreju = lucroPromo < 0;
            const aumentoNecessario = lucroPromo > 0 ? ((lucroOriginal / lucroPromo) - 1) * 100 : Infinity;

            // Desconto máximo = lucro original (quando lucro promo chega a zero)
            const descontoMaximo = Math.max(0, lucroOriginal);
            const descontoMaximoPerc = precoFinal > 0 ? (descontoMaximo / precoFinal) * 100 : 0;

            let html = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-gray-800 mb-3"><i class="fas fa-receipt mr-1 text-indigo-500"></i> Análise sem Promoção</h4>
                    <div class="space-y-1 text-sm">
                        <p>Produto: <span class="font-semibold float-right">${produto.nome}</span></p>
                        <p>Custo insumos: <span class="float-right">R$ ${custoProduto.toFixed(2)}</span></p>
                        <p>Custo operacional (${(custoOpPerc * 100).toFixed(1)}%): <span class="float-right">R$ ${custoOpPorPrato.toFixed(2)}</span></p>
                        <p>Preço no iFood: <span class="font-semibold float-right">R$ ${precoFinal.toFixed(2)}</span></p>
                        <p>Comissão (${(taxaTotal * 100).toFixed(1)}%): <span class="text-red-500 float-right">- R$ ${comissaoValor.toFixed(2)}</span></p>
                        <p class="border-t pt-1 font-bold">Recebido: <span class="text-blue-600 float-right">R$ ${liquidoOriginal.toFixed(2)}</span></p>
                        <p class="font-bold text-green-600">Lucro: <span class="float-right">R$ ${lucroOriginal.toFixed(2)}</span></p>
                    </div>
                </div>
                <div class="p-4 border-2 rounded-lg ${isPreju ? 'bg-red-50 border-red-300' : 'bg-orange-50 border-orange-300'}">
                    <h4 class="font-bold text-gray-800 mb-3"><i class="fas fa-tag mr-1 text-orange-500"></i> Com ${(descontoPerc * 100).toFixed(0)}% de Desconto</h4>
                    <div class="space-y-1 text-sm">
                        <p>Preço promocional: <span class="font-semibold float-right">R$ ${precoPromo.toFixed(2)}</span></p>
                        <p>Desconto: <span class="text-orange-500 float-right">- R$ ${descontoValor.toFixed(2)}</span></p>
                        <p class="text-red-500">Comissão sobre R$ ${precoFinal.toFixed(2)}: <span class="float-right">- R$ ${comissaoValor.toFixed(2)}</span></p>
                        <p class="border-t pt-1 font-bold">Recebido: <span class="text-blue-600 float-right">R$ ${liquidoPromo.toFixed(2)}</span></p>
                        <p class="font-bold ${isPreju ? 'text-red-600' : 'text-green-600'}">
                            Lucro: <span class="float-right">R$ ${lucroPromo.toFixed(2)}</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="${isPreju ? 'alert-danger' : aumentoNecessario > 100 ? 'alert-warning' : 'alert-success'}">
                    <p class="font-bold text-sm">${isPreju ? '<i class="fas fa-times-circle mr-1"></i> PREJUÍZO!' : '<i class="fas fa-arrow-up mr-1"></i> Aumento de vendas necessário'}</p>
                    <p class="text-2xl font-bold mt-1">${isPreju ? 'Inviável' : aumentoNecessario.toFixed(0) + '%'}</p>
                    <p class="text-xs mt-1">${isPreju ? 'Você perde dinheiro a cada venda!' : 'Precisa vender ' + aumentoNecessario.toFixed(0) + '% mais para manter o mesmo lucro total'}</p>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="font-bold text-sm text-blue-800"><i class="fas fa-shield-alt mr-1"></i> Desconto máximo seguro</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${descontoMaximoPerc > 0 ? descontoMaximoPerc.toFixed(1) + '%' : '0%'}</p>
                    <p class="text-xs text-blue-600 mt-1">Máximo antes de ter prejuízo (R$ ${descontoMaximo > 0 ? descontoMaximo.toFixed(2) : '0.00'})</p>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <p class="font-bold text-sm text-purple-800"><i class="fas fa-info-circle mr-1"></i> Impacto por unidade</p>
                    <p class="text-2xl font-bold text-purple-600 mt-1">- R$ ${(lucroOriginal - lucroPromo).toFixed(2)}</p>
                    <p class="text-xs text-purple-600 mt-1">Redução de lucro por unidade vendida</p>
                </div>
            </div>`;

            resultadoContainer.innerHTML = html;
            resultadoContainer.classList.remove('hidden');
        }

        // Input validation for margem de lucro
        document.getElementById('margem-lucro-input').addEventListener('change', function() {
            const val = parseFloat(this.value);
            if (val < 0) this.value = 0;
            if (val > 99) this.value = 99;
        });

        // === ANÁLISE ESTRATÉGICA - Engenharia de Cardápio ===
        window.vendasRegistradas = {};
        let vendasRegistradas = window.vendasRegistradas;

        window.renderRegistroVendas = function renderRegistroVendas() {
            const container = document.getElementById('lista-registro-vendas');
            if (!container) return;
            const produtos = window.appState.produtosCache();
            if (produtos.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Cadastre produtos primeiro para registrar vendas.</p>';
                return;
            }
            let html = `<table class="min-w-full bg-white text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                        <th class="py-2 px-4 text-center text-xs font-medium text-gray-500 uppercase">Qtd. Vendida</th>
                        <th class="py-2 px-4 text-right text-xs font-medium text-gray-500 uppercase">Custo Unit.</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">`;
            produtos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(p => {
                const custo = calcularCustoProduto(p.id);
                const qtdAtual = vendasRegistradas[p.id] || 0;
                html += `<tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 font-medium text-gray-900">${p.nome}</td>
                    <td class="py-2 px-4 text-center">
                        <input type="number" min="0" value="${qtdAtual}" onchange="vendasRegistradas['${p.id}'] = parseInt(this.value) || 0"
                            class="w-20 p-1 border border-gray-300 rounded-md text-center">
                    </td>
                    <td class="py-2 px-4 text-right text-gray-600">R$ ${custo.toFixed(2)}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        window.analisarVendas = function() {
            const produtos = window.appState.produtosCache();
            const config = window.appState.configCache();
            const canal = document.getElementById('canal-analise').value;
            if (!canal) {
                alert('Selecione um canal de venda.');
                return;
            }

            const canais = config.canaisVenda || [];
            const canalObj = canais.find(c => c.nome === canal);
            if (!canalObj) {
                alert('Canal de venda não encontrado nas configurações.');
                return;
            }

            const totalCustosOp = (config.custosOperacionais || []).reduce((s, c) => s + parseFloat(c.valor), 0);
            const faturamento = parseFloat(config.faturamentoMedioMensal) || 1;
            const custoOpPerc = totalCustosOp / faturamento;

            // Classificar produtos pela Engenharia de Cardápio (BCG Matrix)
            let dadosProdutos = [];
            let totalVendas = 0;
            let totalLucro = 0;

            produtos.forEach(p => {
                const qtdVendida = vendasRegistradas[p.id] || 0;
                const custo = calcularCustoProduto(p.id);
                const taxas = parseFloat(canalObj.taxaComissao) + parseFloat(canalObj.taxaTransacao);
                const margem = 0.35; // margem padrão para análise
                const denomCanal = 1 - taxas - custoOpPerc - margem;
                const precoFinal = denomCanal > 0 ? custo / denomCanal : 0;
                const lucroUnit = precoFinal * margem;
                const lucroTotal = lucroUnit * qtdVendida;

                totalVendas += qtdVendida;
                totalLucro += lucroTotal;

                dadosProdutos.push({
                    nome: p.nome,
                    qtdVendida,
                    custo,
                    precoFinal,
                    lucroUnit,
                    lucroTotal,
                    margemPerc: precoFinal > 0 ? ((precoFinal - custo) / precoFinal * 100) : 0
                });
            });

            // Calcular médias para classificação
            const mediaVendas = totalVendas / Math.max(dadosProdutos.filter(p => p.qtdVendida > 0).length, 1);
            const mediaLucro = dadosProdutos.filter(p => p.qtdVendida > 0).reduce((s, p) => s + p.lucroUnit, 0) / Math.max(dadosProdutos.filter(p => p.qtdVendida > 0).length, 1);

            // Classificar: Estrela (alto vol, alto lucro), Burro de carga (alto vol, baixo lucro), Quebra-cabeça (baixo vol, alto lucro), Cão (baixo vol, baixo lucro)
            dadosProdutos.forEach(p => {
                if (p.qtdVendida === 0) {
                    p.categoria = 'Sem dados';
                    p.catIcon = 'fa-question-circle';
                    p.catColor = 'text-gray-400';
                } else if (p.qtdVendida >= mediaVendas && p.lucroUnit >= mediaLucro) {
                    p.categoria = 'Estrela';
                    p.catIcon = 'fa-star';
                    p.catColor = 'text-yellow-500';
                } else if (p.qtdVendida >= mediaVendas && p.lucroUnit < mediaLucro) {
                    p.categoria = 'Burro de carga';
                    p.catIcon = 'fa-horse';
                    p.catColor = 'text-blue-500';
                } else if (p.qtdVendida < mediaVendas && p.lucroUnit >= mediaLucro) {
                    p.categoria = 'Quebra-cabeça';
                    p.catIcon = 'fa-puzzle-piece';
                    p.catColor = 'text-purple-500';
                } else {
                    p.categoria = 'Cão';
                    p.catIcon = 'fa-dog';
                    p.catColor = 'text-red-500';
                }
            });

            // Renderizar resultado
            const container = document.getElementById('container-analise');
            let html = '';

            // Tabela de classificação
            html += `<div class="lg:col-span-2">
                <table class="min-w-full bg-white text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                            <th class="py-2 px-3 text-center text-xs font-medium text-gray-500 uppercase">Vendas</th>
                            <th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">Lucro/Un</th>
                            <th class="py-2 px-3 text-right text-xs font-medium text-gray-500 uppercase">Lucro Total</th>
                            <th class="py-2 px-3 text-center text-xs font-medium text-gray-500 uppercase">Classificação</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">`;

            dadosProdutos.sort((a, b) => b.lucroTotal - a.lucroTotal).forEach(p => {
                html += `<tr class="hover:bg-gray-50">
                    <td class="py-2 px-3 font-medium text-gray-900">${p.nome}</td>
                    <td class="py-2 px-3 text-center">${p.qtdVendida}</td>
                    <td class="py-2 px-3 text-right text-green-600 font-semibold">R$ ${p.lucroUnit.toFixed(2)}</td>
                    <td class="py-2 px-3 text-right font-bold">R$ ${p.lucroTotal.toFixed(2)}</td>
                    <td class="py-2 px-3 text-center ${p.catColor}"><i class="fas ${p.catIcon} mr-1"></i>${p.categoria}</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;

            // Legenda e insights
            html += `<div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-bold text-gray-800 mb-3">Legenda - Engenharia de Cardápio</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center"><i class="fas fa-star text-yellow-500 mr-2 w-5"></i><strong>Estrela:</strong><span class="ml-1 text-gray-600">Alto volume + alto lucro. Promova!</span></div>
                    <div class="flex items-center"><i class="fas fa-horse text-blue-500 mr-2 w-5"></i><strong>Burro de carga:</strong><span class="ml-1 text-gray-600">Vende muito mas lucro baixo. Ajuste o preço.</span></div>
                    <div class="flex items-center"><i class="fas fa-puzzle-piece text-purple-500 mr-2 w-5"></i><strong>Quebra-cabeça:</strong><span class="ml-1 text-gray-600">Lucro alto mas vende pouco. Invista em divulgação.</span></div>
                    <div class="flex items-center"><i class="fas fa-dog text-red-500 mr-2 w-5"></i><strong>Cão:</strong><span class="ml-1 text-gray-600">Pouco volume e pouco lucro. Considere remover.</span></div>
                </div>
            </div>`;

            // Resumo geral
            html += `<div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <h3 class="font-bold text-indigo-800 mb-2">Resumo do Período</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><span class="text-gray-600">Total vendas:</span> <strong>${totalVendas}</strong></div>
                    <div><span class="text-gray-600">Lucro estimado:</span> <strong class="text-green-600">R$ ${totalLucro.toFixed(2)}</strong></div>
                    <div><span class="text-gray-600">Canal:</span> <strong>${canal}</strong></div>
                    <div><span class="text-gray-600">Produtos analisados:</span> <strong>${dadosProdutos.filter(p => p.qtdVendida > 0).length}</strong></div>
                </div>
            </div>`;

            container.innerHTML = html;
            document.getElementById('resultado-analise-cardapio').classList.remove('hidden');
        }

        // ESC to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') fecharModal();
        });
        // Click outside modal to close
        document.getElementById('modal-backdrop').addEventListener('click', function(e) {
            if (e.target === this) fecharModal();
        });
    </script>
</body>
</html>
