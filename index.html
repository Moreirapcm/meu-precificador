Peço desculpas por isso. O botão "Preview" é uma funcionalidade da plataforma e, por vezes, pode não ser exibido corretamente.

Mas não se preocupe, há uma forma muito simples de contornar isso. Vou fornecer o código completo novamente abaixo. Você pode copiá-lo e executá-lo diretamente no seu computador.

**Siga estes 3 passos:**

1.  **Copie o código:** Clique no botão de cópia no canto superior direito do bloco de código abaixo.
2.  **Salve o arquivo:** Abra um editor de texto simples (como o Bloco de Notas) e cole o código. Salve o arquivo com um nome que termine em `.html` (por exemplo: `precificador.html`).
3.  **Abra no navegador:** Encontre o arquivo que você acabou de salvar no seu computador e dê um duplo clique sobre ele. Ele abrirá no seu navegador de internet (Google Chrome, Firefox, etc.) e você poderá ver a aplicação funcionando.

Aqui está o código completo e melhorado:

\<div class="lang-format-container"\>
\<div class="lang-format-header"\>
\<div class="lang-format-tag"\>html\</div\>
\<div class="lang-format-copy-container"\>
\<button class="lang-format-copy-button"\>
\<svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" height="24" viewBox="0 -960 960 960" width="24"\>
\<path d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-160v-480 480Z"\>\</path\>
\</svg\>
Copy code
\</button\>
\</div\>
\</div\>
\<pre class="lang-format-pre"\>\<code class="lang-format-code"\>
\&lt;\!DOCTYPE html\&gt;
\&lt;html lang=\&quot;pt-BR\&quot;\&gt;
\&lt;head\&gt;
\&lt;meta charset=\&quot;UTF-8\&quot;\&gt;
\&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1.0\&quot;\&gt;
\&lt;title\&gt;Precificador Show de Delicias - Versão Melhorada\&lt;/title\&gt;
\&lt;script src=\&quot;[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)\&quot;\&gt;\&lt;/script\&gt;
\&lt;link href=\&quot;[https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700\&amp;display=swap\&quot](https://www.google.com/search?q=https://fonts.googleapis.com/css2%3Ffamily%3DInter:wght%40400%3B500%3B600%3B700%26amp%3Bdisplay%3Dswap%26quot); rel=\&quot;stylesheet\&quot;\&gt;
\&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\&quot;\&gt](https://www.google.com/search?q=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css%26quot%3B%26gt);
\&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;[https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css\&quot;/\&gt](https://www.google.com/search?q=https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css%26quot%3B/%26gt);
\&lt;script src=\&quot;[https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js\&quot;\&gt;\&lt;/script\&gt](https://www.google.com/search?q=https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js%26quot%3B%26gt%3B%26lt%3B/script%26gt);
\&lt;\!-- Adicionando Chart.js para gráficos --\&gt;
\&lt;script src=\&quot;[https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js\&quot;\&gt;\&lt;/script\&gt](https://www.google.com/search?q=https://cdn.jsdelivr.net/npm/chart.js%404.4.1/dist/chart.umd.min.js%26quot%3B%26gt%3B%26lt%3B/script%26gt);
\&lt;style\&gt;
body {
font-family: 'Inter', sans-serif;
background-color: \#f3f4f6;
}
.modal-backdrop {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background-color: rgba(0, 0, 0, 0.5); z-index: 40;
display: flex; justify-content: center; align-items: center;
}
.modal-content {
background-color: white; padding: 2rem; border-radius: 0.5rem;
width: 90%; max-width: 600px; max-height: 90vh;
overflow-y: auto; z-index: 50;
}
.tab-button.active {
border-bottom: 2px solid \#4f46e5; color: \#4f46e5; font-weight: 600;
}
.tooltip { position: relative; display: inline-block; }
.tooltip .tooltiptext {
visibility: hidden; width: 250px; background-color: \#555;
color: \#fff; text-align: center; border-radius: 6px;
padding: 5px; position: absolute; z-index: 1;
bottom: 125%; left: 50%; margin-left: -125px;
opacity: 0; transition: opacity 0.3s;
font-size: 0.8rem; font-weight: normal;
}
.tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
.spinner {
border: 2px solid \#f3f3f3; border-top: 2px solid \#4f46e5;
border-radius: 50%; width: 16px; height: 16px;
animation: spin 1s linear infinite; display: inline-block;
margin-right: 8px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
button:disabled { opacity: 0.5; cursor: not-allowed; }
\&lt;/style\&gt;
\&lt;/head\&gt;
\&lt;body class=\&quot;bg-gray-100 text-gray-800\&quot;\&gt;

```
&lt;div id=&quot;app&quot; class=&quot;container mx-auto p-4 md:p-8&quot;&gt;
    &lt;header class=&quot;mb-4 text-center&quot;&gt;
        &lt;h1 class=&quot;text-4xl font-bold text-indigo-600&quot;&gt;Precificador Show de Delícias&lt;/h1&gt;
        &lt;p class=&quot;text-lg text-gray-600 mt-2&quot;&gt;Sua ferramenta completa para uma gestão de preços inteligente e lucrativa.&lt;/p&gt;
    &lt;/header&gt;

    &lt;div id=&quot;db-status&quot; class=&quot;flex items-center justify-center mb-6 text-sm text-gray-600&quot;&gt;
        &lt;span id=&quot;db-status-dot&quot; class=&quot;h-3 w-3 rounded-full bg-yellow-400 mr-2 animate-pulse&quot;&gt;&lt;/span&gt;
        &lt;span id=&quot;db-status-text&quot;&gt;A ligar à base de dados...&lt;/span&gt;
    &lt;/div&gt;

    &lt;div class=&quot;flex flex-wrap justify-center border-b border-gray-200 mb-8&quot;&gt;
        &lt;button onclick=&quot;changeTab('simulador')&quot; class=&quot;tab-button active py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none&quot;&gt;
            &lt;i class=&quot;fas fa-calculator mr-2&quot;&gt;&lt;/i&gt; Simulador de Preços
        &lt;/button&gt;
        &lt;button onclick=&quot;changeTab('produtos')&quot; class=&quot;tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none&quot;&gt;
            &lt;i class=&quot;fas fa-utensils mr-2&quot;&gt;&lt;/i&gt; Produtos e Receitas
        &lt;/button&gt;
        &lt;button onclick=&quot;changeTab('insumos')&quot; class=&quot;tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none&quot;&gt;
            &lt;i class=&quot;fas fa-carrot mr-2&quot;&gt;&lt;/i&gt; Insumos
        &lt;/button&gt;
        &lt;button onclick=&quot;changeTab('analise')&quot; class=&quot;tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none&quot;&gt;
            &lt;i class=&quot;fas fa-chart-line mr-2&quot;&gt;&lt;/i&gt; Análise Estratégica
        &lt;/button&gt;
        &lt;button onclick=&quot;changeTab('configuracoes')&quot; class=&quot;tab-button py-4 px-6 text-gray-500 hover:text-indigo-600 focus:outline-none&quot;&gt;
            &lt;i class=&quot;fas fa-cogs mr-2&quot;&gt;&lt;/i&gt; Configurações
        &lt;/button&gt;
    &lt;/div&gt;

    &lt;main&gt;
        &lt;!-- ABA: Simulador de Preços --&gt;
        &lt;div id=&quot;simulador-tab&quot; class=&quot;space-y-8&quot;&gt;
            &lt;div class=&quot;bg-white p-6 rounded-lg shadow-md&quot;&gt;
                &lt;h2 class=&quot;text-2xl font-semibold mb-4 text-gray-700&quot;&gt;1. Selecione o Produto e a Margem de Lucro&lt;/h2&gt;
                &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-6&quot;&gt;
                    &lt;div&gt;
                        &lt;label for=&quot;produto-select&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Produto&lt;/label&gt;
                        &lt;select id=&quot;produto-select&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500&quot;&gt;&lt;/select&gt;
                    &lt;/div&gt;
                    &lt;div&gt;
                        &lt;label for=&quot;margem-lucro-input&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Margem de Lucro Líquida Desejada (%)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;margem-lucro-input&quot; value=&quot;20&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500&quot;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-6 text-center&quot;&gt;
                    &lt;button onclick=&quot;calcularPrecos()&quot; class=&quot;bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg&quot;&gt;
                        &lt;i class=&quot;fas fa-magic mr-2&quot;&gt;&lt;/i&gt; Calcular Preços
                    &lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div id=&quot;resultado-precificacao&quot; class=&quot;hidden bg-white p-6 rounded-lg shadow-md&quot;&gt;
                &lt;h2 class=&quot;text-2xl font-semibold mb-4 text-gray-700&quot;&gt;2. Resultado da Precificação&lt;/h2&gt;
                &lt;div id=&quot;resumo-produto&quot; class=&quot;mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200&quot;&gt;&lt;/div&gt;
                &lt;div id=&quot;tabela-precos&quot; class=&quot;overflow-x-auto&quot;&gt;&lt;/div&gt;
                &lt;div id=&quot;analise-ia-container&quot; class=&quot;mt-6 hidden&quot;&gt;
                    &lt;h3 class=&quot;text-xl font-semibold mb-2 text-gray-700&quot;&gt;✨ Análise Estratégica com IA&lt;/h3&gt;
                    &lt;div id=&quot;analise-ia-content&quot; class=&quot;p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-600 whitespace-pre-wrap&quot;&gt;&lt;/div&gt;
                &lt;/div&gt;
                
                &lt;!-- Simuladores Avançados --&gt;
                &lt;div id=&quot;simuladores-avancados&quot; class=&quot;mt-8 pt-6 border-t border-gray-200&quot;&gt;
                    &lt;h2 class=&quot;text-2xl font-semibold mb-4 text-gray-700&quot;&gt;3. Simuladores Comerciais&lt;/h2&gt;
                    &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-2 gap-8&quot;&gt;
                        &lt;!-- Simulador de Promoções --&gt;
                        &lt;div id=&quot;simulador-promocao&quot;&gt;
                            &lt;h3 class=&quot;text-xl font-semibold mb-4 text-gray-700&quot;&gt;Promoções iFood&lt;/h3&gt;
                            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-3 gap-6 items-end&quot;&gt;
                                &lt;div&gt;
                                    &lt;label for=&quot;desconto-cliente&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Desconto (R$)&lt;/label&gt;
                                    &lt;input type=&quot;number&quot; id=&quot;desconto-cliente&quot; value=&quot;5.00&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md shadow-sm&quot;&gt;
                                &lt;/div&gt;
                                &lt;div&gt;
                                    &lt;label for=&quot;subsidio-ifood&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Subsídio (R$)&lt;/label&gt;
                                    &lt;input type=&quot;number&quot; id=&quot;subsidio-ifood&quot; value=&quot;2.50&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md shadow-sm&quot;&gt;
                                &lt;/div&gt;
                                &lt;button onclick=&quot;simularPromocao()&quot; class=&quot;bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors h-10&quot;&gt;Simular&lt;/button&gt;
                            &lt;/div&gt;
                            &lt;div id=&quot;resultado-promocao&quot; class=&quot;mt-6 hidden&quot;&gt;&lt;/div&gt;
                        &lt;/div&gt;

                        &lt;!-- Simulador de Frete Embutido --&gt;
                        &lt;div id=&quot;simulador-frete&quot;&gt;
                            &lt;h3 class=&quot;text-xl font-semibold mb-4 text-gray-700&quot;&gt;Frete Embutido&lt;/h3&gt;
                            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-3 gap-6 items-end&quot;&gt;
                                &lt;div&gt;
                                    &lt;label for=&quot;custo-real-entrega&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Custo Entrega (R$)&lt;/label&gt;
                                    &lt;input type=&quot;number&quot; id=&quot;custo-real-entrega&quot; value=&quot;10.00&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md shadow-sm&quot;&gt;
                                &lt;/div&gt;
                                &lt;div&gt;
                                    &lt;label for=&quot;valor-pago-cliente&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Cliente Paga (R$)&lt;/label&gt;
                                    &lt;input type=&quot;number&quot; id=&quot;valor-pago-cliente&quot; value=&quot;0.00&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md shadow-sm&quot;&gt;
                                &lt;/div&gt;
                                &lt;button onclick=&quot;simularFreteEmbutido()&quot; class=&quot;bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors h-10&quot;&gt;Calcular&lt;/button&gt;
                            &lt;/div&gt;
                            &lt;div id=&quot;resultado-frete&quot; class=&quot;mt-6 hidden&quot;&gt;&lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- ABA: Produtos e Receitas --&gt;
        &lt;div id=&quot;produtos-tab&quot; class=&quot;hidden&quot;&gt;
            &lt;div class=&quot;bg-white p-6 rounded-lg shadow-md&quot;&gt;
                &lt;div class=&quot;flex justify-between items-center mb-4&quot;&gt;
                    &lt;h2 class=&quot;text-2xl font-semibold text-gray-700&quot;&gt;Gestão de Produtos e Receitas&lt;/h2&gt;
                    &lt;button id=&quot;btn-novo-produto&quot; onclick=&quot;abrirModalProduto()&quot; class=&quot;bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors&quot; disabled&gt;
                        &lt;i class=&quot;fas fa-plus mr-2&quot;&gt;&lt;/i&gt; Novo Produto
                    &lt;/button&gt;
                &lt;/div&gt;
                &lt;div id=&quot;lista-produtos&quot; class=&quot;overflow-x-auto&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- ABA: Insumos --&gt;
        &lt;div id=&quot;insumos-tab&quot; class=&quot;hidden&quot;&gt;
            &lt;div class=&quot;bg-white p-6 rounded-lg shadow-md&quot;&gt;
                &lt;div class=&quot;flex justify-between items-center mb-4&quot;&gt;
                    &lt;h2 class=&quot;text-2xl font-semibold text-gray-700&quot;&gt;Gestão de Insumos&lt;/h2&gt;
                    &lt;button id=&quot;btn-novo-insumo&quot; onclick=&quot;abrirModalInsumo()&quot; class=&quot;bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors&quot; disabled&gt;
                        &lt;i class=&quot;fas fa-plus mr-2&quot;&gt;&lt;/i&gt; Novo Insumo
                    &lt;/button&gt;
                &lt;/div&gt;
                &lt;div id=&quot;lista-insumos&quot; class=&quot;overflow-x-auto&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- ABA: Análise Estratégica --&gt;
        &lt;div id=&quot;analise-tab&quot; class=&quot;hidden space-y-8&quot;&gt;
            &lt;div class=&quot;bg-white p-6 rounded-lg shadow-md&quot;&gt;
                &lt;div class=&quot;flex justify-between items-center&quot;&gt;
                     &lt;h2 class=&quot;text-2xl font-semibold text-gray-700&quot;&gt;Engenharia de Cardápio&lt;/h2&gt;
                     &lt;button onclick=&quot;analisarVendas()&quot; id=&quot;btn-analisar-cardapio&quot; class=&quot;bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors h-10&quot; disabled&gt;
                        &lt;i class=&quot;fas fa-chart-pie mr-2&quot;&gt;&lt;/i&gt; Analisar Cardápio (com dados de simulação)
                    &lt;/button&gt;
                &lt;/div&gt;
                 &lt;p class=&quot;text-sm text-gray-500 mt-2&quot;&gt;Esta análise utiliza dados de venda simulados para fins de demonstração. Em uma versão completa, estes dados seriam coletados a partir dos seus registros.&lt;/p&gt;
            &lt;/div&gt;
            &lt;div id=&quot;resultado-analise-cardapio&quot; class=&quot;hidden bg-white p-6 rounded-lg shadow-md&quot;&gt;
                 &lt;h2 class=&quot;text-2xl font-semibold mb-4 text-gray-700&quot;&gt;Matriz de Análise e Recomendações&lt;/h2&gt;
                 &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-2 gap-8&quot;&gt;
                    &lt;div&gt;
                        &lt;h3 class=&quot;text-xl font-semibold mb-2 text-gray-700&quot;&gt;Matriz de Popularidade vs. Lucratividade&lt;/h3&gt;
                        &lt;div class=&quot;relative aspect-square&quot;&gt;
                            &lt;canvas id=&quot;matriz-engenharia-chart&quot;&gt;&lt;/canvas&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div id=&quot;container-analise-detalhada&quot; class=&quot;space-y-4&quot;&gt;
                         &lt;h3 class=&quot;text-xl font-semibold mb-2 text-gray-700&quot;&gt;Classificação e Ações Sugeridas&lt;/h3&gt;
                         &lt;!-- As categorias serão inseridas aqui --&gt;
                    &lt;/div&gt;
                 &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- ABA: Configurações --&gt;
        &lt;div id=&quot;configuracoes-tab&quot; class=&quot;hidden grid grid-cols-1 lg:grid-cols-2 gap-8&quot;&gt;
            &lt;!-- Custos e Faturamento --&gt;
            &lt;div class=&quot;bg-white p-6 rounded-lg shadow-md space-y-6&quot;&gt;
                &lt;div&gt;
                    &lt;h2 class=&quot;text-2xl font-semibold mb-4 text-gray-700&quot;&gt;Custos e Faturamento&lt;/h2&gt;
                    &lt;label for=&quot;faturamento-mensal&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Faturamento Médio Mensal (R$)&lt;/label&gt;
                    &lt;input type=&quot;number&quot; id=&quot;faturamento-mensal&quot; placeholder=&quot;Ex: 40000&quot; class=&quot;w-full p-2 border border-gray-300 rounded-md&quot;&gt;
                &lt;/div&gt;
                &lt;div&gt;
                    &lt;h3 class=&quot;text-xl font-semibold text-gray-700&quot;&gt;Custos com Pessoal (Mão de Obra)&lt;/h3&gt;
                    &lt;div id=&quot;lista-custos-pessoal&quot; class=&quot;mt-2&quot;&gt;&lt;/div&gt;
                    &lt;button onclick=&quot;adicionarCusto('pessoal')&quot; class=&quot;mt-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm&quot;&gt;+ Adicionar Custo Pessoal&lt;/button&gt;
                &lt;/div&gt;
                &lt;div&gt;
                    &lt;h3 class=&quot;text-xl font-semibold text-gray-700&quot;&gt;Outros Custos Operacionais&lt;/h3&gt;
                    &lt;div id=&quot;lista-custos-operacionais&quot; class=&quot;mt-2&quot;&gt;&lt;/div&gt;
                    &lt;button onclick=&quot;adicionarCusto('operacional')&quot; class=&quot;mt-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm&quot;&gt;+ Adicionar Custo Operacional&lt;/button&gt;
                &lt;/div&gt;
                &lt;div class=&quot;text-right border-t pt-4 mt-4&quot;&gt;
                    &lt;p class=&quot;font-semibold&quot;&gt;Custo Operacional Total: &lt;span id=&quot;total-custo-operacional&quot; class=&quot;text-red-600&quot;&gt;R$ 0,00&lt;/span&gt;&lt;/p&gt;
                    &lt;p class=&quot;font-semibold&quot;&gt;% Custo Operacional: &lt;span id=&quot;percentual-custo-operacional&quot; class=&quot;text-indigo-600&quot;&gt;0.00%&lt;/span&gt;&lt;/p&gt;
                    &lt;p class=&quot;font-bold mt-2&quot;&gt;% Custo Primário (Prime Cost): &lt;span id=&quot;percentual-custo-primario&quot; class=&quot;text-green-600&quot;&gt;0.00%&lt;/span&gt;
                        &lt;span class=&quot;tooltip&quot;&gt;
                            &lt;i class=&quot;fas fa-info-circle text-gray-400 ml-1&quot;&gt;&lt;/i&gt;
                            &lt;span class=&quot;tooltiptext&quot;&gt;O Custo Primário (CMV Total + Custo com Pessoal) é o indicador mais importante da saúde financeira do seu restaurante. O ideal é mantê-lo abaixo de 60-65%.&lt;/span&gt;
                        &lt;/span&gt;
                    &lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;!-- Canais de Venda --&gt;
            &lt;div class=&quot;bg-white p-6 rounded-lg shadow-md&quot;&gt;
                &lt;h2 class=&quot;text-2xl font-semibold mb-4 text-gray-700&quot;&gt;Canais de Venda&lt;/h2&gt;
                &lt;div id=&quot;lista-canais-venda&quot;&gt;&lt;/div&gt;
                &lt;button onclick=&quot;adicionarCanalVenda()&quot; class=&quot;mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600&quot;&gt;
                    &lt;i class=&quot;fas fa-plus mr-2&quot;&gt;&lt;/i&gt; Adicionar Canal
                &lt;/button&gt;
            &lt;/div&gt;
            &lt;div class=&quot;lg:col-span-2 text-center mt-4&quot;&gt;
                &lt;button id=&quot;btn-salvar-config&quot; onclick=&quot;salvarConfiguracoes()&quot; class=&quot;bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg&quot; disabled&gt;
                    &lt;i class=&quot;fas fa-save mr-2&quot;&gt;&lt;/i&gt; Salvar Todas as Configurações
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/main&gt;
&lt;/div&gt;

&lt;!-- Modal Genérico --&gt;
&lt;div id=&quot;modal-backdrop&quot; class=&quot;modal-backdrop hidden&quot;&gt;
    &lt;div id=&quot;modal-content&quot; class=&quot;modal-content&quot;&gt;
        &lt;!-- Conteúdo do modal será injetado aqui --&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- Firebase --&gt;
&lt;script type=&quot;module&quot;&gt;
    // Importações do Firebase
    import { initializeApp } from &quot;[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js&quot](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js&quot);;
    import { getAuth, signInAnonymously, onAuthStateChanged } from &quot;[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js&quot](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js&quot);;
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, query } from &quot;[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js&quot](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js&quot);;

    // &lt;!-- PASSO IMPORTANTE: COLE A SUA CONFIGURAÇÃO DO FIREBASE AQUI --&gt;
    // Substitua todo o bloco &quot;const firebaseConfig = { ... };&quot; abaixo
    // pelo bloco de código que você copiou da sua consola do Firebase.
    const firebaseConfig = {
        apiKey: &quot;SUA_API_KEY&quot;, // &lt;-- SUBSTITUA PELA SUA CHAVE DE API
        authDomain: &quot;SEU_AUTH_DOMAIN&quot;,
        projectId: &quot;SEU_PROJECT_ID&quot;,
        storageBucket: &quot;SEU_STORAGE_BUCKET&quot;,
        messagingSenderId: &quot;SEU_MESSAGING_SENDER_ID&quot;,
        appId: &quot;SEU_APP_ID&quot;
    };
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'precificador-show-de-delicias';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let insumosCache = [];
    let produtosCache = [];
    let configCache = {};
    
    function getCollectionRef(collectionName) {
        if (!window.appState.userId) return null;
        return collection(db, `artifacts/${appId}/users/${window.appState.userId}/${collectionName}`);
    }

    function getConfigDocRef() {
        if (!window.appState.userId) return null;
        return doc(db, `artifacts/${appId}/users/${window.appState.userId}/configuracoes/main`);
    }

    window.appState = {
        db,
        auth,
        userId: null,
        isReady: false,
        apiKey: firebaseConfig.apiKey,
        getCollectionRef,
        getConfigDocRef,
        insumosCache: () => insumosCache,
        produtosCache: () => produtosCache,
        configCache: () => configCache,
        // Funções do Firestore
        doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, query
    };

    async function seedInitialData(userId) {
        const configRef = doc(db, `artifacts/${appId}/users/${userId}/configuracoes/main`);
        const configSnap = await getDoc(configRef);

        if (!configSnap.exists()) {
            console.log(&quot;Nenhuma configuração encontrada. Criando dados iniciais de exemplo...&quot;);
            const batch = writeBatch(db);

            // Configuração Padrão
            const initialConfig = {
                faturamentoMedioMensal: 15000,
                custosPessoal: [ { nome: &quot;Salários e Encargos&quot;, valor: 4500 } ],
                custosOperacionais: [ { nome: &quot;Aluguel&quot;, valor: 2000 }, { nome: &quot;Contas (água, luz, net)&quot;, valor: 800 } ],
                canaisVenda: [
                    { nome: &quot;Balcão&quot;, taxaComissao: 0, taxaTransacao: 0.025 },
                    { nome: &quot;iFood Entrega&quot;, taxaComissao: 0.23, taxaTransacao: 0.035 }
                ]
            };
            batch.set(configRef, initialConfig);

            // Insumos de Exemplo
            const insumosRef = collection(db, `artifacts/${appId}/users/${userId}/insumos`);
            const initialInsumos = [
                { nome: &quot;Farinha de Trigo&quot;, precoCompra: 5, qtdCompra: 1, unidadeCompra: 'kg', percentualDesperdicio: 0.01 },
                { nome: &quot;Ovo&quot;, precoCompra: 12, qtdCompra: 12, unidadeCompra: 'un', percentualDesperdicio: 0 },
                { nome: &quot;Leite Condensado&quot;, precoCompra: 7, qtdCompra: 395, unidadeCompra: 'g', percentualDesperdicio: 0.05 },
                { nome: &quot;Chocolate em Pó 50%&quot;, precoCompra: 20, qtdCompra: 1, unidadeCompra: 'kg', percentualDesperdicio: 0.02 }
            ];
            initialInsumos.forEach(insumo =&gt; batch.set(doc(insumosRef), insumo));
            
            // Produtos de Exemplo
             const produtosRef = collection(db, `artifacts/${appId}/users/${userId}/produtos`);
             const initialProdutos = [
                { nome: &quot;Bolo de Chocolate (Fatia)&quot;, descricao: &quot;Uma fatia generosa do nosso bolo de chocolate molhadinho com cobertura cremosa.&quot;, receita: [] },
                { nome: &quot;Brigadeiro Gourmet&quot;, descricao: &quot;O clássico brigadeiro com um toque especial e chocolate de alta qualidade.&quot;, receita: [] }
             ];
             initialProdutos.forEach(p => batch.set(doc(produtosRef), p));

            await batch.commit();
            console.log(&quot;Dados de exemplo criados com sucesso.&quot;);
        }
    }


    function initializeAppState(user) {
        if (!window.appState.isReady || !user) return;
        
        seedInitialData(user.uid).then(() =&gt; {
            const insumosRef = getCollectionRef('insumos');
            if (insumosRef) onSnapshot(insumosRef, snapshot =&gt; {
                insumosCache = snapshot.docs.map(doc =&gt; ({ id: doc.id, ...doc.data() }));
                renderInsumos();
                updateProdutoSelect(); 
            });

            const produtosRef = getCollectionRef('produtos');
            if (produtosRef) onSnapshot(produtosRef, snapshot =&gt; {
                produtosCache = snapshot.docs.map(doc =&gt; ({ id: doc.id, ...doc.data() }));
                renderProdutos();
                updateProdutoSelect();
                // Habilita botão de análise se houver produtos
                document.getElementById('btn-analisar-cardapio').disabled = produtosCache.length === 0;
            });

            const configRef = getConfigDocRef();
            if(configRef) onSnapshot(configRef, (doc) =&gt; {
                if (doc.exists()) {
                    configCache = doc.data();
                    renderConfiguracoes();
                }
            });
        });
    }
    
    // --- AUTENTICAÇÃO E INICIALIZAÇÃO ---
    onAuthStateChanged(auth, user =&gt; {
        if (user) {
            if (window.appState.isReady) return;

            window.appState.userId = user.uid;
            window.appState.isReady = true;

            const statusDot = document.getElementById('db-status-dot');
            const statusText = document.getElementById('db-status-text');
            statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
            statusDot.classList.add('bg-green-500');
            statusText.textContent = 'Ligado e pronto a usar';

            document.getElementById('btn-novo-insumo').disabled = false;
            document.getElementById('btn-novo-produto').disabled = false;
            document.getElementById('btn-salvar-config').disabled = false;
            
            initializeAppState(user);

        } else {
            signInAnonymously(auth).catch(error =&gt; {
                console.error(&quot;Erro na autenticação anônima:&quot;, error);
                const statusDot = document.getElementById('db-status-dot');
                const statusText = document.getElementById('db-status-text');
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Erro na ligação. Verifique a configuração do Firebase.';
            });
        }
    });

&lt;/script&gt;

&lt;script&gt;
    // --- LÓGICA DA API GEMINI ---
    async function callGeminiAPI(prompt) {
        const apiKey = window.appState.apiKey; 
        if (!apiKey || apiKey === &quot;SUA_API_KEY&quot;) {
             throw new Error(&quot;A chave de API (apiKey) do Firebase não foi configurada. Por favor, substitua a chave de exemplo pela sua na seção &lt;script type='module'&gt; do código.&quot;);
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{ role: &quot;user&quot;, parts: [{ text: prompt }] }]
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() =&gt; ({ error: { message: response.statusText } }));
                console.error(&quot;Erro na API Gemini:&quot;, response.status, errorBody);
                const errorMessage = errorBody.error?.message || `A API retornou um erro ${response.status}.`;
                throw new Error(errorMessage);
            }

            const result = await response.json();
            
            if (result.candidates &amp;&amp; result.candidates.length &gt; 0 &amp;&amp;
                result.candidates[0].content &amp;&amp; result.candidates[0].content.parts &amp;&amp;
                result.candidates[0].content.parts.length &gt; 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error(&quot;Resposta inesperada da API Gemini:&quot;, result);
                if (result.candidates &amp;&amp; result.candidates.length &gt; 0 &amp;&amp; result.candidates[0].finishReason === 'SAFETY') {
                    throw new Error(&quot;A resposta foi bloqueada por motivos de segurança. Tente reformular o pedido.&quot;);
                }
                throw new Error(&quot;A IA retornou uma resposta vazia ou em formato inesperado.&quot;);
            }
        } catch (error) {
            console.error(&quot;Falha ao chamar a API Gemini:&quot;, error);
            throw error;
        }
    }

    // --- LÓGICA DA INTERFACE (UI) ---

    function changeTab(tabName) {
        document.getElementById('simulador-tab').classList.add('hidden');
        document.getElementById('produtos-tab').classList.add('hidden');
        document.getElementById('insumos-tab').classList.add('hidden');
        document.getElementById('analise-tab').classList.add('hidden');
        document.getElementById('configuracoes-tab').classList.add('hidden');

        document.querySelectorAll('.tab-button').forEach(button =&gt; {
            button.classList.remove('active');
        });

        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        document.querySelector(`button[onclick=&quot;changeTab('${tabName}')&quot;]`).classList.add('active');
    }
    
    function updateProdutoSelect() {
        const produtos = window.appState.produtosCache();
        const select = document.getElementById('produto-select');
        const currentVal = select.value;
        select.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Selecione um produto --&lt;/option&gt;';
        produtos.sort((a, b) =&gt; a.nome.localeCompare(b.nome)).forEach(produto =&gt; {
            const option = document.createElement('option');
            option.value = produto.id;
            option.textContent = produto.nome;
            select.appendChild(option);
        });
        select.value = currentVal;
    }

    // --- RENDERIZAÇÃO ---
    
    function renderInsumos() {
        const insumos = window.appState.insumosCache();
        const container = document.getElementById('lista-insumos');
        if (!insumos.length) {
            container.innerHTML = `&lt;p class=&quot;text-center text-gray-500 py-4&quot;&gt;Nenhum insumo cadastrado. Clique em &quot;Novo Insumo&quot; para começar.&lt;/p&gt;`;
            return;
        }
        
        const table = document.createElement('table');
        table.className = 'min-w-full bg-white';
        table.innerHTML = `
            &lt;thead class=&quot;bg-gray-50&quot;&gt;
                &lt;tr&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Nome&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Custo Real (Pós-Desperdício)&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Ações&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody class=&quot;divide-y divide-gray-200&quot;&gt;&lt;/tbody&gt;
        `;
        const tbody = table.querySelector('tbody');
        insumos.sort((a, b) =&gt; a.nome.localeCompare(b.nome)).forEach(insumo =&gt; {
            const rendimento = 1 - (parseFloat(insumo.percentualDesperdicio) || 0);
            const custoReal = rendimento &gt; 0 ? parseFloat(insumo.precoCompra) / rendimento : 0;
            const unidadeCompra = insumo.unidadeCompra || 'un';
            const custoPorUnidade = custoReal / parseFloat(insumo.qtdCompra);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap&quot;&gt;
                    &lt;div class=&quot;font-medium text-gray-900&quot;&gt;${insumo.nome}&lt;/div&gt;
                    &lt;div class=&quot;text-sm text-gray-500&quot;&gt;Comprado a R$ ${parseFloat(insumo.precoCompra).toFixed(2)} / ${insumo.qtdCompra} ${unidadeCompra}&lt;/div&gt;
                &lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap&quot;&gt;
                    &lt;div class=&quot;font-medium text-green-600&quot;&gt;R$ ${custoPorUnidade.toFixed(4)} / ${unidadeCompra.replace('kg','g').replace('L','ml').replace('un','un')}&lt;/div&gt;
                    &lt;div class=&quot;text-sm text-gray-500&quot;&gt;${(parseFloat(insumo.percentualDesperdicio) * 100).toFixed(0)}% de desperdício&lt;/div&gt;
                &lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                    &lt;button onclick=&quot;abrirModalInsumo('${insumo.id}')&quot; class=&quot;text-indigo-600 hover:text-indigo-900 mr-4&quot;&gt;Editar&lt;/button&gt;
                    &lt;button onclick=&quot;deletarItem('insumos', '${insumo.id}', 'insumo')&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Excluir&lt;/button&gt;
                &lt;/td&gt;
            `;
            tbody.appendChild(tr);
        });
        container.innerHTML = '';
        container.appendChild(table);
    }

    function renderProdutos() {
        const produtos = window.appState.produtosCache();
        const container = document.getElementById('lista-produtos');
         if (!produtos.length) {
            container.innerHTML = `&lt;p class=&quot;text-center text-gray-500 py-4&quot;&gt;Nenhum produto cadastrado. Clique em &quot;Novo Produto&quot; para começar.&lt;/p&gt;`;
            return;
        }

        const table = document.createElement('table');
        table.className = 'min-w-full bg-white';
        table.innerHTML = `
            &lt;thead class=&quot;bg-gray-50&quot;&gt;
                &lt;tr&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Produto&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Custo de Insumos (CMV)&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Ações&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody class=&quot;divide-y divide-gray-200&quot;&gt;&lt;/tbody&gt;
        `;
        const tbody = table.querySelector('tbody');
        produtos.sort((a,b) =&gt; a.nome.localeCompare(b.nome)).forEach(produto =&gt; {
            const custo = calcularCustoProduto(produto.id);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap font-medium text-gray-900&quot;&gt;${produto.nome}&lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap text-gray-700&quot;&gt;R$ ${custo.toFixed(2)}&lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                    &lt;button onclick=&quot;abrirModalProduto('${produto.id}')&quot; class=&quot;text-indigo-600 hover:text-indigo-900 mr-4&quot;&gt;Editar&lt;/button&gt;
                    &lt;button onclick=&quot;deletarItem('produtos', '${produto.id}', 'produto')&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Excluir&lt;/button&gt;
                &lt;/td&gt;
            `;
            tbody.appendChild(tr);
        });
        container.innerHTML = '';
        container.appendChild(table);
    }

    function renderConfiguracoes() {
        const config = window.appState.configCache();
        if (!config) return;

        document.getElementById('faturamento-mensal').value = config.faturamentoMedioMensal || '';

        // Renderiza custos de pessoal
        const custosPessoalContainer = document.getElementById('lista-custos-pessoal');
        custosPessoalContainer.innerHTML = '';
        (config.custosPessoal || []).forEach((custo, index) =&gt; {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 mb-2';
            div.innerHTML = `
                &lt;input type=&quot;text&quot; value=&quot;${custo.nome}&quot; onchange=&quot;updateCustoTemp(${index}, 'nome', this.value, 'pessoal')&quot; class=&quot;w-2/3 p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Nome do Custo&quot;&gt;
                &lt;input type=&quot;number&quot; value=&quot;${custo.valor}&quot; onchange=&quot;updateCustoTemp(${index}, 'valor', this.value, 'pessoal')&quot; class=&quot;w-1/3 p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Valor&quot;&gt;
                &lt;button onclick=&quot;removerCusto(${index}, 'pessoal')&quot; class=&quot;text-red-500 hover:text-red-700 p-2&quot;&gt;&lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt;&lt;/button&gt;
            `;
            custosPessoalContainer.appendChild(div);
        });

        // Renderiza outros custos operacionais
        const custosOpContainer = document.getElementById('lista-custos-operacionais');
        custosOpContainer.innerHTML = '';
        (config.custosOperacionais || []).forEach((custo, index) =&gt; {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 mb-2';
            div.innerHTML = `
                &lt;input type=&quot;text&quot; value=&quot;${custo.nome}&quot; onchange=&quot;updateCustoTemp(${index}, 'nome', this.value, 'operacional')&quot; class=&quot;w-2/3 p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Nome do Custo&quot;&gt;
                &lt;input type=&quot;number&quot; value=&quot;${custo.valor}&quot; onchange=&quot;updateCustoTemp(${index}, 'valor', this.value, 'operacional')&quot; class=&quot;w-1/3 p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Valor&quot;&gt;
                &lt;button onclick=&quot;removerCusto(${index}, 'operacional')&quot; class=&quot;text-red-500 hover:text-red-700 p-2&quot;&gt;&lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt;&lt;/button&gt;
            `;
            custosOpContainer.appendChild(div);
        });

        const canaisContainer = document.getElementById('lista-canais-venda');
        canaisContainer.innerHTML = '';
        (config.canaisVenda || []).forEach((canal, index) =&gt; {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-4 items-center gap-2 mb-2';
            div.innerHTML = `
                &lt;input type=&quot;text&quot; value=&quot;${canal.nome}&quot; onchange=&quot;updateCanalTemp(${index}, 'nome', this.value)&quot; class=&quot;col-span-2 p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Nome do Canal&quot;&gt;
                &lt;input type=&quot;number&quot; value=&quot;${(canal.taxaComissao * 100).toFixed(2)}&quot; onchange=&quot;updateCanalTemp(${index}, 'taxaComissao', this.value / 100)&quot; class=&quot;p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Comissão %&quot;&gt;
                &lt;input type=&quot;number&quot; value=&quot;${(canal.taxaTransacao * 100).toFixed(2)}&quot; onchange=&quot;updateCanalTemp(${index}, 'taxaTransacao', this.value / 100)&quot; class=&quot;p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Transação %&quot;&gt;
                &lt;button onclick=&quot;removerCanalVenda(${index})&quot; class=&quot;text-red-500 hover:text-red-700 p-2&quot;&gt;&lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt;&lt;/button&gt;
            `;
            canaisContainer.appendChild(div);
        });

        calcularTotaisConfig();
    }

    // --- LÓGICA DE CÁLCULO ---
    
    function calcularCustoInsumo(insumoId, quantidade, unidade) {
        const insumos = window.appState.insumosCache();
        const insumo = insumos.find(i =&gt; i.id === insumoId);
        if (!insumo) return 0;

        const precoCompra = parseFloat(insumo.precoCompra);
        const qtdCompra = parseFloat(insumo.qtdCompra);
        const unidadeCompra = insumo.unidadeCompra;
        const desperdicio = parseFloat(insumo.percentualDesperdicio);
        
        if (qtdCompra === 0) return 0;

        const rendimento = 1 - desperdicio;
        const custoRealTotal = rendimento &gt; 0 ? precoCompra / rendimento : precoCompra;
        
        let custoPorUnidadeBase = custoRealTotal / qtdCompra;

        let quantidadeConvertida = parseFloat(quantidade);
        if (unidadeCompra === 'kg' &amp;&amp; unidade === 'g') {
            quantidadeConvertida = quantidade / 1000;
        } else if (unidadeCompra === 'L' &amp;&amp; unidade === 'ml') {
            quantidadeConvertida = quantidade / 1000;
        } else if (unidadeCompra === 'g' &amp;&amp; unidade === 'kg') {
            quantidadeConvertida = quantidade * 1000;
        } else if (unidadeCompra === 'ml' &amp;&amp; unidade === 'L') {
             quantidadeConvertida = quantidade * 1000;
        }

        return custoPorUnidadeBase * quantidadeConvertida;
    }

    function calcularCustoProduto(produtoId) {
        const produtos = window.appState.produtosCache();
        const produto = produtos.find(p =&gt; p.id === produtoId);
        if (!produto || !produto.receita) return 0;

        return produto.receita.reduce((total, item) =&gt; {
            return total + calcularCustoInsumo(item.insumoId, item.quantidade, item.unidade);
        }, 0);
    }

    function calcularTotaisConfig() {
        const config = window.appState.configCache();
        const totalCustosPessoal = (config.custosPessoal || []).reduce((sum, custo) =&gt; sum + (parseFloat(custo.valor) || 0), 0);
        const totalCustosOp = (config.custosOperacionais || []).reduce((sum, custo) =&gt; sum + (parseFloat(custo.valor) || 0), 0);
        const totalCustosGerais = totalCustosPessoal + totalCustosOp;
        const faturamento = parseFloat(document.getElementById('faturamento-mensal').value) || parseFloat(config.faturamentoMedioMensal) || 0;
        
        const percentualOp = faturamento &gt; 0 ? (totalCustosGerais / faturamento) : 0;

        document.getElementById('total-custo-operacional').textContent = `R$ ${totalCustosGerais.toFixed(2)}`;
        document.getElementById('percentual-custo-operacional').textContent = `${(percentualOp * 100).toFixed(2)}%`;

        // Calcular Custo Primário
        // Custo Primário = (CMV Total + Custo com Pessoal) / Faturamento
        // Para uma estimativa, usamos o CMV médio da indústria (ex: 30%)
        const cmvEstimado = faturamento * 0.30; // Estimativa, idealmente viria de dados de vendas
        const custoPrimario = faturamento > 0 ? (cmvEstimado + totalCustosPessoal) / faturamento : 0;
        document.getElementById('percentual-custo-primario').textContent = `${(custoPrimario * 100).toFixed(2)}%`;
    }
    
    let ultimoCalculo = {};

    window.calcularPrecos = function() {
        const produtoId = document.getElementById('produto-select').value;
        const margemLucro = parseFloat(document.getElementById('margem-lucro-input').value) / 100;
        
        if (!produtoId || isNaN(margemLucro)) {
            alert(&quot;Por favor, selecione um produto e insira uma margem de lucro válida.&quot;);
            return;
        }
        
        const config = window.appState.configCache();
        const produtos = window.appState.produtosCache();
        const produto = produtos.find(p =&gt; p.id === produtoId);

        const custoProduto = calcularCustoProduto(produtoId);
        const totalCustosPessoal = (config.custosPessoal || []).reduce((sum, c) =&gt; sum + parseFloat(c.valor), 0);
        const totalCustosOp = (config.custosOperacionais || []).reduce((sum, c) =&gt; sum + parseFloat(c.valor), 0);
        const totalCustosGerais = totalCustosPessoal + totalCustosOp;
        const faturamento = parseFloat(config.faturamentoMedioMensal) || 0;
        const custoOpPercentual = faturamento &gt; 0 ? totalCustosGerais / faturamento : 0;

        const denominadorBase = 1 - custoOpPercentual - margemLucro;
        if (denominadorBase &lt;= 0) {
            alert(`Erro: A soma do Custo Operacional (${(custoOpPercentual * 100).toFixed(2)}%) e da Margem de Lucro (${(margemLucro * 100).toFixed(2)}%) não pode ser maior ou igual a 100%.`);
            return;
        }
        
        const precoVendaBase = custoProduto / denominadorBase;
        
        const resumoContainer = document.getElementById('resumo-produto');
        resumoContainer.innerHTML = `
            &lt;h3 class=&quot;text-xl font-bold mb-2 text-indigo-800&quot;&gt;${produto.nome}&lt;/h3&gt;
            &lt;div class=&quot;grid grid-cols-2 md:grid-cols-4 gap-4 text-center&quot;&gt;
                &lt;div&gt;&lt;p class=&quot;text-sm text-gray-500&quot;&gt;Custo Insumos (CMV)&lt;/p&gt;&lt;p class=&quot;font-bold text-lg text-gray-800&quot;&gt;R$ ${custoProduto.toFixed(2)}&lt;/p&gt;&lt;/div&gt;
                &lt;div&gt;&lt;p class=&quot;text-sm text-gray-500&quot;&gt;Custo Operacional&lt;/p&gt;&lt;p class=&quot;font-bold text-lg text-gray-800&quot;&gt;${(custoOpPercentual * 100).toFixed(2)}%&lt;/p&gt;&lt;/div&gt;
                &lt;div&gt;&lt;p class=&quot;text-sm text-gray-500&quot;&gt;Margem de Lucro&lt;/p&gt;&lt;p class=&quot;font-bold text-lg text-gray-800&quot;&gt;${(margemLucro * 100).toFixed(2)}%&lt;/p&gt;&lt;/div&gt;
                &lt;div&gt;&lt;p class=&quot;text-sm text-gray-500&quot;&gt;Preço Base (Líquido)&lt;/p&gt;&lt;p class=&quot;font-bold text-lg text-green-600&quot;&gt;R$ ${precoVendaBase.toFixed(2)}&lt;/p&gt;&lt;/div&gt;
            &lt;/div&gt;
        `;

        const tabelaContainer = document.getElementById('tabela-precos');
        const table = document.createElement('table');
        table.className = 'min-w-full bg-white';
        table.innerHTML = `
            &lt;thead class=&quot;bg-gray-50&quot;&gt;
                &lt;tr&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Canal de Venda&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Taxas Totais&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Preço de Venda Final&lt;/th&gt;
                    &lt;th class=&quot;py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider&quot;&gt;Análise IA&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody class=&quot;divide-y divide-gray-200&quot;&gt;&lt;/tbody&gt;
        `;
        const tbody = table.querySelector('tbody');
        
        ultimoCalculo = {
            produtoId: produto.id,
            produtoNome: produto.nome,
            custoProduto: custoProduto,
            custoOpPercentual: custoOpPercentual,
            margemLucro: margemLucro,
            canais: {}
        };

        (config.canaisVenda || []).forEach(canal =&gt; {
            const taxasTotais = parseFloat(canal.taxaComissao) + parseFloat(canal.taxaTransacao);
            const denominadorCanal = 1 - taxasTotais;
            const precoFinal = denominadorCanal &gt; 0 ? precoVendaBase / denominadorCanal : Infinity;
            
            ultimoCalculo.canais[canal.nome] = {
                precoFinal: precoFinal,
                taxasPercentual: taxasTotais,
                liquidoOriginal: precoFinal * (1 - taxasTotais)
            };

            const tr = document.createElement('tr');
            tr.innerHTML = `
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap font-medium text-gray-900&quot;&gt;${canal.nome}&lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap text-gray-500&quot;&gt;${(taxasTotais * 100).toFixed(2)}%&lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap font-bold text-xl text-indigo-600&quot;&gt;R$ ${precoFinal.toFixed(2)}&lt;/td&gt;
                &lt;td class=&quot;py-4 px-6 whitespace-nowrap text-center&quot;&gt;
                    &lt;button onclick=&quot;analisarPrecoComIA('${produto.id}', '${canal.nome}', ${precoFinal}, this)&quot; class=&quot;bg-purple-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-purple-600 transition-colors&quot;&gt;
                        ✨ Analisar Preço
                    &lt;/button&gt;
                &lt;/td&gt;
            `;
            tbody.appendChild(tr);
        });
        
        tabelaContainer.innerHTML = '';
        tabelaContainer.appendChild(table);
        document.getElementById('resultado-precificacao').classList.remove('hidden');
        document.getElementById('analise-ia-container').classList.add('hidden');
        document.getElementById('resultado-promocao').classList.add('hidden');
        document.getElementById('resultado-frete').classList.add('hidden');
    }

    // --- FUNÇÕES COM IA (MELHORADAS) ---
    
    window.analisarPrecoComIA = async function(produtoId, nomeCanal, precoFinal, button) {
        const produtos = window.appState.produtosCache();
        const insumos = window.appState.insumosCache();
        const produto = produtos.find(p =&gt; p.id === produtoId);
        const config = window.appState.configCache();

        const custoProduto = calcularCustoProduto(produtoId);
        const nomesIngredientes = (produto.receita || [])
            .map(item =&gt; insumos.find(i =&gt; i.id === item.insumoId)?.nome)
            .filter(Boolean)
            .join(', ');

        // PROMPT ESTRATÉGICO E CONTEXTUALIZADO
        const prompt = `
            Você é um consultor especialista em estratégia de cardápio para restaurantes no Brasil, com foco em Manaus, Amazonas. Analise o cenário a seguir e forneça recomendações acionáveis.

            **Dados do Produto:**
            - **Nome do Produto:** &quot;${produto.nome}&quot;
            - **Ingredientes Principais:** ${nomesIngredientes || 'Não especificados'}
            - **Descrição Atual:** ${produto.descricao || 'Não fornecida'}

            **Dados Financeiros:**
            - **Custo dos Insumos (CMV):** R$ ${custoProduto.toFixed(2)}
            - **Custo Operacional do Restaurante:** ${(ultimoCalculo.custoOpPercentual * 100).toFixed(2)}% da receita
            - **Margem de Lucro Líquida Alvo:** ${(ultimoCalculo.margemLucro * 100).toFixed(2)}%
            - **Preço de Venda Calculado no Canal '${nomeCanal}':** R$ ${precoFinal.toFixed(2)}

            **Sua Tarefa (responda em 3 seções claras usando markdown):**

            **1. Análise de Posicionamento e Preço:**
               - Com base nos ingredientes e no preço, este item se posiciona como um produto de valor, padrão ou premium para o mercado de delivery em Manaus?
               - O preço de R$ ${precoFinal.toFixed(2)} é competitivo e justificado para este posicionamento? Ofereça uma faixa de preço ideal se achar necessário.

            **2. Otimização da Descrição no Cardápio:**
               - Crie uma nova descrição de marketing curta (máximo 3 frases), apetitosa e vendedora para este prato. A descrição deve justificar o preço e ser ideal para um cardápio de delivery como o iFood.

            **3. Sugestão de Upsell Estratégico:**
               - Sugira UM acompanhamento ou bebida de ALTA MARGEM de lucro para ser vendido em combo com este prato. Justifique por que a combinação é boa tanto em termos de sabor quanto de lucratividade.
        `;

        button.disabled = true;
        button.innerHTML = `&lt;span class=&quot;spinner&quot;&gt;&lt;/span&gt;`;
        
        const analiseContainer = document.getElementById('analise-ia-container');
        const analiseContent = document.getElementById('analise-ia-content');
        
        analiseContent.innerHTML = `&lt;div class=&quot;flex items-center justify-center p-4&quot;&gt;&lt;span class=&quot;spinner&quot;&gt;&lt;/span&gt;Analisando...&lt;/div&gt;`;
        analiseContainer.classList.remove('hidden');

        try {
            const analise = await callGeminiAPI(prompt);
            analiseContent.innerHTML = analise;
        } catch (error) {
            analiseContent.innerHTML = `&lt;p class=&quot;text-red-600 font-semibold&quot;&gt;Ocorreu um erro:&lt;/p&gt;&lt;p class=&quot;text-sm text-gray-700&quot;&gt;${error.message}&lt;/p&gt;`;
        } finally {
            button.disabled = false;
            button.innerHTML = `✨ Analisar Preço`;
        }
    }

    // --- LÓGICA DOS MODAIS E FORMULÁRIOS ---
    
    function fecharModal() {
        document.getElementById('modal-backdrop').classList.add('hidden');
    }
    
    window.tempReceita = [];

    function renderReceitaItems() {
        const container = document.getElementById('receita-container');
        if (!container) return;
        
        const insumos = window.appState.insumosCache();
        container.innerHTML = '';

        window.tempReceita.forEach((item, index) =&gt; {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'receita-item flex items-center gap-2 mb-2';
            
            const insumosOptions = insumos.sort((a,b) =&gt; a.nome.localeCompare(b.nome))
                                          .map(i =&gt; `&lt;option value=&quot;${i.id}&quot; ${i.id === item.insumoId ? 'selected' : ''}&gt;${i.nome}&lt;/option&gt;`)
                                          .join('');
            
            const unidades = ['g', 'kg', 'ml', 'L', 'un'];
            const unidadesOptions = unidades.map(u =&gt; `&lt;option value=&quot;${u}&quot; ${u === item.unidade ? 'selected' : ''}&gt;${u}&lt;/option&gt;`).join('');

            itemDiv.innerHTML = `
                &lt;select class=&quot;w-1/2 p-2 border border-gray-300 rounded-md&quot; onchange=&quot;updateReceitaItem(${index}, 'insumoId', this.value)&quot;&gt;
                    &lt;option value=&quot;&quot;&gt;Selecione um insumo&lt;/option&gt;
                    ${insumosOptions}
                &lt;/select&gt;
                &lt;input type=&quot;number&quot; step=&quot;0.001&quot; value=&quot;${item.quantidade || ''}&quot; onchange=&quot;updateReceitaItem(${index}, 'quantidade', this.value)&quot; class=&quot;w-1/4 p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Qtd.&quot;&gt;
                &lt;select class=&quot;w-1/4 p-2 border border-gray-300 rounded-md&quot; onchange=&quot;updateReceitaItem(${index}, 'unidade', this.value)&quot;&gt;
                    ${unidadesOptions}
                &lt;/select&gt;
                &lt;button type=&quot;button&quot; onclick=&quot;removerReceitaItem(${index})&quot; class=&quot;text-red-500 hover:text-red-700 p-2&quot;&gt;&lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt;&lt;/button&gt;
            `;
            container.appendChild(itemDiv);
        });
    }

    window.adicionarReceitaItem = function() {
        window.tempReceita.push({ insumoId: '', quantidade: 0, unidade: 'g' });
        renderReceitaItems();
    }

    window.removerReceitaItem = function(index) {
        window.tempReceita.splice(index, 1);
        renderReceitaItems();
    }

    window.updateReceitaItem = function(index, field, value) {
        window.tempReceita[index][field] = value;
    }


    window.abrirModalInsumo = function(id = null) {
        const insumos = window.appState.insumosCache();
        const insumo = id ? insumos.find(i =&gt; i.id === id) : {};
        const modalContent = document.getElementById('modal-content');

        const unidades = ['kg', 'g', 'L', 'ml', 'un'];
        const unidadesOptions = unidades.map(u =&gt; `&lt;option value=&quot;${u}&quot; ${u === (insumo.unidadeCompra || 'kg') ? 'selected' : ''}&gt;${u}&lt;/option&gt;`).join('');

        modalContent.innerHTML = `
            &lt;h2 class=&quot;text-2xl font-bold mb-6&quot;&gt;${id ? 'Editar' : 'Novo'} Insumo&lt;/h2&gt;
            &lt;form id=&quot;form-insumo&quot; onsubmit=&quot;salvarInsumo(event, '${id || ''}')&quot; class=&quot;space-y-4&quot;&gt;
                &lt;div&gt;
                    &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Nome do Insumo&lt;/label&gt;
                    &lt;input type=&quot;text&quot; name=&quot;nome&quot; value=&quot;${insumo.nome || ''}&quot; required class=&quot;block w-full p-2 border border-gray-300 rounded-md&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;grid grid-cols-1 md:grid-cols-3 gap-4&quot;&gt;
                    &lt;div&gt;&lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Preço de Compra (R$)&lt;/label&gt;&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;precoCompra&quot; value=&quot;${insumo.precoCompra || ''}&quot; required class=&quot;mt-1 block w-full p-2 border border-gray-300 rounded-md&quot;&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Qtd. Compra&lt;/label&gt;&lt;input type=&quot;number&quot; step=&quot;0.001&quot; name=&quot;qtdCompra&quot; value=&quot;${insumo.qtdCompra || ''}&quot; required class=&quot;mt-1 block w-full p-2 border border-gray-300 rounded-md&quot;&gt;&lt;/div&gt;
                    &lt;div&gt;
                        &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Unidade de Compra&lt;/label&gt;
                        &lt;select name=&quot;unidadeCompra&quot; required class=&quot;mt-1 block w-full p-2 border border-gray-300 rounded-md&quot;&gt;
                            ${unidadesOptions}
                        &lt;/select&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div&gt;
                    &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Percentual de Desperdício (%) &lt;span class=&quot;tooltip&quot;&gt;&lt;i class=&quot;fas fa-info-circle text-gray-400&quot;&gt;&lt;/i&gt;&lt;span class=&quot;tooltiptext&quot;&gt;Ex: Se de 1kg de carne, 300g são aparas, o desperdício é 30%. Insira 30.&lt;/span&gt;&lt;/span&gt;&lt;/label&gt;
                    &lt;input type=&quot;number&quot; name=&quot;percentualDesperdicio&quot; value=&quot;${(insumo.percentualDesperdicio || 0) * 100}&quot; required class=&quot;mt-1 block w-full p-2 border border-gray-300 rounded-md&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;flex justify-end gap-4 pt-4&quot;&gt;&lt;button type=&quot;button&quot; onclick=&quot;fecharModal()&quot; class=&quot;bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300&quot;&gt;Cancelar&lt;/button&gt;&lt;button type=&quot;submit&quot; class=&quot;bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700&quot;&gt;Salvar&lt;/button&gt;&lt;/div&gt;
            &lt;/form&gt;
        `;
        document.getElementById('modal-backdrop').classList.remove('hidden');
    }

    window.abrirModalProduto = function(id = null) {
        const produtos = window.appState.produtosCache();
        const produto = id ? produtos.find(p =&gt; p.id === id) : { receita: [], descricao: '' };
        
        window.tempReceita = JSON.parse(JSON.stringify(produto.receita || []));

        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = `
            &lt;h2 class=&quot;text-2xl font-bold mb-6&quot;&gt;${id ? 'Editar' : 'Novo'} Produto&lt;/h2&gt;
            &lt;form id=&quot;form-produto&quot; onsubmit=&quot;salvarProduto(event, '${id || ''}')&quot; class=&quot;space-y-4&quot;&gt;
                &lt;div&gt;
                    &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Nome do Produto&lt;/label&gt;
                    &lt;input type=&quot;text&quot; name=&quot;nome&quot; value=&quot;${produto.nome || ''}&quot; required class=&quot;mt-1 block w-full p-2 border border-gray-300 rounded-md&quot;&gt;
                &lt;/div&gt;
                
                &lt;div&gt;
                    &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Descrição para Cardápio&lt;/label&gt;
                    &lt;textarea name=&quot;descricao&quot; rows=&quot;3&quot; class=&quot;mt-1 block w-full p-2 border border-gray-300 rounded-md&quot; placeholder=&quot;Ex: Suculento filé de pirarucu na brasa...&quot;&gt;${produto.descricao || ''}&lt;/textarea&gt;
                &lt;/div&gt;

                &lt;div&gt;
                    &lt;h3 class=&quot;text-lg font-semibold mb-2&quot;&gt;Receita (Ficha Técnica)&lt;/h3&gt;
                    &lt;div id=&quot;receita-container&quot;&gt;&lt;/div&gt;
                    &lt;button type=&quot;button&quot; onclick=&quot;adicionarReceitaItem()&quot; class=&quot;mt-2 text-sm text-indigo-600 hover:text-indigo-800&quot;&gt;+ Adicionar ingrediente&lt;/button&gt;
                &lt;/div&gt;
                &lt;div class=&quot;flex justify-end gap-4 pt-4&quot;&gt;
                    &lt;button type=&quot;button&quot; onclick=&quot;fecharModal()&quot; class=&quot;bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300&quot;&gt;Cancelar&lt;/button&gt;&lt;button type=&quot;submit&quot; class=&quot;bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700&quot;&gt;Salvar&lt;/button&gt;
                &lt;/div&gt;
            &lt;/form&gt;
        `;
        
        renderReceitaItems();
        document.getElementById('modal-backdrop').classList.remove('hidden');
    }

    // --- MANIPULAÇÃO DE DADOS (CREATE, UPDATE, DELETE) ---
    
    window.salvarInsumo = async function(event, id) {
        event.preventDefault();
        if (!window.appState.isReady) return;
        const form = document.getElementById('form-insumo');
        const data = {
            nome: form.nome.value,
            precoCompra: parseFloat(form.precoCompra.value),
            qtdCompra: parseFloat(form.qtdCompra.value),
            unidadeCompra: form.unidadeCompra.value,
            percentualDesperdicio: parseFloat(form.percentualDesperdicio.value) / 100
        };

        try {
            const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
            const collectionRef = getCollectionRef('insumos');
            if (id) {
                await updateDoc(doc(collectionRef, id), data);
            } else {
                await addDoc(collectionRef, data);
            }
            fecharModal();
        } catch (e) {
            console.error(&quot;Erro ao salvar insumo: &quot;, e);
            alert(&quot;Ocorreu um erro ao salvar o insumo.&quot;);
        }
    }

    window.salvarProduto = async function(event, id) {
        event.preventDefault();
        if (!window.appState.isReady) return;
        const form = document.getElementById('form-produto');
        const data = {
            nome: form.nome.value,
            descricao: form.descricao.value,
            receita: window.tempReceita.map(item =&gt; ({
                insumoId: item.insumoId,
                quantidade: parseFloat(item.quantidade) || 0,
                unidade: item.unidade
            })).filter(item =&gt; item.insumoId &amp;&amp; item.quantidade &gt; 0)
        };

        try {
            const { getCollectionRef, addDoc, updateDoc, doc } = window.appState;
            const collectionRef = getCollectionRef('produtos');
            if (id) {
                await updateDoc(doc(collectionRef, id), data);
            } else {
                await addDoc(collectionRef, data);
            }
            fecharModal();
        } catch (e) {
            console.error(&quot;Erro ao salvar produto: &quot;, e);
            alert(&quot;Ocorreu um erro ao salvar o produto.&quot;);
        }
    }
    
    window.deletarItem = async function(collectionName, id, itemName) {
        if (!window.appState.isReady) return;
        if (confirm(`Tem certeza que deseja excluir este ${itemName}?`)) {
            try {
                const { getCollectionRef, deleteDoc, doc } = window.appState;
                const collectionRef = getCollectionRef(collectionName);
                await deleteDoc(doc(collectionRef, id));
            } catch (e) {
                console.error(`Erro ao excluir ${itemName}: `, e);
                alert(`Ocorreu um erro ao excluir o ${itemName}.`);
            }
        }
    }
    
    window.updateCustoTemp = function(index, field, value, tipo) {
        const cacheKey = tipo === 'pessoal' ? 'custosPessoal' : 'custosOperacionais';
        window.appState.configCache()[cacheKey][index][field] = field === 'valor' ? parseFloat(value) : value;
        calcularTotaisConfig();
    }
    window.adicionarCusto = function(tipo) {
        const cacheKey = tipo === 'pessoal' ? 'custosPessoal' : 'custosOperacionais';
        if (!window.appState.configCache()[cacheKey]) window.appState.configCache()[cacheKey] = [];
        window.appState.configCache()[cacheKey].push({ nome: '', valor: 0 });
        renderConfiguracoes();
    }
    window.removerCusto = function(index, tipo) {
        const cacheKey = tipo === 'pessoal' ? 'custosPessoal' : 'custosOperacionais';
        window.appState.configCache()[cacheKey].splice(index, 1);
        renderConfiguracoes();
    }
    
    window.updateCanalTemp = function(index, field, value) {
        window.appState.configCache().canaisVenda[index][field] = field === 'nome' ? value : parseFloat(value);
    }
    window.adicionarCanalVenda = function() {
        if (!window.appState.configCache().canaisVenda) window.appState.configCache().canaisVenda = [];
        window.appState.configCache().canaisVenda.push({ nome: '', taxaComissao: 0, taxaTransacao: 0 });
        renderConfiguracoes();
    }
    window.removerCanalVenda = function(index) {
        window.appState.configCache().canaisVenda.splice(index, 1);
        renderConfiguracoes();
    }
    
    window.salvarConfiguracoes = async function() {
        if (!window.appState.isReady) return;
        try {
            const { getConfigDocRef, setDoc } = window.appState;
            const docRef = getConfigDocRef();
            const config = window.appState.configCache();
            config.faturamentoMedioMensal = parseFloat(document.getElementById('faturamento-mensal').value) || 0;
            await setDoc(docRef, config);
            alert(&quot;Configurações salvas com sucesso!&quot;);
        } catch (e) {
            console.error(&quot;Erro ao salvar configurações: &quot;, e);
            alert(&quot;Ocorreu um erro ao salvar as configurações.&quot;);
        }
    }

    window.simularPromocao = function() { /* ...código original... */ };
    window.simularFreteEmbutido = function() { /* ...código original... */ };

    // --- LÓGICA DE ANÁLISE E ENGENHARIA DE CARDÁPIO ---
    let matrizChartInstance = null;

    window.analisarVendas = async function() {
        const button = document.getElementById('btn-analisar-cardapio');
        button.disabled = true;
        button.innerHTML = `&lt;span class=&quot;spinner&quot;&gt;&lt;/span&gt; Analisando...`;
        
        const produtos = window.appState.produtosCache();
        if(produtos.length === 0) {
            alert(&quot;Cadastre produtos para poder analisar o cardápio.&quot;);
             button.disabled = false;
             button.innerHTML = `&lt;i class=&quot;fas fa-chart-pie mr-2&quot;&gt;&lt;/i&gt; Analisar Cardápio (com dados de simulação)`;
            return;
        }

        // Simulação de dados de vendas para demonstração
        const vendasSimuladas = produtos.map(p =&gt; ({
            id: p.id,
            nome: p.nome,
            quantidade: Math.floor(Math.random() * 100) + 10
        }));

        renderizarEngenhariaDeCardapio(vendasSimuladas);
        document.getElementById('resultado-analise-cardapio').classList.remove('hidden');

        button.disabled = false;
        button.innerHTML = `&lt;i class=&quot;fas fa-chart-pie mr-2&quot;&gt;&lt;/i&gt; Analisar Cardápio (com dados de simulação)`;
    }

    function renderizarEngenhariaDeCardapio(vendas) {
        const produtos = window.appState.produtosCache();
        const config = window.appState.configCache();

        const dadosAnalise = produtos.map(p =&gt; {
            const vendaInfo = vendas.find(v =&gt; v.id === p.id);
            const custo = calcularCustoProduto(p.id);
            const precoFinal = (ultimoCalculo.canais?.[&quot;Balcão&quot;]?.precoFinal) || (custo * 2.5);
            const margemContribuicao = precoFinal - custo;
            const popularidade = vendaInfo ? vendaInfo.quantidade : 0;

            return { id: p.id, nome: p.nome, popularidade, margemContribuicao, precoFinal, custo };
        }).filter(p =&gt; p.popularidade &gt; 0);

        if (dadosAnalise.length &lt; 2) {
            alert(&quot;São necessários pelo menos 2 produtos com vendas para criar a matriz.&quot;);
            return;
        }

        const mediaPopularidade = dadosAnalise.reduce((sum, p) =&gt; sum + p.popularidade, 0) / dadosAnalise.length;
        const mediaMargem = dadosAnalise.reduce((sum, p) =&gt; sum + p.margemContribuicao, 0) / dadosAnalise.length;

        const classificacoes = { estrelas: [], burros: [], quebras: [], caes: [] };
        dadosAnalise.forEach(p =&gt; {
            if (p.popularidade &gt;= mediaPopularidade &amp;&amp; p.margemContribuicao &gt;= mediaMargem) classificacoes.estrelas.push(p);
            else if (p.popularidade &gt;= mediaPopularidade &amp;&amp; p.margemContribuicao &lt; mediaMargem) classificacoes.burros.push(p);
            else if (p.popularidade &lt; mediaPopularidade &amp;&amp; p.margemContribuicao &gt;= mediaMargem) classificacoes.quebras.push(p);
            else classificacoes.caes.push(p);
        });

        const ctx = document.getElementById('matriz-engenharia-chart').getContext('2d');
        if (matrizChartInstance) matrizChartInstance.destroy();
        
        matrizChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'Estrelas', data: classificacoes.estrelas.map(p =&gt; ({x: p.popularidade, y: p.margemContribuicao, label: p.nome})), backgroundColor: 'rgba(75, 192, 192, 1)', pointRadius: 8, pointHoverRadius: 10 },
                    { label: 'Burros de Carga', data: classificacoes.burros.map(p =&gt; ({x: p.popularidade, y: p.margemContribuicao, label: p.nome})), backgroundColor: 'rgba(54, 162, 235, 1)', pointRadius: 8, pointHoverRadius: 10 },
                    { label: 'Quebra-cabeças', data: classificacoes.quebras.map(p =&gt; ({x: p.popularidade, y: p.margemContribuicao, label: p.nome})), backgroundColor: 'rgba(255, 206, 86, 1)', pointRadius: 8, pointHoverRadius: 10 },
                    { label: 'Cães', data: classificacoes.caes.map(p =&gt; ({x: p.popularidade, y: p.margemContribuicao, label: p.nome})), backgroundColor: 'rgba(255, 99, 132, 1)', pointRadius: 8, pointHoverRadius: 10 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Popularidade (Unidades Vendidas)' }, beginAtZero: true },
                    y: { title: { display: true, text: 'Margem de Contribuição (R$)' }, beginAtZero: true }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return ` ${context.raw.label}: (Pop: ${context.parsed.x}, Margem: R$ ${context.parsed.y.toFixed(2)})`;
                            }
                        }
                    }
                },
                annotation: { // Para Chart.js v3+, precisa de um plugin separado (chartjs-plugin-annotation)
                    annotations: {
                        lineX: { type: 'line', xMin: mediaPopularidade, xMax: mediaPopularidade, borderColor: 'rgba(0, 0, 0, 0.2)', borderWidth: 2, borderDash: [6, 6], label: { content: 'Média Pop.', enabled: true, position: 'start'} },
                        lineY: { type: 'line', yMin: mediaMargem, yMax: mediaMargem, borderColor: 'rgba(0, 0, 0, 0.2)', borderWidth: 2, borderDash: [6, 6], label: { content: 'Média Lucro', enabled: true, position: 'start' } }
                    }
                }
            }
        });

        const containerDetalhes = document.getElementById('container-analise-detalhada');
        containerDetalhes.innerHTML = `
            &lt;div class=&quot;bg-teal-50 p-3 rounded-lg&quot;&gt;
                &lt;h4 class=&quot;font-bold text-teal-700&quot;&gt;⭐ Estrelas (Alta Lucratividade, Alta Popularidade)&lt;/h4&gt;
                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;&lt;b&gt;Ação:&lt;/b&gt; Mantenha a qualidade, visibilidade e nunca deixe faltar!&lt;/p&gt;
                &lt;ul class=&quot;list-disc pl-5 text-sm&quot;&gt;${classificacoes.estrelas.map(p =&gt; `&lt;li&gt;${p.nome}&lt;/li&gt;`).join('') || '&lt;li&gt;Nenhum&lt;/li&gt;'}&lt;/ul&gt;
            &lt;/div&gt;
            &lt;div class=&quot;bg-yellow-50 p-3 rounded-lg&quot;&gt;
                &lt;h4 class=&quot;font-bold text-yellow-700&quot;&gt;❓ Quebra-cabeças (Alta Lucratividade, Baixa Popularidade)&lt;/h4&gt;
                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;&lt;b&gt;Ação:&lt;/b&gt; Destaque no cardápio, crie promoções, treine a equipe para sugerir.&lt;/p&gt;
                &lt;ul class=&quot;list-disc pl-5 text-sm&quot;&gt;${classificacoes.quebras.map(p =&gt; `&lt;li&gt;${p.nome}&lt;/li&gt;`).join('') || '&lt;li&gt;Nenhum&lt;/li&gt;'}&lt;/ul&gt;
            &lt;/div&gt;
             &lt;div class=&quot;bg-blue-50 p-3 rounded-lg&quot;&gt;
                &lt;h4 class=&quot;font-bold text-blue-700&quot;&gt;🐴 Burros de Carga (Baixa Lucratividade, Alta Popularidade)&lt;/h4&gt;
                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;&lt;b&gt;Ação:&lt;/b&gt; Teste um pequeno aumento de preço ou crie combos com itens de alta margem.&lt;/p&gt;
                &lt;ul class=&quot;list-disc pl-5 text-sm&quot;&gt;${classificacoes.burros.map(p =&gt; `&lt;li&gt;${p.nome}&lt;/li&gt;`).join('') || '&lt;li&gt;Nenhum&lt;/li&gt;'}&lt;/ul&gt;
            &lt;/div&gt;
            &lt;div class=&quot;bg-red-50 p-3 rounded-lg&quot;&gt;
                &lt;h4 class=&quot;font-bold text-red-700&quot;&gt;🐶 Cães (Baixa Lucratividade, Baixa Popularidade)&lt;/h4&gt;
                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;&lt;b&gt;Ação:&lt;/b&gt; Considere remover ou reformular completamente.&lt;/p&gt;
                &lt;ul class=&quot;list-disc pl-5 text-sm&quot;&gt;${classificacoes.caes.map(p =&gt; `&lt;li&gt;${p.nome}&lt;/li&gt;`).join('') || '&lt;li&gt;Nenhum&lt;/li&gt;'}&lt;/ul&gt;
            &lt;/div&gt;
        `;
    }


&lt;/script&gt;
```

\</body\>
\</html\>
